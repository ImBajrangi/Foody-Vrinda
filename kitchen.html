<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Foody Vrinda | Authentic Satvik Cloud Kitchen</title>
    <meta name="description"
        content="Savor the taste of purity with Foody Vrinda. We deliver authentic Satvik meals prepared with devotion and traditional Vedic recipes directly to your doorstep.">
    <meta name="keywords"
        content="Foody Vrinda, Cloud Kitchen, Satvik Food, Vrindavan Delivery, Pure Food, Vedic Diet, Indian Vegetarian, Prasad Delivery">
    <link rel="canonical" href="https://vrindopnishad.in/Projects/Cloud-Kitchen/kitchen.html">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://vrindopnishad.in/Projects/Cloud-Kitchen/kitchen.html">
    <meta property="og:title" content="Foody Vrinda — Taste of Purity & Devotion">
    <meta property="og:description" content="Authentic Satvik meals delivered from our kitchen to your soul.">
    <meta property="og:image" content="https://vrindopnishad.in/Vrindopnishad%20Web/class/logo/foodyVrinda-logo.png">

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://vrindopnishad.in/Projects/Cloud-Kitchen/kitchen.html">
    <meta property="twitter:title" content="Foody Vrinda — Taste of Purity & Devotion">
    <meta property="twitter:description" content="Authentic Satvik meals delivered from our kitchen to your soul.">
    <meta property="twitter:image"
        content="https://vrindopnishad.in/Vrindopnishad%20Web/class/logo/foodyVrinda-logo.png">

    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@graph": [
        {
          "@type": "FoodEstablishment",
          "name": "Foody Vrinda",
          "url": "https://vrindopnishad.in/Projects/Cloud-Kitchen/kitchen.html",
          "logo": "https://vrindopnishad.in/Vrindopnishad%20Web/class/logo/foodyVrinda-logo.png",
          "description": "Authentic Satvik Cloud Kitchen in Vrindavan.",
          "parentOrganization": {
            "@type": "Organization",
            "@id": "https://vrindopnishad.in/#organization"
          }
        },
        {
          "@type": "Organization",
          "@id": "https://vrindopnishad.in/#organization",
          "name": "Vrindopnishad",
          "url": "https://vrindopnishad.in/",
          "logo": "https://vrindopnishad.in/Vrindopnishad%20Web/class/logo/v-logo.png"
        }
      ]
    }
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" crossorigin="anonymous"></script>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <link rel="manifest" href="/site.webmanifest">
    <meta name="theme-color" content="#0071e3">
    <!-- Favicon Configuration - Absolute URLs for Google Search Reliability -->
    <link rel="icon" href="https://vrindopnishad.in/favicon.ico" sizes="48x48">
    <link rel="icon" href="https://vrindopnishad.in/favicon.svg" type="image/svg+xml">
    <link rel="icon" type="image/png" sizes="32x32" href="https://vrindopnishad.in/favicon.ico">
    <link rel="icon" type="image/png" sizes="192x192" href="https://vrindopnishad.in/android-chrome-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="https://vrindopnishad.in/android-chrome-512x512.png">
    <link rel="apple-touch-icon" sizes="180x180" href="https://vrindopnishad.in/apple-touch-icon.png">
    <link rel="manifest" href="https://vrindopnishad.in/site.webmanifest">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Supabase & Shared Auth -->
    <!-- <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../../js/auth.js" defer></script> -->
    <script>
        // Capture the install prompt early, before the main module loads
        window.deferredPrompt = null;
        window.addEventListener('beforeinstallprompt', (e) => {
            // Prevent the mini-infobar from appearing on mobile
            e.preventDefault();
            // Stash the event so it can be triggered later.
            window.deferredPrompt = e;
            console.log("'beforeinstallprompt' fired early and captured.");

            // Dispatch a custom event to notify the main script if it's already listening
            window.dispatchEvent(new CustomEvent('deferred-prompt-ready'));
        });
    </script>
    <style>
        * {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            -webkit-tap-highlight-color: transparent;
        }

        ::selection {
            background: #00172e;
            color: white;
        }

        body {
            font-family: Inter, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f5f5f7;
            min-height: 100vh;
        }

        .view-active {
            display: block !important;
        }

        .view-hidden {
            display: none !important;
        }

        /* --- MODIFICATION: Updated Active Button States --- */
        /* Default active state for standard buttons (Order, Kitchen, Delivery) */
        .btn-active {
            background: #0071e3;
            color: white;
        }

        /* Base styles for special buttons */
        [data-view="owner"] {
            background-color: #6366f1;
            color: white;
        }

        /* Indigo */
        [data-view="developer"] {
            background-color: #e53e3e;
            color: white;
        }

        /* Red */

        /* Active state override for Dashboard */
        [data-view="owner"].btn-active {
            background-color: #4f46e5;
            /* Brighter Indigo */
            color: white;
            box-shadow: 0 0 0 2px #f5f5f7, 0 0 0 4px #4f46e5;
            /* Active ring */
        }

        /* Active state override for Dev Panel */
        [data-view="developer"].btn-active {
            background-color: #dc2626;
            /* Brighter Red */
            color: white;
            box-shadow: 0 0 0 2px #f5f5f7, 0 0 0 4px #dc2626;
            /* Active ring */
        }

        /* --- END OF MODIFICATION --- */

        .card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(0, 0, 0, 0.05);
            overflow: hidden;
        }

        .dev-section {
            padding: 24px;
            border-bottom: 1px solid #edf2f7;
            background: #fff;
        }

        .dev-section:last-child {
            border-bottom: none;
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }

        .section-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: rgba(0, 113, 227, 0.1);
            color: #0071e3;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .section-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: #1a202c;
        }

        .form-label {
            display: block;
            font-size: 0.8rem;
            font-weight: 600;
            color: #718096;
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .input-group {
            margin-bottom: 16px;
        }

        button,
        .card,
        input,
        select,
        .menu-item {
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .btn-primary {
            background: #0071e3;
            color: white;
            font-weight: 600;
            padding: 14px 24px;
            border-radius: 12px;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary:hover:not(:disabled) {
            background: #0063c6;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 113, 227, 0.2);
        }

        .btn-primary:disabled {
            background-color: #a0aec0;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #4a5568;
            font-weight: 500;
            padding: 8px 16px;
            border-radius: 12px;
            border: none;
            cursor: pointer;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #cbd5e0;
        }

        .btn-secondary:disabled {
            background-color: #edf2f7;
            color: #a0aec0;
            cursor: not-allowed;
        }

        .btn-danger {
            background: #e53e3e;
            color: white;
            font-weight: 500;
            padding: 8px 16px;
            border-radius: 12px;
            border: none;
            cursor: pointer;
        }

        .btn-danger:hover:not(:disabled) {
            background: #c53030;
        }

        .btn-danger:disabled {
            background-color: #fc8181;
            cursor: not-allowed;
        }

        .btn-filter.active {
            background: #0071e3;
            color: white;
        }

        .btn-filter:not(.active) {
            background: #e2e8f0;
            color: #4a5568;
        }

        .btn-preparing {
            background-color: #f59e0b;
            color: white;
        }

        /* Amber */
        .btn-preparing:hover {
            background-color: #d97706;
            transform: scale(1.02);
        }

        .btn-ready {
            background-color: #10b981;
            color: white;
        }

        /* Emerald */
        .btn-ready:hover {
            background-color: #059669;
            transform: scale(1.02);
        }

        .btn-delivery {
            background-color: #6366f1;
            color: white;
        }

        /* Indigo */
        .btn-delivery:hover {
            background-color: #4f46e5;
            transform: scale(1.02);
        }

        .btn-completed {
            background-color: #4b5563;
            color: white;
        }

        /* Gray */
        .btn-completed:hover {
            background-color: #374151;
            transform: scale(1.02);
        }

        input,
        select {
            border: 1px solid #d2d2d7;
            border-radius: 12px;
            padding: 12px 16px;
            font-size: 16px;
            background: white;
            min-height: 52px;
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: #0071e3;
            box-shadow: 0 0 0 4px rgba(0, 113, 227, 0.1);
        }

        input:disabled,
        select:disabled {
            background-color: #f5f5f7;
            cursor: not-allowed;
        }

        .icon {
            width: 20px;
            height: 20px;
            stroke-width: 2;
        }

        .icon-lg {
            width: 24px;
            height: 24px;
            stroke-width: 2;
        }

        .quantity-selector {
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #d2d2d7;
            border-radius: 12px;
            overflow: hidden;
        }

        .quantity-btn {
            background: transparent;
            border: none;
            padding: 10px 14px;
            cursor: pointer;
            color: #0071e3;
            font-size: 1.2rem;
            line-height: 1;
        }

        .quantity-display {
            padding: 0 10px;
            font-weight: 500;
            font-size: 1rem;
            min-width: 40px;
            text-align: center;
        }

        .status-tag {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 9999px;
            font-size: 12px;
            font-weight: 600;
            text-transform: capitalize;
        }

        .status-tag-new {
            background-color: #e0f2fe;
            color: #0284c7;
        }

        .status-tag-preparing {
            background-color: #fef3c7;
            color: #92400e;
        }

        .status-tag-ready_for_pickup {
            background-color: #d1fae5;
            color: #065f46;
        }

        .status-tag-out_for_delivery {
            background-color: #e0e7ff;
            color: #4338ca;
        }

        .status-tag-completed {
            background-color: #f3f4f6;
            color: #4b5563;
        }

        .test-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
        }

        .test-pass {
            background: #d1fae5;
            color: #065f46;
        }

        .test-fail {
            background: #fee2e2;
            color: #991b1b;
        }

        .test-pending {
            background: #fef3c7;
            color: #92400e;
        }

        /* Order Progress Tracker Styles */
        .progress-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            margin: 30px 0;
        }

        .progress-step {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            position: relative;
            z-index: 1;
            transition: background-color 0.4s ease;
        }

        .progress-step.active {
            background-color: #0071e3;
        }

        .progress-line {
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 4px;
            background-color: #e0e0e0;
            transform: translateY(-50%);
            z-index: 0;
        }

        .progress-line-fill {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            background-color: #0071e3;
            width: 0%;
            transition: width 0.4s ease;
        }

        /* Table Sort Arrow */
        .sortable-header {
            cursor: pointer;
            user-select: none;
        }

        .sortable-header:hover {
            color: #0071e3;
        }

        .sort-arrow {
            display: inline-block;
            width: 0;
            height: 0;
            margin-left: 5px;
            vertical-align: middle;
            border-left: 4px solid transparent;
            border-right: 4px solid transparent;
        }

        .sort-asc .sort-arrow {
            border-bottom: 4px solid currentColor;
        }

        .sort-desc .sort-arrow {
            border-top: 4px solid currentColor;
        }

        /* Style for scrollable view switcher on mobile */
        .mobile-scroll-x {
            overflow-x: auto;
            white-space: nowrap;
            -webkit-overflow-scrolling: touch;
            /* Smooth scrolling on iOS */
            scrollbar-width: none;
            /* Hide scrollbar for Firefox */
        }

        .mobile-scroll-x::-webkit-scrollbar {
            display: none;
            /* Hide scrollbar for Chrome, Safari, Edge */
        }

        /* Blinking animation for urgent alarm modal */
        @keyframes pulse-red {
            0% {
                box-shadow: 0 0 0 0 rgba(229, 62, 62, 0.7);
            }

            70% {
                box-shadow: 0 0 0 20px rgba(229, 62, 62, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(229, 62, 62, 0);
            }
        }

        .animate-pulse-red {
            animation: pulse-red 2s infinite;
        }

        /* Shop Schedule Tags */
        .tag-open {
            background-color: #d1fae5;
            color: #065f46;
        }

        .tag-closed {
            background-color: #fee2e2;
            color: #991b1b;
        }

        .tag-schedule {
            background-color: #e0e7ff;
            color: #4338ca;
        }

        .status-tag-returned {
            background-color: #fee2e2;
            color: #991b1b;
        }

        .cash-badge {
            background-color: #fef3c7;
            color: #92400e;
            padding: 4px 10px;
            border-radius: 9999px;
            font-size: 11px;
            font-weight: 700;
        }

        #map-picker-container {
            width: 100%;
            height: 400px;
            border-radius: 12px;
            margin-bottom: 1rem;
        }
    </style>
    <!-- Google Maps JS SDK -->
    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBbFR_K70QZEhfKNfKfsddE0ad-vXo0Eto&libraries=places"></script>
</head>

<body class="text-gray-900">
    <!-- Vrindopnishad Random Loader -->
    <!-- <script
        src="https://imbajrangi.github.io/Company/Vrindopnishad%20Web/web-extentions/loader/random-loader.js"></script> -->

    <div class="container mx-auto p-4 sm:p-6 lg:max-w-7xl relative">
        <!-- **** UPDATED HEADER SECTION **** -->
        <header class="card p-4 mb-6">
            <div class="flex flex-wrap items-center justify-between gap-y-4">
                <!-- Logo and Title -->
                <div class="flex items-center gap-3 w-full sm:w-auto flex-grow sm:flex-grow-0">
                    <div
                        class="w-10 h-10 bg-black rounded-xl flex items-center justify-center overflow-hidden flex-shrink-0">
                        <img src="https://imbajrangi.github.io/Company/Vrindopnishad%20Web/class/logo/foodyVrinda-logo.png"
                            alt="FoodyVrindaLogo" class="w-full h-full object-contain p-1">
                    </div>
                    <div>
                        <h1 class="text-xl sm:text-2xl font-semibold text-gray-900 truncate">Foody Vrinda</h1>
                        <p class="text-xs sm:text-sm text-gray-500 truncate" id="header-subtitle">Find your favorites
                        </p>
                    </div>
                </div>

                <!-- Auth, Notifications & Profile (Takes full width on smallest, then auto) -->
                <div class="flex items-center justify-end gap-2 w-full sm:w-auto order-first sm:order-none">

                    <!-- Audio Unlock Button (New) -->
                    <button id="enable-audio-btn"
                        class="hidden bg-yellow-100 text-yellow-800 px-3 py-1.5 text-xs font-bold rounded-lg hover:bg-yellow-200 transition-all flex items-center gap-1 animate-pulse">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z">
                            </path>
                        </svg>
                        Enable Sound
                    </button>

                    <!-- **** NEW: My Orders Button **** -->
                    <button id="my-orders-btn"
                        class="hidden w-10 h-10 rounded-lg flex items-center justify-center text-gray-600 hover:bg-gray-100 transition-all">
                        <svg class="icon-lg" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2">
                            </path>
                        </svg>
                    </button>

                    <!-- **** NEW: Unified Search Button **** -->
                    <button id="unified-search-btn"
                        class="w-10 h-10 rounded-lg flex items-center justify-center text-gray-600 hover:bg-gray-100 transition-all"
                        title="Search everything (Ctrl+K)">
                        <svg class="icon-lg" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                    </button>

                    <!-- **** NEW: Notification Bell **** -->
                    <div class="relative flex-shrink-0">
                        <button id="notification-bell-btn"
                            class="w-10 h-10 rounded-lg flex items-center justify-center text-gray-600 hover:bg-gray-100 transition-all">
                            <svg class="icon-lg" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341A6.002 6.002 0 006 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9">
                                </path>
                            </svg>
                        </button>
                        <span id="notification-dot"
                            class="hidden absolute top-1 right-1 w-3 h-3 bg-red-500 rounded-full border-2 border-white"></span>
                    </div>
                    <!-- **** END NEW **** -->

                    <div class="flex items-center gap-2 bg-gray-50 rounded-lg px-2 py-1 text-xs truncate">
                        <div id="auth-avatar"
                            class="w-6 h-6 rounded-full bg-gray-300 flex items-center justify-center overflow-hidden flex-shrink-0">
                            <img id="auth-avatar-img" src="" alt="" class="w-full h-full object-cover hidden">
                            <span id="auth-avatar-text" class="text-xs font-medium text-gray-600">V</span>
                        </div>
                        <div id="auth-status" class="font-medium text-gray-700 truncate">Guest</div>
                    </div>
                    <button id="user-auth-btn"
                        class="bg-black text-white px-3 py-1.5 text-xs font-medium rounded-lg hover:bg-gray-800 transition-all flex-shrink-0">
                        Profile
                    </button>
                    <!-- **** NEW: Install App Button (Hidden by default) **** -->
                    <button id="install-app-btn"
                        class="hidden bg-blue-600 text-white px-3 py-1.5 text-xs font-medium rounded-lg hover:bg-blue-700 transition-all flex-shrink-0 flex items-center gap-1">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                        </svg>
                        Install
                    </button>
                </div>

                <!-- View Switcher (Full width on mobile, scrollable) -->
                <div id="view-switcher" class="w-full sm:w-auto mobile-scroll-x sm:overflow-visible">
                    <div class="flex items-center bg-gray-100 rounded-lg p-1 gap-1 w-max sm:w-auto">
                        <button data-view="customer"
                            class="px-3 py-1.5 text-xs sm:text-sm font-medium rounded-md transition-all flex-shrink-0 btn-active">Order</button>
                        <button data-view="kitchen"
                            class="hidden px-3 py-1.5 text-xs sm:text-sm font-medium rounded-md transition-all flex-shrink-0">Kitchen</button>
                        <button data-view="transport"
                            class="hidden px-3 py-1.5 text-xs sm:text-sm font-medium rounded-md transition-all flex-shrink-0">Delivery</button>
                        <!-- MODIFICATION: Base colors are now set in CSS -->
                        <button data-view="owner"
                            class="hidden px-3 py-1.5 text-xs sm:text-sm font-medium rounded-md transition-all flex-shrink-0">Dashboard</button>
                        <button data-view="developer"
                            class="hidden px-3 py-1.5 text-xs sm:text-sm font-medium rounded-md transition-all flex-shrink-0">Dev
                            Panel</button>
                    </div>
                </div>
            </div>
        </header>
        <!-- **** END OF UPDATED HEADER SECTION **** -->

        <main>
            <!-- All view containers -->
            <div id="customer-view" class="view-active">
                <div id="shop-selector-view">
                    <div class="mb-6">
                        <h2 class="text-3xl font-semibold text-gray-900 mb-2">Shop Now</h2>
                        <p class="text-gray-500">Choose where you'd like to order from.</p>
                    </div>
                    <!-- Shop Search Bar -->
                    <div class="mb-6">
                        <div class="relative">
                            <svg class="absolute left-4 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400"
                                fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                            <input type="text" id="shop-search-input" placeholder="Search for shops..."
                                class="w-full pl-12 pr-12 py-3 border border-gray-300 rounded-xl focus:outline-none focus:border-blue-500 focus:ring-4 focus:ring-blue-100 transition-all">
                            <button id="shop-search-clear"
                                class="hidden absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 transition-colors">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                        <div id="shop-search-results" class="mt-2 text-sm text-gray-500"></div>
                    </div>
                    <div id="shop-list-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                </div>
                <div id="menu-and-cart-view" class="hidden">
                    <button id="back-to-shops"
                        class="btn-primary bg-gray-600 hover:bg-gray-700 mb-6 text-sm py-2 px-4">&larr; Back to
                        Shops</button>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-2">
                            <div class="card p-6 sm:p-8">
                                <div class="mb-6">
                                    <h2 class="text-3xl font-semibold text-gray-900 mb-2" id="menu-shop-name">Menu</h2>
                                    <p class="text-gray-500">Choose your favorites</p>
                                </div>
                                <!-- Menu Search Bar -->
                                <div class="mb-6">
                                    <div class="relative">
                                        <svg class="absolute left-4 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400"
                                            fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                        </svg>
                                        <input type="text" id="menu-search-input" placeholder="Search for dishes..."
                                            class="w-full pl-12 pr-12 py-3 border border-gray-300 rounded-xl focus:outline-none focus:border-blue-500 focus:ring-4 focus:ring-blue-100 transition-all">
                                        <button id="menu-search-clear"
                                            class="hidden absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 transition-colors">
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M6 18L18 6M6 6l12 12"></path>
                                            </svg>
                                        </button>
                                    </div>
                                    <div id="menu-search-results" class="mt-2 text-sm text-gray-500"></div>
                                </div>
                                <div id="menu-items" class="grid grid-cols-1 sm:grid-cols-2 gap-6"></div>
                            </div>
                        </div>
                        <div class="space-y-6">
                            <div class="card p-6">
                                <div class="flex items-center gap-2 mb-4"><svg class="icon-lg text-gray-900" fill="none"
                                        stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round"
                                            d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path>
                                    </svg>
                                    <h2 class="text-xl font-semibold text-gray-900">Cart</h2>
                                </div>
                                <div id="cart-items" class="space-y-4 mb-4 max-h-64 overflow-y-auto">
                                    <p class="text-gray-400 text-center">Cart is empty</p>
                                </div>
                                <div id="cart-summary" class="border-t pt-4 mt-4"></div>
                            </div>
                            <div id="order-form-container" class="card p-6"></div>
                            <div id="order-status-container" class="hidden card p-6"></div>
                        </div>
                    </div>
                </div>
                <div id="order-history-view" class="hidden">
                    <button id="back-to-shops-from-history"
                        class="btn-primary bg-gray-600 hover:bg-gray-700 mb-6 text-sm py-2 px-4">&larr; Back to
                        Shops</button>
                    <div class="mb-6">
                        <h2 class="text-3xl font-semibold text-gray-900 mb-2">My Orders</h2>
                        <p class="text-gray-500">View your order history and track orders.</p>
                    </div>
                    <!-- Order History Search Bar -->
                    <div class="mb-6">
                        <div class="relative">
                            <svg class="absolute left-4 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400"
                                fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                            <input type="text" id="order-history-search-input"
                                placeholder="Search your orders by items, order #, or date..."
                                class="w-full pl-12 pr-12 py-3 border border-gray-300 rounded-xl focus:outline-none focus:border-blue-500 focus:ring-4 focus:ring-blue-100 transition-all">
                            <button id="order-history-search-clear"
                                class="hidden absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 transition-colors">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                        <div id="order-history-search-results" class="mt-2 text-sm text-gray-500"></div>
                    </div>
                    <div id="customer-order-list" class="space-y-4">
                        <p class="text-gray-500 text-center py-12">Loading orders...</p>
                    </div>
                </div>
            </div>

            <div id="kitchen-view" class="view-hidden card p-6 sm:p-8">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 bg-black rounded-lg flex items-center justify-center"><svg
                                class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2">
                                </path>
                            </svg></div>
                        <div>
                            <h2 class="text-3xl font-semibold text-gray-900" id="kitchen-view-title">Kitchen</h2>
                            <p class="text-sm text-gray-500">Manage pending orders for your shop</p>
                        </div>
                    </div>
                    <button id="create-order-btn"
                        class="btn-primary bg-green-600 hover:bg-green-700 w-full sm:w-auto">Create New Order</button>
                </div>
                <!-- GLOBAL STOP ALARM BUTTON (Normally Hidden) -->
                <button id="global-stop-alarm-btn"
                    class="hidden w-full mb-6 bg-red-600 text-white font-bold py-4 rounded-xl shadow-lg animate-pulse-red text-xl flex items-center justify-center gap-2">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z">
                        </path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M17 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2"></path>
                    </svg>
                    <span id="global-stop-alarm-text">STOP ALARM (NEW ORDER)</span>
                </button>
                <div id="kitchen-orders-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            </div>

            <div id="transport-view" class="view-hidden card p-6 sm:p-8">
                <div class="flex items-center gap-3 mb-6">
                    <div class="w-12 h-12 bg-black rounded-lg flex items-center justify-center"><svg
                            class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                        </svg></div>
                    <div>
                        <h2 class="text-3xl font-semibold text-gray-900" id="transport-view-title">Delivery</h2>
                        <p class="text-sm text-gray-500">Ready for delivery from your shop</p>
                    </div>
                </div>
                <!-- Transport Search Bar -->
                <div class="mb-6">
                    <div class="relative">
                        <svg class="absolute left-4 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400"
                            fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                        <input type="text" id="transport-search-input"
                            placeholder="Search orders by order #, customer name, or items..."
                            class="w-full pl-12 pr-12 py-3 border border-gray-300 rounded-xl focus:outline-none focus:border-blue-500 focus:ring-4 focus:ring-blue-100 transition-all">
                        <button id="transport-search-clear"
                            class="hidden absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 transition-colors">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    <div id="transport-search-results" class="mt-2 text-sm text-gray-500"></div>
                </div>
                <!-- GLOBAL STOP ALARM BUTTON FOR DELIVERY (Normally Hidden) -->
                <button id="global-stop-alarm-btn-delivery"
                    class="hidden w-full mb-6 bg-red-600 text-white font-bold py-4 rounded-xl shadow-lg animate-pulse-red text-xl flex items-center justify-center gap-2">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z">
                        </path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M17 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2"></path>
                    </svg>
                    <span id="global-stop-alarm-text-delivery">STOP ALARM (ORDER READY)</span>
                </button>
                <div id="transport-orders-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            </div>

            <div id="owner-view" class="view-hidden space-y-8">
                <div>
                    <h2 class="text-3xl font-semibold text-gray-900 mb-2" id="owner-view-title">Owner Dashboard</h2>
                    <p class="text-gray-500">A high-level overview of your kitchen's performance.</p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="card p-6 flex items-center gap-5">
                        <div class="w-14 h-14 bg-green-100 rounded-xl flex items-center justify-center"><svg
                                class="w-7 h-7 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v.01">
                                </path>
                            </svg></div>
                        <div>
                            <p class="text-sm text-gray-500 font-medium">Total Revenue</p>
                            <p id="kpi-total-revenue" class="text-3xl font-semibold text-gray-900">₹0</p>
                        </div>
                    </div>
                    <div class="card p-6 flex items-center gap-5">
                        <div class="w-14 h-14 bg-blue-100 rounded-xl flex items-center justify-center"><svg
                                class="w-7 h-7 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 9h3m-3 4h3m-6-4h.01M9 16h.01">
                                </path>
                            </svg></div>
                        <div>
                            <p class="text-sm text-gray-500 font-medium">Total Orders</p>
                            <p id="kpi-total-orders" class="text-3xl font-semibold text-gray-900">0</p>
                        </div>
                    </div>
                    <div class="card p-6 flex items-center gap-5">
                        <div class="w-14 h-14 bg-indigo-100 rounded-xl flex items-center justify-center"><svg
                                class="w-7 h-7 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M11 11V9a2 2 0 00-2-2m2 4v4a2 2 0 104 0v-1m-4-3H9m2 0h4m6 1a9 9 0 11-18 0 9 9 0 0118 0z">
                                </path>
                            </svg></div>
                        <div>
                            <p class="text-sm text-gray-500 font-medium">Avg. Order Value</p>
                            <p id="kpi-avg-order-value" class="text-3xl font-semibold text-gray-900">₹0</p>
                        </div>
                    </div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
                    <div class="lg:col-span-3 card p-6 flex flex-col">
                        <div>
                            <h3 class="text-xl font-semibold mb-1">Daily Sales</h3>
                            <p class="text-sm text-gray-500 mb-4">Revenue generated each day.</p>
                        </div>
                        <div class="relative flex-grow h-80"><canvas id="sales-chart-canvas"></canvas></div>
                    </div>
                    <div class="lg:col-span-2 card p-6 flex flex-col">
                        <div>
                            <h3 class="text-xl font-semibold mb-1">Order Status</h3>
                            <p class="text-sm text-gray-500 mb-4">Current breakdown of all orders.</p>
                        </div>
                        <div class="relative flex-grow h-80"><canvas id="status-chart-canvas"></canvas></div>
                    </div>
                </div>
                <div id="order-history-container" class="card p-6 sm:p-8">
                    <h2 class="text-2xl font-semibold text-gray-900 mb-4">Completed Order History</h2>
                    <div id="history-filters" class="flex items-center gap-2 mb-4 border-b pb-4"><button
                            data-filter="week" class="history-filter-btn px-4 py-2 text-sm font-medium rounded-md">This
                            Week</button><button data-filter="month"
                            class="history-filter-btn px-4 py-2 text-sm font-medium rounded-md">This
                            Month</button><button data-filter="all"
                            class="history-filter-btn px-4 py-2 text-sm font-medium rounded-md">All Time</button></div>
                    <div id="order-history-list" class="space-y-4 max-h-96 overflow-y-auto">
                        <p class="text-gray-500">No past orders found.</p>
                    </div>
                </div>
                <div class="card p-8">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center">
                            <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z">
                                </path>
                            </svg>
                        </div>
                        <div>
                            <h2 class="text-2xl font-bold text-gray-900">Staff Management</h2>
                            <p class="text-sm text-gray-500">Manage your team members</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                        <!-- Add Staff Form -->
                        <div
                            class="lg:col-span-5 bg-gradient-to-br from-purple-50 to-white p-6 rounded-2xl border border-purple-100">
                            <h3 class="text-lg font-bold text-purple-900 mb-5 uppercase tracking-wide">Add New Staff
                                Member</h3>
                            <form id="add-staff-form" class="space-y-5">
                                <div class="input-group">
                                    <label class="form-label text-purple-700">Full Name</label>
                                    <input type="text" id="staff-name" placeholder="John Doe" class="w-full" required>
                                </div>
                                <div class="input-group">
                                    <label class="form-label text-purple-700">Email Address</label>
                                    <input type="email" id="staff-email" placeholder="staff@example.com" class="w-full"
                                        required>
                                </div>
                                <div class="input-group">
                                    <label class="form-label text-purple-700">Phone Number</label>
                                    <input type="tel" id="staff-phone" placeholder="9876543210" class="w-full" required>
                                </div>
                                <div class="input-group">
                                    <label class="form-label text-purple-700">Role</label>
                                    <select id="staff-role" class="w-full" required>
                                        <option value="kitchen">Kitchen Staff</option>
                                        <option value="delivery">Delivery Staff</option>
                                    </select>
                                </div>
                                <button type="submit"
                                    class="btn-primary w-full bg-purple-600 hover:bg-purple-700 py-3 text-base font-bold">
                                    Add Staff Member
                                </button>
                                <div class="p-3 bg-purple-50 rounded-lg border border-purple-100">
                                    <p class="text-[10px] text-purple-700 italic leading-snug">
                                        <strong>Note:</strong> This pre-assigns the role. The staff member must
                                        sign up later using the same email to be automatically linked.
                                    </p>
                                </div>
                            </form>
                        </div>

                        <!-- Current Staff List -->
                        <div class="lg:col-span-7">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-bold text-gray-900 uppercase tracking-wide">Your Team</h3>
                                <div class="text-sm text-gray-500">
                                    <span id="staff-count" class="font-bold text-purple-600">0</span> members
                                </div>
                            </div>
                            <div id="staff-list" class="space-y-3 overflow-y-auto pr-2 max-h-[500px] custom-scrollbar">
                                <div class="text-center py-12 bg-gray-50 rounded-xl border-2 border-dashed">
                                    <svg class="w-12 h-12 mx-auto text-gray-400 mb-3" fill="none" stroke="currentColor"
                                        viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z">
                                        </path>
                                    </svg>
                                    <p class="text-gray-500 font-medium">No staff members yet</p>
                                    <p class="text-gray-400 text-sm mt-1">Add your first team member to get started</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="owner-cash-management"
                    class="card p-8 bg-gradient-to-br from-yellow-50 to-white border-yellow-100">
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-yellow-100 rounded-lg flex items-center justify-center">
                                <svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z">
                                    </path>
                                </svg>
                            </div>
                            <div>
                                <h2 class="text-2xl font-bold text-gray-900">Cash Flow Audit</h2>
                                <p class="text-sm text-gray-500">Settle COD collections from delivery staff</p>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                        <div class="bg-white p-4 rounded-xl border border-yellow-200 shadow-sm">
                            <p class="text-[10px] font-bold text-gray-400 uppercase mb-1">Total Collected</p>
                            <h4 id="owner-cash-total-collected" class="text-xl font-bold text-gray-900">₹0</h4>
                        </div>
                        <div class="bg-white p-4 rounded-xl border border-yellow-200 shadow-sm">
                            <p class="text-[10px] font-bold text-gray-400 uppercase mb-1">Total Settled</p>
                            <h4 id="owner-cash-total-settled" class="text-xl font-bold text-gray-900">₹0</h4>
                        </div>
                        <div class="bg-white p-4 rounded-xl border border-orange-200 bg-orange-50/30 shadow-sm">
                            <p class="text-[10px] font-bold text-orange-600 uppercase mb-1">Outstanding Balance</p>
                            <h4 id="owner-cash-outstanding" class="text-xl font-bold text-orange-600">₹0</h4>
                        </div>
                    </div>

                    <div class="overflow-hidden rounded-xl border border-gray-200 shadow-sm bg-white">
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th
                                            class="px-6 py-3 text-left text-[10px] font-bold text-gray-500 uppercase tracking-wider">
                                            Order Details</th>
                                        <th
                                            class="px-6 py-3 text-left text-[10px] font-bold text-gray-500 uppercase tracking-wider">
                                            Collected By</th>
                                        <th
                                            class="px-6 py-3 text-left text-[10px] font-bold text-gray-500 uppercase tracking-wider">
                                            Amount</th>
                                        <th
                                            class="px-6 py-3 text-center text-[10px] font-bold text-gray-500 uppercase tracking-wider">
                                            Action</th>
                                    </tr>
                                </thead>
                                <tbody id="owner-unsettled-cash-list" class="bg-white divide-y divide-gray-200">
                                    <tr>
                                        <td colspan="4" class="px-6 py-8 text-center text-gray-400 italic text-sm">No
                                            unsettled cash orders.</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div id="developer-view" class="view-hidden space-y-6">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-3xl font-bold text-gray-900">Developer Control Panel</h2>
                        <p class="text-gray-500">Manage shops, staff, and system functionality.</p>
                    </div>
                    <div class="flex gap-2">
                        <div id="dev-status-badge"
                            class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-xs font-bold uppercase tracking-wider">
                            System Online</div>
                    </div>
                </div>

                <!-- NEW: System Summary Widget -->
                <div id="dev-section-summary" class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="card p-4 bg-gradient-to-br from-blue-50 to-white border-blue-100">
                        <p class="text-xs font-bold text-blue-600 uppercase mb-1">Total Shops</p>
                        <h4 id="summary-shops-count" class="text-2xl font-bold">--</h4>
                    </div>
                    <div class="card p-4 bg-gradient-to-br from-purple-50 to-white border-purple-100">
                        <p class="text-xs font-bold text-purple-600 uppercase mb-1">Total Users</p>
                        <h4 id="summary-users-count" class="text-2xl font-bold">--</h4>
                    </div>
                    <div class="card p-4 bg-gradient-to-br from-green-50 to-white border-green-100">
                        <p class="text-xs font-bold text-green-600 uppercase mb-1">Active Orders</p>
                        <h4 id="summary-orders-count" class="text-2xl font-bold">--</h4>
                    </div>
                    <div class="card p-4 bg-gradient-to-br from-orange-50 to-white border-orange-100">
                        <p class="text-xs font-bold text-orange-600 uppercase mb-1">Firebase</p>
                        <h4 id="summary-firebase-status" class="text-sm font-bold text-green-600">CONNECTED</h4>
                    </div>
                </div>

                <!-- SECTION: PAYMENT SETTINGS -->
                <div id="dev-section-payments" class="card mb-6">
                    <div class="dev-section">
                        <div class="section-header">
                            <div class="section-icon">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z">
                                    </path>
                                </svg>
                            </div>
                            <h3 class="section-title">Payment Method Controls</h3>
                        </div>

                        <div class="bg-yellow-50 border border-yellow-200 rounded-xl p-4 mb-6">
                            <div class="flex items-start gap-3">
                                <svg class="w-5 h-5 text-yellow-600 mt-0.5 flex-shrink-0" fill="none"
                                    stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z">
                                    </path>
                                </svg>
                                <div>
                                    <p class="text-sm font-bold text-yellow-800 mb-1">Global Payment Controls</p>
                                    <p class="text-xs text-yellow-700">Disabling a payment method will prevent ALL
                                        customers from using it. Orders with disabled methods will be rejected.</p>
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Online Payments Toggle -->
                            <div class="bg-gradient-to-br from-blue-50 to-white p-6 rounded-2xl border border-blue-100">
                                <div class="flex items-center justify-between mb-4">
                                    <div class="flex items-center gap-3">
                                        <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center">
                                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor"
                                                viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z">
                                                </path>
                                            </svg>
                                        </div>
                                        <div>
                                            <h4 class="font-bold text-gray-900">Online Payments</h4>
                                            <p class="text-xs text-gray-500">via Razorpay</p>
                                        </div>
                                    </div>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="toggle-online-payments" class="sr-only peer" checked>
                                        <div
                                            class="w-14 h-7 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[4px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:bg-blue-600">
                                        </div>
                                    </label>
                                </div>
                                <p id="online-payment-status" class="text-sm font-medium text-green-600">✓ Currently
                                    Enabled</p>
                            </div>

                            <!-- COD Toggle -->
                            <div
                                class="bg-gradient-to-br from-yellow-50 to-white p-6 rounded-2xl border border-yellow-100">
                                <div class="flex items-center justify-between mb-4">
                                    <div class="flex items-center gap-3">
                                        <div
                                            class="w-10 h-10 bg-yellow-600 rounded-lg flex items-center justify-center">
                                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor"
                                                viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z">
                                                </path>
                                            </svg>
                                        </div>
                                        <div>
                                            <h4 class="font-bold text-gray-900">Cash on Delivery</h4>
                                            <p class="text-xs text-gray-500">Pay at delivery</p>
                                        </div>
                                    </div>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="toggle-cod" class="sr-only peer" checked>
                                        <div
                                            class="w-14 h-7 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-yellow-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[4px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:bg-yellow-600">
                                        </div>
                                    </label>
                                </div>
                                <p id="cod-status" class="text-sm font-medium text-green-600">✓ Currently Enabled</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="dev-section-shops" class="card">
                    <!-- SECTION: SHOP MANAGEMENT -->
                    <div class="dev-section">
                        <div class="section-header">
                            <div class="section-icon">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-7h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4">
                                    </path>
                                </svg>
                            </div>
                            <h3 class="section-title">Shop Management</h3>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-10">
                            <div>
                                <h4 class="text-sm font-bold text-gray-700 mb-4 uppercase">Create New Shop</h4>
                                <form id="create-shop-form" class="space-y-4">
                                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                        <div class="input-group">
                                            <label class="form-label">Shop Name</label>
                                            <input type="text" id="shop-name" placeholder="Vrinda Kitchen"
                                                class="w-full" required>
                                        </div>
                                        <div class="input-group">
                                            <label class="form-label">Phone Number</label>
                                            <input type="tel" id="shop-phone" placeholder="9876543210" class="w-full">
                                        </div>
                                    </div>
                                    <div class="input-group">
                                        <label class="form-label">Address</label>
                                        <input type="text" id="shop-address" placeholder="123 Food Street, City"
                                            class="w-full" required>
                                    </div>
                                    <div class="input-group">
                                        <label class="form-label">Shop Image URL</label>
                                        <input type="url" id="shop-image" placeholder="https://example.com/image.jpg"
                                            class="w-full">
                                    </div>
                                    <div class="grid grid-cols-2 gap-4 bg-gray-50 p-4 rounded-xl border">
                                        <div class="input-group mb-0">
                                            <label class="form-label">Latitude</label>
                                            <input type="number" id="shop-lat" step="any" readonly
                                                class="w-full bg-white text-sm" placeholder="Click Map ->">
                                        </div>
                                        <div class="input-group mb-0">
                                            <label class="form-label">Longitude</label>
                                            <input type="number" id="shop-lng" step="any" readonly
                                                class="w-full bg-white text-sm" placeholder="Click Map ->">
                                        </div>
                                        <button type="button" id="open-map-btn"
                                            onclick="openMapPicker('shop-lat', 'shop-lng')"
                                            class="col-span-2 text-xs font-bold text-blue-600 hover:text-blue-800 flex items-center justify-center gap-1 py-1 cursor-pointer">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z">
                                                </path>
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                            </svg>
                                            Set Location on Map
                                        </button>
                                    </div>

                                    <div class="bg-gray-50 p-4 rounded-xl border space-y-3">
                                        <h5 class="text-xs font-bold text-gray-500 uppercase">Operational Settings
                                        </h5>
                                        <div class="grid grid-cols-2 gap-4">
                                            <div class="input-group mb-0">
                                                <label class="form-label">Avg Prep (Min)</label>
                                                <input type="number" id="shop-wait-time" value="15" class="w-full">
                                            </div>
                                            <div class="flex flex-col gap-2 justify-center">
                                                <label class="flex items-center gap-2 cursor-pointer text-sm">
                                                    <input type="checkbox" id="shop-show-wait" checked
                                                        class="w-4 h-4 rounded">
                                                    Show Wait Time
                                                </label>
                                                <label class="flex items-center gap-2 cursor-pointer text-sm">
                                                    <input type="checkbox" id="shop-show-queue" class="w-4 h-4 rounded">
                                                    Show Queue
                                                </label>
                                            </div>
                                        </div>

                                        <div class="grid grid-cols-2 gap-3 pt-2">
                                            <div>
                                                <label class="form-label text-[10px]">Open Time</label>
                                                <input type="time" id="shop-open-time" value="09:00"
                                                    class="w-full text-xs min-h-[40px]">
                                            </div>
                                            <div>
                                                <label class="form-label text-[10px]">Close Time</label>
                                                <input type="time" id="shop-close-time" value="21:00"
                                                    class="w-full text-xs min-h-[40px]">
                                            </div>
                                        </div>

                                        <div>
                                            <label class="form-label text-[10px]">Operating Days</label>
                                            <div class="flex flex-wrap gap-2 mt-1">
                                                <label
                                                    class="flex items-center gap-1 text-[11px] bg-white px-2 py-1 rounded border cursor-pointer hover:bg-blue-50">
                                                    <input type="checkbox" name="shop-days" value="Mon" checked> Mon
                                                </label>
                                                <label
                                                    class="flex items-center gap-1 text-[11px] bg-white px-2 py-1 rounded border cursor-pointer hover:bg-blue-50">
                                                    <input type="checkbox" name="shop-days" value="Tue" checked> Tue
                                                </label>
                                                <label
                                                    class="flex items-center gap-1 text-[11px] bg-white px-2 py-1 rounded border cursor-pointer hover:bg-blue-50">
                                                    <input type="checkbox" name="shop-days" value="Wed" checked> Wed
                                                </label>
                                                <label
                                                    class="flex items-center gap-1 text-[11px] bg-white px-2 py-1 rounded border cursor-pointer hover:bg-blue-50">
                                                    <input type="checkbox" name="shop-days" value="Thu" checked> Thu
                                                </label>
                                                <label
                                                    class="flex items-center gap-1 text-[11px] bg-white px-2 py-1 rounded border cursor-pointer hover:bg-blue-50">
                                                    <input type="checkbox" name="shop-days" value="Fri" checked> Fri
                                                </label>
                                                <label
                                                    class="flex items-center gap-1 text-[11px] bg-white px-2 py-1 rounded border cursor-pointer hover:bg-blue-50">
                                                    <input type="checkbox" name="shop-days" value="Sat" checked> Sat
                                                </label>
                                                <label
                                                    class="flex items-center gap-1 text-[11px] bg-white px-2 py-1 rounded border cursor-pointer hover:bg-blue-50">
                                                    <input type="checkbox" name="shop-days" value="Sun" checked> Sun
                                                </label>
                                            </div>
                                        </div>
                                    </div>

                                    <button type="submit" class="btn-primary w-full bg-green-600 hover:bg-green-700">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                        </svg>
                                        Create Shop
                                    </button>
                                </form>
                            </div>

                            <div class="flex flex-col">
                                <h4 class="text-sm font-bold text-gray-700 mb-4 uppercase">Existing Shops</h4>
                                <div id="dev-shop-list"
                                    class="space-y-4 flex-grow overflow-y-auto pr-2 max-h-[600px] custom-scrollbar">
                                    <p class="text-gray-500 text-center py-10 italic">Loading shops...</p>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>

                <!-- SECTION: STAFF & ROLE MANAGEMENT -->
                <div id="dev-section-users" class="dev-section bg-gray-50/50">
                    <div class="section-header">
                        <div class="section-icon bg-purple-100 text-purple-600">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z">
                                </path>
                            </svg>
                        </div>
                        <h3 class="section-title">Staff & Role Management</h3>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-12 gap-10">
                        <!-- Pre-creation form -->
                        <div class="lg:col-span-4 bg-white p-6 rounded-2xl border shadow-sm">
                            <h4 class="text-sm font-bold text-gray-700 mb-4 uppercase">Add Staff (Pre-creation)
                            </h4>
                            <form id="dev-register-staff-form" class="space-y-4">
                                <div class="input-group">
                                    <label class="form-label">Full Name</label>
                                    <input type="text" id="dev-staff-name" placeholder="John Doe" class="w-full"
                                        required>
                                </div>
                                <div class="input-group">
                                    <label class="form-label">Email Address</label>
                                    <input type="email" id="dev-staff-email" placeholder="john@example.com"
                                        class="w-full" required>
                                </div>
                                <div class="input-group">
                                    <label class="form-label">Phone Number</label>
                                    <input type="tel" id="dev-staff-phone" placeholder="9876543210" class="w-full"
                                        required>
                                </div>
                                <div class="grid grid-cols-1 gap-4">
                                    <div class="input-group">
                                        <label class="form-label">Role</label>
                                        <select id="dev-staff-role" class="w-full" required>
                                            <option value="kitchen">Kitchen Staff</option>
                                            <option value="delivery">Delivery Boy</option>
                                            <option value="owner">Shop Owner</option>
                                        </select>
                                    </div>
                                    <div class="input-group">
                                        <label class="form-label">Assign to Shop</label>
                                        <select id="dev-staff-shop" class="w-full" required>
                                            <option value="">-- Select Shop --</option>
                                        </select>
                                    </div>
                                </div>
                                <button type="submit" class="btn-primary w-full bg-purple-600 hover:bg-purple-700">
                                    Create Record
                                </button>
                                <div class="p-3 bg-purple-50 rounded-lg border border-purple-100">
                                    <p class="text-[10px] text-purple-700 italic leading-snug">
                                        <strong>Note:</strong> This pre-assigns the role. The staff member must
                                        sign up later using this same email to be automatically linked.
                                    </p>
                                </div>
                            </form>
                        </div>

                        <!-- User Management Table -->
                        <div class="lg:col-span-8">
                            <div class="flex items-center justify-between mb-4">
                                <h4 class="text-sm font-bold text-gray-700 uppercase">User Role Management</h4>
                                <div class="relative w-full max-w-xs">
                                    <input type="text" id="user-search-input" placeholder="Filter users..."
                                        class="w-full py-2 px-4 text-sm min-h-[40px]">
                                </div>
                            </div>
                            <div class="overflow-hidden rounded-xl border border-gray-200 shadow-sm bg-white">
                                <div class="overflow-x-auto max-h-[500px] custom-scrollbar">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-6 py-3 text-left text-[10px] font-bold text-gray-500 uppercase tracking-wider sortable-header cursor-pointer"
                                                    data-sort="email">User Email <span class="sort-arrow"></span>
                                                </th>
                                                <th class="px-6 py-3 text-left text-[10px] font-bold text-gray-500 uppercase tracking-wider sortable-header cursor-pointer"
                                                    data-sort="role">Role <span class="sort-arrow"></span></th>
                                                <th
                                                    class="px-6 py-3 text-left text-[10px] font-bold text-gray-500 uppercase tracking-wider">
                                                    Update Role</th>
                                                <th class="px-6 py-3 text-left text-[10px] font-bold text-gray-500 uppercase tracking-wider"
                                                    data-sort="shop">Shop Assignment</th>
                                                <th
                                                    class="px-4 py-3 text-center text-[10px] font-bold text-gray-500 uppercase tracking-wider">
                                                    Action</th>
                                            </tr>
                                        </thead>
                                        <tbody id="admin-user-list" class="bg-white divide-y divide-gray-200">
                                            <tr>
                                                <td colspan="5" class="px-6 py-10 text-center text-gray-500 italic">
                                                    No users
                                                    found.</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SECTION: MENU MANAGEMENT -->
                <div id="dev-section-menu" class="dev-section">
                    <div class="section-header">
                        <div class="section-icon bg-green-100 text-green-600">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01">
                                </path>
                            </svg>
                        </div>
                        <h3 class="section-title">Menu Management</h3>
                    </div>

                    <div class="max-w-md mb-6">
                        <label class="form-label">Select Shop to Manage</label>
                        <select id="dev-menu-shop-select" class="w-full">
                            <option value="">-- Select a Shop --</option>
                        </select>
                    </div>

                    <div id="dev-menu-manager-content"
                        class="hidden grid grid-cols-1 md:grid-cols-2 gap-10 bg-gray-50 p-6 rounded-2xl border">
                        <div>
                            <h4 class="text-sm font-bold text-gray-700 mb-4 uppercase">Add New Menu Item</h4>
                            <form id="create-menu-item-form" class="space-y-4">
                                <div class="input-group">
                                    <label class="form-label">Item Name</label>
                                    <input type="text" id="menu-item-name" placeholder="Masala Dosa" class="w-full"
                                        required>
                                </div>
                                <div class="input-group">
                                    <label class="form-label">Price (₹)</label>
                                    <input type="number" id="menu-item-price" placeholder="120" class="w-full" required>
                                </div>
                                <div class="input-group">
                                    <label class="form-label">Image URL (Optional)</label>
                                    <input type="url" id="menu-item-image" placeholder="https://example.com/dosa.jpg"
                                        class="w-full">
                                </div>
                                <button type="submit" class="btn-primary w-full bg-green-600 hover:bg-green-700">Add
                                    to
                                    Menu</button>
                            </form>
                        </div>
                        <div>
                            <h4 class="text-sm font-bold text-gray-700 mb-4 uppercase">Current Menu Items</h4>
                            <div id="dev-menu-item-list"
                                class="space-y-3 max-h-[300px] overflow-y-auto pr-2 custom-scrollbar">
                                <p class="text-gray-500 italic text-center py-10">Select a shop to see its menu.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SECTION: ALL ORDERS MONITOR -->
                <div class="dev-section bg-gray-50/30">
                    <div class="section-header">
                        <div class="section-icon bg-orange-100 text-orange-600">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9">
                                </path>
                            </svg>
                        </div>
                        <h3 class="section-title">All Orders Monitor</h3>
                    </div>

                    <div class="bg-white p-6 rounded-2xl border shadow-sm">
                        <div class="flex flex-col md:flex-row items-center justify-between gap-4 mb-6">
                            <div class="flex flex-wrap items-center gap-2">
                                <span class="text-xs font-bold text-gray-400 uppercase mr-2">Filter:</span>
                                <button data-filter="today"
                                    class="order-filter-btn px-4 py-1.5 rounded-full text-xs font-bold transition-all border hover:bg-gray-50">Today</button>
                                <button data-filter="week"
                                    class="order-filter-btn px-4 py-1.5 rounded-full text-xs font-bold transition-all border hover:bg-gray-50">Week</button>
                                <button data-filter="month"
                                    class="order-filter-btn px-4 py-1.5 rounded-full text-xs font-bold transition-all border hover:bg-gray-50">Month</button>
                                <button data-filter="all"
                                    class="order-filter-btn px-4 py-1.5 rounded-full text-xs font-bold transition-all border border-blue-200 bg-blue-50 text-blue-600 active">All
                                    Time</button>
                            </div>
                            <div class="relative w-full md:w-64">
                                <input type="text" id="order-search-input-dev" placeholder="Search order by ID..."
                                    class="w-full py-2 px-4 text-sm min-h-[40px]">
                            </div>
                        </div>

                        <div id="all-orders-list" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6 min-h-[100px]">
                            <p class="col-span-full text-gray-500 text-center py-10 italic">Loading orders...
                            </p>
                        </div>

                        <div class="flex justify-between items-center pt-6 border-t">
                            <button id="prev-orders-btn"
                                class="px-4 py-2 text-sm font-bold text-gray-600 hover:text-blue-600 transition-colors disabled:opacity-30 disabled:cursor-not-allowed">←
                                Previous</button>
                            <span id="order-page-info" class="text-xs font-bold text-gray-400 uppercase">Page
                                1</span>
                            <button id="next-orders-btn"
                                class="px-4 py-2 text-sm font-bold text-gray-600 hover:text-blue-600 transition-colors disabled:opacity-30 disabled:cursor-not-allowed">Next
                                →</button>
                        </div>
                    </div>
                </div>

                <!-- SECTION: CASH AUDIT -->
                <div id="dev-section-cash-audit" class="dev-section bg-yellow-50/20">
                    <div class="section-header">
                        <div class="section-icon bg-yellow-100 text-yellow-600">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z">
                                </path>
                            </svg>
                        </div>
                        <h3 class="section-title">Cash Audit & Settlement</h3>
                    </div>

                    <div class="card p-6">
                        <div class="flex flex-col md:flex-row gap-4 mb-6 items-end">
                            <div class="flex-grow">
                                <label class="form-label">Shop Filter</label>
                                <select id="cash-audit-shop-select" class="w-full">
                                    <option value="">-- All Shops --</option>
                                </select>
                            </div>
                            <button onclick="loadCashAuditData()"
                                class="btn-primary bg-blue-600 hover:bg-blue-700 h-[52px]">
                                Refresh Audit
                            </button>
                        </div>

                        <div class="overflow-x-auto rounded-xl border border-gray-200 shadow-sm bg-white">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th
                                            class="px-6 py-3 text-left text-[10px] font-bold text-gray-500 uppercase tracking-wider">
                                            Order Info</th>
                                        <th
                                            class="px-6 py-3 text-left text-[10px] font-bold text-gray-500 uppercase tracking-wider">
                                            Shop</th>
                                        <th
                                            class="px-6 py-3 text-left text-[10px] font-bold text-gray-500 uppercase tracking-wider">
                                            Delivery Staff</th>
                                        <th
                                            class="px-6 py-3 text-left text-[10px] font-bold text-gray-500 uppercase tracking-wider text-right">
                                            Amount</th>
                                        <th
                                            class="px-6 py-3 text-center text-[10px] font-bold text-gray-500 uppercase tracking-wider">
                                            Action</th>
                                    </tr>
                                </thead>
                                <tbody id="dev-cash-audit-list" class="divide-y divide-gray-200">
                                    <tr>
                                        <td colspan="5" class="px-6 py-10 text-center text-gray-500 italic">Select a
                                            shop or click Refresh to see unsettled cash orders.</td>
                                    </tr>
                                </tbody>
                                <tfoot id="dev-cash-audit-footer" class="hidden bg-gray-50">
                                    <tr>
                                        <td colspan="3" class="px-6 py-4 text-right font-bold text-gray-900">Total
                                            Unsettled:</td>
                                        <td id="dev-cash-audit-total"
                                            class="px-6 py-4 text-right font-bold text-lg text-red-600">₹0</td>
                                        <td class="px-6 py-4 text-center">
                                            <button id="batch-settle-btn" onclick="batchSettleCash()"
                                                class="btn-primary bg-green-600 hover:bg-green-700 py-2 text-xs">
                                                SETTLE ALL
                                            </button>
                                        </td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- SECTION: SYSTEM TOOLS -->
                <div id="dev-section-tools" class="dev-section">
                    <div class="section-header">
                        <div class="section-icon bg-red-100 text-red-600">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z">
                                </path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>
                        </div>
                        <h3 class="section-title">System Tools</h3>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div class="bg-red-50 p-6 rounded-2xl border border-red-100">
                            <h4 class="text-sm font-bold text-red-700 mb-4 uppercase">Test Order Flow</h4>
                            <form id="test-order-form" class="space-y-4">
                                <div class="input-group">
                                    <label class="form-label text-red-600">Select Shop</label>
                                    <select id="test-order-shop-select" class="w-full border-red-200" required>
                                        <option value="">-- Select a Shop --</option>
                                    </select>
                                </div>
                                <div id="test-order-details" class="hidden space-y-4">
                                    <div class="grid grid-cols-2 gap-3">
                                        <div class="input-group">
                                            <label class="form-label text-red-600">Customer Name</label>
                                            <input type="text" id="test-name" value="Test Customer"
                                                class="w-full text-sm" required>
                                        </div>
                                        <div class="input-group">
                                            <label class="form-label text-red-600">Phone</label>
                                            <input type="tel" id="test-phone" value="9876543210" class="w-full text-sm"
                                                required>
                                        </div>
                                    </div>
                                    <div class="input-group">
                                        <label class="form-label text-red-600">Delivery Address</label>
                                        <input type="text" id="test-address" value="123 Test Street, Test City"
                                            class="w-full text-sm" required>
                                    </div>
                                    <div class="input-group">
                                        <label class="form-label text-red-600">Select Items</label>
                                        <div id="test-menu-items"
                                            class="max-h-48 overflow-y-auto space-y-2 p-3 bg-white rounded-lg border border-red-200">
                                            <p class="text-gray-500 text-xs">Loading items...</p>
                                        </div>
                                    </div>
                                    <button type="submit" class="btn-primary w-full bg-red-600 hover:bg-red-700">Create
                                        Test Order</button>
                                </div>
                                <p class="text-[10px] text-red-700 italic">Bypasses payment. Use for development
                                    only.</p>
                            </form>
                        </div>
                        <div class="bg-blue-50 p-6 rounded-2xl border border-blue-100">
                            <h4 class="text-sm font-bold text-blue-700 mb-4 uppercase">Shop Dashboard View</h4>
                            <div class="space-y-4">
                                <div class="input-group">
                                    <label class="form-label text-blue-600">Impersonate Shop</label>
                                    <select id="dev-dashboard-shop-select" class="w-full border-blue-200">
                                        <option value="">-- Select a Shop --</option>
                                    </select>
                                </div>
                                <button id="dev-view-dashboard-btn"
                                    class="btn-primary w-full bg-blue-600 hover:bg-blue-700">Switch
                                    View</button>
                            </div>
                        </div>
                        <div class="bg-purple-50 p-6 rounded-2xl border border-purple-100">
                            <h4 class="text-sm font-bold text-purple-700 mb-4 uppercase">Delivery Dashboard View</h4>
                            <div class="space-y-4">
                                <div class="input-group">
                                    <label class="form-label text-purple-600">Select Shop Delivery</label>
                                    <select id="dev-delivery-shop-select" class="w-full border-purple-200">
                                        <option value="">-- Select a Shop --</option>
                                    </select>
                                </div>
                                <button id="dev-view-delivery-btn"
                                    class="btn-primary w-full bg-purple-600 hover:bg-purple-700">Switch
                                    View</button>
                            </div>
                        </div>
                        <div class="bg-indigo-50 p-6 rounded-2xl border border-indigo-100">
                            <h4 class="text-sm font-bold text-indigo-700 mb-4 uppercase">Notification Debug</h4>
                            <div class="space-y-4">
                                <p class="text-[10px] text-indigo-600 italic">Triggers a local alarm sound and system
                                    notification to verify permissions on this domain.</p>
                                <button onclick="testAlarm()"
                                    class="btn-primary w-full bg-indigo-600 hover:bg-indigo-700 flex items-center justify-center gap-2">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9">
                                        </path>
                                    </svg>
                                    Test Alarm System
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
    </div>
    </div>
    </main>

    <!-- **** NEW: Notification Panel **** -->
    <!-- This is positioned relative to the main container, but uses z-index to appear on top -->
    <div id="notification-panel"
        class="hidden fixed inset-0 z-50 bg-black bg-opacity-40 sm:absolute sm:inset-auto sm:top-20 sm:right-6 sm:bg-transparent sm:w-96 sm:h-auto">
        <div id="notification-content-wrapper"
            class="bg-white rounded-2xl shadow-xl w-full max-w-md max-h-[90vh] overflow-y-auto sm:max-h-[32rem] border border-gray-200 m-4 sm:m-0">
            <div class="p-4 border-b flex justify-between items-center">
                <h3 class="font-semibold text-gray-900">Notifications</h3>
                <div class="flex items-center gap-2">
                    <button id="enable-push-btn"
                        class="hidden text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded hover:bg-blue-200 transition-colors">Enable
                        Push</button>
                    <!-- Close button visible only on mobile/forced modal view -->
                    <button id="notification-panel-close-btn"
                        class="sm:hidden text-gray-400 hover:text-gray-600 w-8 h-8 flex items-center justify-center rounded-lg hover:bg-gray-100 transition-all">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>
            <div id="notification-list" class="max-h-96 overflow-y-auto divide-y">
                <p class="p-4 text-gray-500 text-center">No new notifications.</p>
            </div>
            <div class="p-3 bg-gray-50 border-t flex justify-between items-center gap-2">
                <button id="mark-all-read-btn" onclick="markNotificationsAsRead()"
                    class="text-xs text-green-600 hover:text-green-800 hover:bg-green-50 px-3 py-2 rounded-lg transition-colors flex items-center gap-1">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7">
                        </path>
                    </svg>
                    Mark All Read
                </button>
                <button id="clear-all-notifications" onclick="clearAllNotifications()"
                    class="text-xs text-red-600 hover:text-red-800 hover:bg-red-50 px-3 py-2 rounded-lg transition-colors flex items-center gap-1">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
                        </path>
                    </svg>
                    Clear Read
                </button>
            </div>
        </div>
    </div>
    <!-- **** END NEW **** -->

    <div id="alert-modal" class="hidden fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center p-4"
        style="z-index: 51;">
        <div class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-sm text-center">
            <div id="alert-icon" class="w-14 h-14 rounded-full flex items-center justify-center mx-auto mb-4"></div>
            <p id="alert-message" class="text-lg font-medium mb-6 text-gray-900"></p>
            <div id="alert-buttons" class="flex gap-4">
                <button id="alert-close" class="btn-primary w-full">OK</button>
                <button id="alert-confirm" class="hidden btn-danger w-full">Confirm</button>
                <button id="alert-cancel" class="hidden btn-secondary w-full">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Unified Search Modal -->
    <div id="unified-search-modal"
        class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-start justify-center z-50 p-4 pt-20"
        style="backdrop-filter: blur(4px);">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-3xl max-h-[80vh] overflow-hidden flex flex-col">
            <!-- Search Input -->
            <div class="p-6 border-b border-gray-200">
                <div class="relative">
                    <svg class="absolute left-4 top-1/2 transform -translate-y-1/2 w-6 h-6 text-gray-400" fill="none"
                        stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                    <input type="text" id="unified-search-input" placeholder="Search shops, menu items, orders..."
                        class="w-full pl-14 pr-14 py-4 text-lg border-0 focus:outline-none focus:ring-0" autofocus>
                    <button id="unified-search-close"
                        class="absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <div class="mt-2 text-xs text-gray-500 flex items-center gap-4">
                    <span>Press <kbd class="px-2 py-1 bg-gray-100 rounded text-xs font-mono">ESC</kbd> to close</span>
                    <span>Press <kbd class="px-2 py-1 bg-gray-100 rounded text-xs font-mono">↑</kbd> <kbd
                            class="px-2 py-1 bg-gray-100 rounded text-xs font-mono">↓</kbd> to navigate</span>
                </div>
            </div>

            <!-- Search Results -->
            <div id="unified-search-results" class="flex-1 overflow-y-auto p-6">
                <div class="text-center py-12 text-gray-400">
                    <svg class="w-16 h-16 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor"
                        viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                    <p>Start typing to search...</p>
                </div>
            </div>
        </div>
    </div>

    <div id="profile-modal"
        class="hidden fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl shadow-xl p-6 sm:p-8 w-full max-w-md max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 id="profile-modal-title" class="text-2xl font-semibold text-gray-900">Profile</h2><button
                    id="profile-close"
                    class="text-gray-400 hover:text-gray-600 w-8 h-8 flex items-center justify-center rounded-lg hover:bg-gray-100 transition-all"><svg
                        class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path>
                    </svg></button>
            </div>
            <div id="profile-content"></div>
        </div>
    </div>
    <div id="create-order-modal"
        class="hidden fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl shadow-xl p-6 sm:p-8 w-full max-w-4xl max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-semibold text-gray-900">Create New Order</h2><button
                    id="create-order-close-btn"
                    class="text-gray-400 hover:text-gray-600 w-8 h-8 flex items-center justify-center rounded-lg hover:bg-gray-100 transition-all"><svg
                        class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path>
                    </svg></button>
            </div>
            <div id="create-order-content"></div>
        </div>
    </div>

    <!-- Permissions Modal -->
    <div id="permissions-modal"
        class="hidden fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-[55] p-4">
        <div class="bg-white rounded-2xl shadow-xl p-6 sm:p-8 w-full max-w-md max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-semibold text-gray-900">Grant Dev Permissions</h2>
                <button id="permissions-modal-close" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                </button>
            </div>
            <p id="permissions-user-email" class="text-sm text-gray-500 mb-6"></p>
            <div id="permissions-list" class="space-y-4">
                <!-- Permission items will be inserted here -->
            </div>
            <div class="mt-8">
                <button id="save-permissions-btn" class="btn-primary w-full">Save Permissions</button>
            </div>
        </div>
    </div>

    <!-- **** NEW: Dedicated Install Instructions Modal **** -->
    <div id="install-modal"
        class="hidden fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-[60] p-4">
        <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-sm text-center relative">
            <button id="install-modal-close" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                    </path>
                </svg>
            </button>
            <div class="w-16 h-16 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                </svg>
            </div>
            <h3 class="text-xl font-bold text-gray-900 mb-2">Install App</h3>
            <p class="text-gray-600 mb-6 text-sm">Get the best experience by installing the app on your device.</p>

            <div id="install-instructions-android" class="hidden text-left bg-gray-50 p-4 rounded-lg mb-6">
                <ol class="list-decimal list-inside space-y-2 text-sm text-gray-700">
                    <li>Tap the <strong>three dots</strong> <span class="inline-block bg-gray-200 rounded px-1">⋮</span>
                        in the browser menu.</li>
                    <li>Select <strong>Install App</strong> or <strong>Add to Home Screen</strong>.</li>
                    <li>Tap <strong>Install</strong> to confirm.</li>
                </ol>
            </div>

            <div id="install-instructions-ios" class="hidden text-left bg-gray-50 p-4 rounded-lg mb-6">
                <ol class="list-decimal list-inside space-y-2 text-sm text-gray-700">
                    <li>Tap the <strong>Share</strong> button <span
                            class="inline-block bg-gray-200 rounded px-1">⎋</span>.</li>
                    <li>Scroll down and select <strong>Add to Home Screen</strong>.</li>
                    <li>Tap <strong>Add</strong> in the top right.</li>
                </ol>
            </div>

            <button id="install-modal-ok" class="btn-primary w-full bg-blue-600 hover:bg-blue-700">Got it</button>
        </div>
    </div>

    <!-- **** Edit Shop Modal **** -->
    <div id="edit-shop-modal"
        class="hidden fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl shadow-xl p-6 sm:p-8 w-full max-w-lg max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-semibold text-gray-900">Edit Shop</h2>
                <button id="edit-shop-close"
                    class="text-gray-400 hover:text-gray-600 w-8 h-8 flex items-center justify-center rounded-lg hover:bg-gray-100 transition-all">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <form id="edit-shop-form" class="space-y-4">
                <input type="hidden" id="edit-shop-id">
                <div>
                    <label class="block text-sm font-medium mb-1">Shop Name</label>
                    <input type="text" id="edit-shop-name" placeholder="Shop Name" class="w-full" required>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Address</label>
                    <input type="text" id="edit-shop-address" placeholder="Shop Address" class="w-full">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Image URL</label>
                    <input type="text" id="edit-shop-image" placeholder="Shop Image URL (Optional)" class="w-full">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Phone Number</label>
                    <input type="tel" id="edit-shop-phone" placeholder="Shop Phone Number" class="w-full">
                </div>
                <div class="flex gap-2">
                    <div class="flex-1 space-y-2">
                        <label class="block text-sm font-medium mb-1">Location Coordinates</label>
                        <div class="grid grid-cols-2 gap-2">
                            <input type="number" step="any" id="edit-shop-lat" placeholder="Latitude"
                                class="w-full text-sm">
                            <input type="number" step="any" id="edit-shop-lng" placeholder="Longitude"
                                class="w-full text-sm">
                        </div>
                    </div>
                    <button type="button" id="open-edit-map-picker-btn"
                        class="mt-7 flex flex-col items-center justify-center p-3 border rounded-xl hover:bg-gray-50 bg-white">
                        <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z">
                            </path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                    </button>
                </div>
                <div id="edit-shop-image-preview" class="hidden">
                    <label class="block text-sm font-medium mb-1">Current Image</label>
                    <img id="edit-shop-image-img" src="" alt="Shop preview"
                        class="w-full h-32 object-cover rounded-lg border">
                </div>
                <!-- Pricing Configuration Section -->
                <div class="mt-4 p-4 bg-gray-50 rounded-xl border border-gray-100 space-y-4">
                    <h5 class="font-medium text-gray-700">Pricing Configuration</h5>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-xs font-semibold text-gray-500 uppercase mb-1">Min Order
                                (₹)</label>
                            <input type="number" id="edit-shop-min-order" min="0" class="w-full text-sm"
                                placeholder="0">
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-gray-500 uppercase mb-1">Delivery (₹)</label>
                            <input type="number" id="edit-shop-delivery-charge" min="0" class="w-full text-sm"
                                placeholder="0">
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-gray-500 uppercase mb-1">GST (%)</label>
                            <input type="number" id="edit-shop-gst" min="0" max="28" class="w-full text-sm"
                                placeholder="5">
                        </div>
                    </div>
                </div>

                <div class="mt-4 p-4 bg-gray-50 rounded-xl border border-gray-100 space-y-4">
                    <h5 class="font-medium text-gray-700">Display & Wait Time</h5>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-semibold text-gray-500 uppercase mb-1">Estimated Prep
                                Time (Min)</label>
                            <input type="number" id="edit-shop-wait-time" min="0" class="w-full text-sm">
                        </div>
                        <div class="flex flex-col justify-center gap-2">
                            <label class="flex items-center gap-2 text-sm cursor-pointer">
                                <input type="checkbox" id="edit-shop-show-wait">
                                <span>Show Waiting Time</span>
                            </label>
                            <label class="flex items-center gap-2 text-sm cursor-pointer">
                                <input type="checkbox" id="edit-shop-show-queue">
                                <span>Show Order Queue</span>
                            </label>
                        </div>
                    </div>
                </div>

                <div class="border-t pt-4">
                    <h5 class="font-medium mb-2">Shop Schedule & Periods</h5>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs text-gray-500 mb-1 font-semibold uppercase">Open
                                Time</label>
                            <input type="time" id="edit-shop-open-time" class="w-full text-sm">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 mb-1 font-semibold uppercase">Close
                                Time</label>
                            <input type="time" id="edit-shop-close-time" class="w-full text-sm">
                        </div>
                    </div>
                    <div class="mt-3">
                        <label class="text-xs font-semibold text-gray-500 uppercase">Operating Days:</label>
                        <div class="flex flex-wrap gap-2 mt-1">
                            <label class="flex items-center gap-1 text-sm"><input type="checkbox" name="edit-shop-days"
                                    value="Mon"> Mon</label>
                            <label class="flex items-center gap-1 text-sm"><input type="checkbox" name="edit-shop-days"
                                    value="Tue"> Tue</label>
                            <label class="flex items-center gap-1 text-sm"><input type="checkbox" name="edit-shop-days"
                                    value="Wed"> Wed</label>
                            <label class="flex items-center gap-1 text-sm"><input type="checkbox" name="edit-shop-days"
                                    value="Thu"> Thu</label>
                            <label class="flex items-center gap-1 text-sm"><input type="checkbox" name="edit-shop-days"
                                    value="Fri"> Fri</label>
                            <label class="flex items-center gap-1 text-sm"><input type="checkbox" name="edit-shop-days"
                                    value="Sat"> Sat</label>
                            <label class="flex items-center gap-1 text-sm"><input type="checkbox" name="edit-shop-days"
                                    value="Sun"> Sun</label>
                        </div>
                    </div>
                    <div class="mt-3">
                        <label class="text-xs font-semibold text-gray-500 uppercase">Operating Periods:</label>
                        <div class="flex flex-wrap gap-3 mt-1">
                            <label class="flex items-center gap-1 text-sm"><input type="checkbox"
                                    name="edit-shop-periods" value="morning"> Morning</label>
                            <label class="flex items-center gap-1 text-sm"><input type="checkbox"
                                    name="edit-shop-periods" value="forenoon"> Forenoon</label>
                            <label class="flex items-center gap-1 text-sm"><input type="checkbox"
                                    name="edit-shop-periods" value="afternoon"> Afternoon</label>
                            <label class="flex items-center gap-1 text-sm"><input type="checkbox"
                                    name="edit-shop-periods" value="evening"> Evening</label>
                            <label class="flex items-center gap-1 text-sm"><input type="checkbox"
                                    name="edit-shop-periods" value="night"> Night</label>
                        </div>
                    </div>
                </div>
                <!-- Alarm Settings -->
                <div class="border-t pt-4 mt-4">
                    <h5 class="font-medium mb-3">Alarm Notifications</h5>
                    <div class="space-y-3">
                        <div class="flex items-center justify-between p-2 bg-gray-50 rounded-lg">
                            <div>
                                <p class="text-sm font-medium">Kitchen Alarm (New Order)</p>
                                <p class="text-xs text-gray-500">Trigger alarm when a new order arrives.</p>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="edit-alarm-kitchen-new" class="sr-only peer" checked>
                                <div
                                    class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600">
                                </div>
                            </label>
                        </div>
                        <div class="flex items-center justify-between p-2 bg-gray-50 rounded-lg">
                            <div>
                                <p class="text-sm font-medium">Kitchen Alarm (Order Ready)</p>
                                <p class="text-xs text-gray-500">Trigger alarm when an order becomes ready.</p>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="edit-alarm-kitchen-ready" class="sr-only peer">
                                <div
                                    class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600">
                                </div>
                            </label>
                        </div>
                        <div class="flex items-center justify-between p-2 bg-gray-50 rounded-lg">
                            <div>
                                <p class="text-sm font-medium">Delivery Alarm (Order Ready)</p>
                                <p class="text-xs text-gray-500">Trigger alarm for delivery staff when ready.</p>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="edit-alarm-delivery-ready" class="sr-only peer" checked>
                                <div
                                    class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600">
                                </div>
                            </label>
                        </div>
                    </div>
                </div>
                <div class="flex gap-3 pt-2">
                    <button type="button" id="edit-shop-cancel" class="btn-secondary flex-1">Cancel</button>
                    <button type="submit" class="btn-primary flex-1 bg-blue-600 hover:bg-blue-700">Save
                        Changes</button>
                </div>
            </form>
        </div>
        <!-- **** Map Picker Modal **** -->
        <div id="map-picker-modal"
            class="hidden fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-[70] p-4">
            <div class="bg-white rounded-2xl shadow-xl p-6 sm:p-8 w-full max-w-2xl">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-gray-900">Pick Location</h2>
                    <button id="map-picker-close" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <p class="text-sm text-gray-500 mb-4">Click on the map to set the shop's location.</p>
                <div id="map-picker-container"></div>
                <div class="flex justify-between items-center bg-gray-50 p-3 rounded-lg border mb-4">
                    <div class="text-xs font-mono text-gray-600">
                        Lat: <span id="picked-lat">--</span>, Lng: <span id="picked-lng">--</span>
                    </div>
                    <button id="confirm-location-btn"
                        class="btn-primary bg-blue-600 hover:bg-blue-700 py-2 px-6">Confirm Location</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, GoogleAuthProvider, signInWithPopup, signInWithRedirect, getRedirectResult, createUserWithEmailAndPassword, signInWithEmailAndPassword, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, initializeFirestore, persistentLocalCache, persistentMultipleTabManager, collection, addDoc, onSnapshot, doc, updateDoc, query, where, serverTimestamp, getDoc, setDoc, getDocs, orderBy, deleteDoc, limit, startAfter, Timestamp, endAt, endBefore, startAt, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        import { FastOrderMonitor } from './js/fast_notify.js';
        import { NotificationManager, KitchenNotifier } from './js/notify.js';

        // // --- Fast Notification Monitor Class (Inlined to prevent 404s) ---
        // class FastOrderMonitor {
        //     constructor(db, shopId) {
        //         this.db = db;
        //         this.shopId = shopId;
        //         this.unsubscribe = null;
        //         this.audioContext = null;
        //         this.isPlaying = false;
        //         this.role = null;
        //     }

        //     // Unlock audio context on user interaction
        //     enableAudio() {
        //         if (!this.audioContext) {
        //             this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
        //         }
        //         if (this.audioContext.state === 'suspended') {
        //             this.audioContext.resume();
        //         }
        //     }

        //     playAlarm() {
        //         if (this.isPlaying || !this.audioContext) return;
        //         this.isPlaying = true;

        //         const oscillator = this.audioContext.createOscillator();
        //         const gainNode = this.audioContext.createGain();

        //         oscillator.type = 'square';
        //         oscillator.frequency.setValueAtTime(440, this.audioContext.currentTime); // A4
        //         oscillator.frequency.exponentialRampToValueAtTime(880, this.audioContext.currentTime + 0.5); // Ramp up

        //         gainNode.gain.setValueAtTime(0.5, this.audioContext.currentTime);
        //         gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 0.5);

        //         oscillator.connect(gainNode);
        //         gainNode.connect(this.audioContext.destination);

        //         oscillator.start();
        //         oscillator.stop(this.audioContext.currentTime + 0.5);

        //         // Loop alarm
        //         this.alarmInterval = setInterval(() => {
        //             if (!this.isPlaying) return;
        //             const osc = this.audioContext.createOscillator();
        //             const gn = this.audioContext.createGain();
        //             osc.type = 'square';
        //             osc.frequency.setValueAtTime(440, this.audioContext.currentTime);
        //             osc.frequency.exponentialRampToValueAtTime(880, this.audioContext.currentTime + 0.5);
        //             gn.gain.setValueAtTime(0.5, this.audioContext.currentTime);
        //             gn.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 0.5);
        //             osc.connect(gn);
        //             gn.connect(this.audioContext.destination);
        //             osc.start();
        //             osc.stop(this.audioContext.currentTime + 0.5);
        //         }, 1000);
        //     }

        //     stopAlarm() {
        //         this.isPlaying = false;
        //         if (this.alarmInterval) clearInterval(this.alarmInterval);
        //     }

        //     startListening(role) {
        //         this.role = role;
        //         // Only listen for status 'new' for kitchen/owner, and 'ready_for_pickup' for delivery
        //         let q;
        //         if (role === 'delivery') {
        //             q = query(collection(this.db, "orders"),
        //                 where("shopId", "==", this.shopId),
        //                 where("status", "==", "ready_for_pickup"));
        //         } else {
        //             q = query(collection(this.db, "orders"),
        //                 where("shopId", "==", this.shopId),
        //                 where("status", "==", "new"));
        //         }

        //         this.unsubscribe = onSnapshot(q, (snapshot) => {
        //             snapshot.docChanges().forEach((change) => {
        //                 if (change.type === "added") {
        //                     // Play sound and trigger visual alert
        //                     this.playAlarm();
        //                     window.dispatchEvent(new CustomEvent('fast-order-alert', {
        //                         detail: {
        //                             order: change.doc.data(),
        //                             title: role === 'delivery' ? 'ORDER READY' : 'NEW ORDER'
        //                         }
        //                     }));
        //                 }
        //             });
        //         });
        //     }

        //     stopListening() {
        //         if (this.unsubscribe) {
        //             this.unsubscribe();
        //             this.unsubscribe = null;
        //         }
        //         this.stopAlarm();
        //     }
        // }

        const DEVELOPER_EMAIL = "dev@example.com";
        const DEVELOPER_PASSWORD = "vrinda123456";

        // WARNING: This is a public-facing demo config. Do not use for production.
        const firebaseConfig = {
            apiKey: "AIzaSyBsmUPg2plkJS86sFkXU-QkJttJJcOj8dw",
            authDomain: "vrinda-cloud-kitchen.firebaseapp.com",
            projectId: "vrinda-cloud-kitchen",
            storageBucket: "vrinda-cloud-kitchen.firebasestorage.app",
            messagingSenderId: "166281611781",
            appId: "1:166281611781:web:5090b4106e97e08931aa6c",
        };

        let app, db, auth;
        let isFirebaseReady = false;
        let authInitialized = false;
        let notificationMgr = null;
        let kitchenNotifier = null;

        // Payment settings
        let paymentSettings = {
            onlinePaymentsEnabled: true,
            codEnabled: true
        };

        // Shop data caching
        let shopCache = {
            data: null,
            lastFetched: null
        };
        const SHOP_CACHE_TTL = 5 * 60 * 1000; // 5 minutes in milliseconds

        try {
            app = initializeApp(firebaseConfig);
            // Modern Firestore Init: Force Long Polling + Persistent Cache (v11+)
            db = initializeFirestore(app, {
                experimentalForceLongPolling: true,
                useFetchStreams: false,
                localCache: persistentLocalCache({
                    tabManager: persistentMultipleTabManager()
                })
            });

            auth = getAuth(app);
            isFirebaseReady = true;

            // Initialize Notification Managers
            notificationMgr = new NotificationManager(db, auth);
            kitchenNotifier = new KitchenNotifier();

            console.log("✅ Firebase initialized successfully");
        } catch (error) {
            console.error("❌ CRITICAL: Firebase Initialization failed.", error);
            document.body.innerHTML = `<div class="w-screen h-screen flex items-center justify-center bg-red-100 text-red-800 p-8"><strong>Application Error:</strong> Could not connect to the database.</div>`;
        }

        let userRole = 'customer';
        let userDevPermissions = []; // Granular permissions for Owners
        let userId = null;
        let userEmail = 'Guest';
        let userDisplayName = 'Guest';
        let userPhotoURL = null;
        let currentUserShopId = null;
        let currentUserShopIds = []; // For delivery staff multi-shop support
        let currentShopName = null;
        let fastMonitor = null; // FastOrderMonitor instance

        let cart = [];
        let staffCart = [];
        let currentTrackingOrderId = null;
        let isEditingOrder = false;
        let currentOrderListener = null;

        let salesChartInstance = null;
        let statusChartInstance = null;
        let completedOrders = [];
        let historyFilter = 'week';

        let allUsersCache = [];
        let userSortCriteria = 'email';
        let userSortDirection = 'asc';
        let orderDateFilter = 'all';
        let orderQueryLimit = 10;
        let orderFirstVisibleDoc = null;
        let orderLastVisibleDoc = null;
        let orderCurrentPage = 1;
        let orderQueryUnsubscribe = null;

        let allShops = [];
        let currentMenu = [];
        let allMenuItems = []; // Global menu items from all shops for search
        let selectedShopId = null;
        let isShopCurrentlyClosed = false; // Track if selected shop is closed
        const DAYS_OF_WEEK = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

        // --- Notification variables ---
        let allNotifications = [];
        let notificationListener = null;
        // --- END Notification variables ---

        const authBtn = document.getElementById('user-auth-btn');
        const authStatusEl = document.getElementById('auth-status');
        const alertModal = document.getElementById('alert-modal');
        const alertMessage = document.getElementById('alert-message');
        const alertClose = document.getElementById('alert-close');
        const alertIcon = document.getElementById('alert-icon');
        const alertButtonsDiv = document.getElementById('alert-buttons');
        const alertConfirmBtn = document.getElementById('alert-confirm');
        const alertCancelBtn = document.getElementById('alert-cancel');
        const createOrderModal = document.getElementById('create-order-modal');
        const viewSwitcher = document.getElementById('view-switcher');
        const views = {
            customer: document.getElementById('customer-view'),
            kitchen: document.getElementById('kitchen-view'),
            transport: document.getElementById('transport-view'),
            owner: document.getElementById('owner-view'),
            developer: document.getElementById('developer-view'),
        };
        const prevOrdersBtn = document.getElementById('prev-orders-btn');
        const nextOrdersBtn = document.getElementById('next-orders-btn');
        const orderPageInfoEl = document.getElementById('order-page-info');

        let currentConfirmCallback = null;
        const showAlert = (message, isError = false, confirmCallback = null) => {
            alertMessage.textContent = message;
            currentConfirmCallback = confirmCallback;

            if (confirmCallback) {
                alertIcon.innerHTML = `<svg class="w-7 h-7 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>`;
                alertIcon.className = `w-14 h-14 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-4`;
                alertClose.classList.add('hidden');
                alertConfirmBtn.classList.remove('hidden');
                alertCancelBtn.classList.remove('hidden');
            } else {
                alertIcon.innerHTML = isError
                    ? `<svg class="w-7 h-7 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`
                    : `<svg class="w-7 h-7 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"></path></svg>`;
                alertIcon.className = `w-14 h-14 ${isError ? 'bg-red-100' : 'bg-green-100'} rounded-full flex items-center justify-center mx-auto mb-4`;
                alertClose.classList.remove('hidden');
                alertConfirmBtn.classList.add('hidden');
                alertCancelBtn.classList.add('hidden');
            }
            alertModal.classList.remove('hidden');
        }

        alertClose.addEventListener('click', () => alertModal.classList.add('hidden'));
        alertCancelBtn.addEventListener('click', () => alertModal.classList.add('hidden'));
        alertConfirmBtn.addEventListener('click', async () => {
            if (typeof currentConfirmCallback === 'function') {
                // Bug fix: Must await the callback if it's an async function
                await currentConfirmCallback();
            }
            alertModal.classList.add('hidden');
            currentConfirmCallback = null;
        });

        document.getElementById('create-order-close-btn').addEventListener('click', () => createOrderModal.classList.add('hidden'));
        document.getElementById('create-order-btn').addEventListener('click', () => {
            if (!currentUserShopId) {
                const msg = (userRole === 'developer') ? "Please select a shop from the Dev Panel first." : "You must be assigned to a shop to create orders.";
                return showAlert(msg, true);
            }
            renderCreateOrderModal(currentUserShopId);
            createOrderModal.classList.remove('hidden');
        });

        // --- Profile/Login Modal Logic (openProfileModal function fix for mobile notification) ---
        function openProfileModal(isForced = false) {
            const profileModal = document.getElementById('profile-modal');
            const profileContent = document.getElementById('profile-content');
            if (!profileModal || !profileContent) return;

            // Fix: Ensure notification panel is closed when opening profile/login modal
            document.getElementById('notification-panel').classList.add('hidden');

            if (!auth.currentUser || auth.currentUser.isAnonymous) {
                profileContent.innerHTML = `
                    <form id="email-auth-form" class="space-y-4">
                        <h3 class="text-xl font-semibold">${isForced ? 'Login Required' : 'Login'}</h3>
                        ${isForced ? '<p class="text-red-500 text-sm mb-4">You need to log in to place an order.</p>' : ''}
                        <div><label class="block text-sm">Email</label><input type="email" id="auth-email" class="w-full" required></div>
                        <div><label class="block text-sm">Password</label><input type="password" id="auth-password" class="w-full" required></div>
                        <button type="submit" id="login-btn" class="btn-primary w-full">Login</button>
                    </form>
                    <div class="relative my-6"><div class="absolute inset-0 flex items-center"><span class="w-full border-t"></span></div><div class="relative flex justify-center text-sm"><span class="bg-white px-2 text-gray-500">OR</span></div></div>
                    <button type="button" id="google-login-btn" class="btn-primary w-full bg-white text-gray-700 border border-gray-300 hover:bg-gray-50 flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611 20.083H42V20H24v8h11.303c-1.649 4.657-6.08 8-11.303 8c-6.627 0-12-5.373-12-12s5.373-12 12-12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C12.955 4 4 12.955 4 24s8.955 20 20 20s20-8.955 20-20c0-1.341-.138-2.65-.389-3.917z"></path><path fill="#FF3D00" d="M6.306 14.691l6.571 4.819C14.655 15.108 18.961 12 24 12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C16.318 4 9.656 8.337 6.306 14.691z"></path><path fill="#4CAF50" d="M24 44c5.166 0 9.86-1.977 13.409-5.192l-6.19-5.238C29.211 35.091 26.715 36 24 36c-5.202 0-9.619-3.317-11.283-7.946l-6.522 5.025C9.505 39.556 16.227 44 24 44z"></path><path fill="#1976D2" d="M43.611 20.083H42V20H24v8h11.303c-.792 2.237-2.231 4.166-4.087 5.571l6.19 5.238C42.012 36.49 44 30.65 44 24c0-1.341-.138-2.65-.389-3.917z"></path></svg>
                        Continue with Google
                    </button>
                `;
            } else {
                let shopInfo = currentUserShopId ? `Shop: ${currentShopName || currentUserShopId.substring(0, 6)}` : 'No shop assigned';
                if (userRole === 'customer' || (userRole === 'developer' && !currentShopName)) shopInfo = '';

                const avatarHTML = userPhotoURL
                    ? `<img src="${userPhotoURL}" alt="${userDisplayName}" class="w-20 h-20 rounded-full object-cover border-4 border-gray-100 shadow-md">`
                    : `<div class="w-20 h-20 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-white text-3xl font-bold shadow-md">${(userDisplayName === 'Guest' ? 'V' : userDisplayName.charAt(0)).toUpperCase()}</div>`;

                profileContent.innerHTML = `
                    <div class="flex flex-col items-center text-center mb-4">
                        ${avatarHTML}
                        <h3 class="text-xl font-semibold mt-3">${userDisplayName}</h3>
                        <p class="text-sm text-gray-500">${userEmail}</p>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-3 mb-4">
                        <p class="text-sm"><span class="text-gray-500">Role:</span> <span class="capitalize font-medium">${userRole}</span></p>
                        ${shopInfo ? `<p class="text-sm mt-1"><span class="text-gray-500">Shop:</span> <span class="font-medium">${currentShopName || currentUserShopId.substring(0, 6)}</span></p>` : ''}
                    </div>
                    <button id="logout-btn" class="btn-primary w-full bg-red-600 hover:bg-red-700">Logout</button>
                `;
            }

            const form = document.getElementById('email-auth-form');
            if (form) {
                form.addEventListener('submit', e => handleEmailAuth(e, false));
            }
            document.getElementById('google-login-btn')?.addEventListener('click', handleGoogleLogin);
            document.getElementById('logout-btn')?.addEventListener('click', () => {
                signOut(auth);
                profileModal.classList.add('hidden');
                cart = [];
                selectedShopId = null;
                currentUserShopId = null;
                currentShopName = null;
                showShopSelector();
            });

            profileModal.classList.remove('hidden');
        }

        authBtn.addEventListener('click', () => openProfileModal(false));
        // --- END Profile/Login Modal Logic ---

        document.getElementById('profile-close').addEventListener('click', () => document.getElementById('profile-modal').classList.add('hidden'));

        async function loadAllShops(forceRefresh = false) {
            // Check cache
            const now = Date.now();
            if (!forceRefresh && shopCache.data && shopCache.lastFetched && (now - shopCache.lastFetched < SHOP_CACHE_TTL)) {
                console.log('Using cached shop data (TTL: 5m)');
                allShops = shopCache.data;
                renderShopSelector();
                if (userRole === 'developer') {
                    populateShopDropdowns();
                    renderDevShopList();
                    populateScheduleSelect();
                }
                updateDevSummary();
                return;
            }

            try {
                console.log('Fetching shops from Firestore...');
                const snapshot = await getDocs(collection(db, "shops"));
                allShops = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                // Update cache
                shopCache.data = allShops;
                shopCache.lastFetched = now;

                console.log('Loaded shops:', allShops);
                renderShopSelector();
                if (userRole === 'developer') {
                    populateShopDropdowns();
                    renderDevShopList();
                    populateScheduleSelect();
                }
                updateDevSummary();
                // Load all menu items for search
                await loadAllMenuItems();
                // Initialize customer search
                setupCustomerSearchFunctionality();
                // Initialize unified search
                setupUnifiedSearch();
            } catch (error) {
                // --- MODIFICATION: Improved console and UI error reporting ---
                console.error("❌ CRITICAL FIREBASE ERROR: Failed to load shops or check rules. This usually means your Firestore Security Rules are blocking access for anonymous users.", error);
                showAlert("Could not load kitchens. Please check the Developer Console for errors (likely a database permission issue).", true);
                // --- END MODIFICATION ---
            }
        }

        async function loadAllMenuItems() {
            try {
                const menuSnapshot = await getDocs(collection(db, "menus"));
                allMenuItems = menuSnapshot.docs.map(doc => {
                    const data = doc.data();
                    // Include shop info for better search results
                    const shop = allShops.find(s => s.id === data.shopId);
                    return {
                        id: doc.id,
                        ...data,
                        shopName: shop?.name || 'Unknown Shop'
                    };
                });
                console.log('Loaded all menu items:', allMenuItems.length);
            } catch (error) {
                console.error("Error loading menu items:", error);
            }
        }

        async function setupUser(user) {
            authInitialized = true;
            currentUserShopId = null;
            currentShopName = null;

            if (user) {
                userId = user.uid;
                userEmail = user.email || 'Guest';
                userDisplayName = user.displayName || (user.email ? user.email.split('@')[0] : 'Guest');
                userPhotoURL = user.photoURL || null;

                if (user.isAnonymous) {
                    userRole = 'customer';
                    userEmail = 'Guest';
                    userDisplayName = 'Guest';
                    userPhotoURL = null;
                    // FIX: Removed the following check to stop repetitive login prompts on app load.
                    // if (authInitialized) { openProfileModal(true); } 
                } else if (user.email === DEVELOPER_EMAIL) {
                    userRole = 'developer';
                    await setDoc(doc(db, "users", userId), { email: user.email, role: 'developer' }, { merge: true });
                } else {
                    const userDocSnap = await getDoc(doc(db, "users", userId));
                    if (userDocSnap.exists()) {
                        const userData = userDocSnap.data();
                        userRole = userData.role || 'customer';
                        userDevPermissions = userData.devPermissions || [];
                        currentUserShopId = userData.shopId || null;

                        // Handle delivery staff with multiple shops
                        if (userRole === 'delivery' && userData.shopIds && userData.shopIds.length > 0) {
                            currentUserShopIds = userData.shopIds;
                            currentUserShopId = userData.shopIds[0]; // Use first shop as primary
                        } else {
                            currentUserShopIds = currentUserShopId ? [currentUserShopId] : [];
                        }

                        if (currentUserShopId) {
                            if (allShops.length === 0) await loadAllShops();
                            const shop = allShops.find(s => s.id === currentUserShopId);
                            if (shop) {
                                currentShopName = shop.name;
                                // For delivery with multiple shops, show count
                                if (userRole === 'delivery' && currentUserShopIds.length > 1) {
                                    currentShopName = `${currentUserShopIds.length} Shops`;
                                }
                            } else {
                                const shopDoc = await getDoc(doc(db, "shops", currentUserShopId));
                                if (shopDoc.exists()) currentShopName = shopDoc.data().name;
                            }
                        }
                    } else {
                        // NEW: Automatic Linking for Pre-created records
                        // Search by email to see if a pre-created record exists
                        const q = query(collection(db, "users"), where("email", "==", user.email), where("isPreCreated", "==", true));
                        const preCreatedSnap = await getDocs(q);

                        if (!preCreatedSnap.empty) {
                            const preCreatedDoc = preCreatedSnap.docs[0];
                            const preCreatedData = preCreatedDoc.data();

                            // Create new authoritative doc at user.uid
                            await setDoc(doc(db, "users", userId), {
                                ...preCreatedData,
                                uid: userId,
                                isPreCreated: false, // Now it's a real user
                                linkedAt: serverTimestamp()
                            });

                            // Delete the temporary pre-created doc
                            await deleteDoc(preCreatedDoc.ref);

                            userRole = preCreatedData.role || 'customer';
                            currentUserShopId = preCreatedData.shopId || null;
                            showAlert(`Welcome! Your staff account has been linked successfully.`, false);
                        } else {
                            userRole = 'customer';
                            await setDoc(doc(db, "users", userId), {
                                email: user.email,
                                displayName: user.displayName || user.email.split('@')[0],
                                role: 'customer',
                                createdAt: serverTimestamp()
                            });
                        }
                    }
                }
            } else {
                // Bug Fix: If no user is present (e.g. initial load if anonymous sign-in failed/not configured), sign in anonymously.
                if (isFirebaseReady) {
                    try {
                        const anonUser = await signInAnonymously(auth);
                        userId = anonUser.user.uid;
                    } catch (e) {
                        // Fallback in case of auth failure
                        userId = 'offline-guest-' + Math.random().toString(36).substring(2, 9);
                    }
                } else {
                    userId = 'offline-guest-' + Math.random().toString(36).substring(2, 9);
                }
                userEmail = 'Guest (Offline)';
                userDisplayName = 'Guest';
                userPhotoURL = null;
                userRole = 'customer';
            }

            updateAuthStatusUI();
            updateVisibleViews();
            renderCustomerUI();
            listenForNotifications(); // Start listening for notifications

            // Start the real-time listener for payment settings (Global)
            initPaymentSettingsListener();

            if (user) {
                if (currentUserShopId) {
                    if (['owner', 'developer'].includes(userRole)) { loadOwnerDashboard(); listenToOrderHistory(); }
                    if (['kitchen', 'delivery', 'owner', 'developer'].includes(userRole)) { listenToStaffOrders(); }

                    document.getElementById('kitchen-view-title').textContent = currentShopName || 'Kitchen';
                    document.getElementById('transport-view-title').textContent = currentShopName || 'Delivery';
                    document.getElementById('owner-view-title').textContent = currentShopName ? `${currentShopName} - Dashboard` : 'Owner Dashboard';

                    // --- Initialize Fast Monitor for Kitchen/Owner/Delivery ---
                    if (['kitchen', 'owner', 'delivery', 'developer'].includes(userRole)) {
                        initFastNotification(currentUserShopId, userRole);
                    }

                } else if (userRole !== 'customer' && userRole !== 'developer') {
                    showAlert("You are not assigned to a shop. Please contact the developer.", true);
                }

                if (userRole === 'developer') {
                    await loadDeveloperPanel();
                    runSystemTests();
                    updateDevSummary();
                }
            }
        }

        if (isFirebaseReady) {
            await loadAllShops();

            // Initial check to see if a user is already authenticated (e.g., from a previous session)
            const unsubscribe = onAuthStateChanged(auth, async (user) => {
                await setupUser(user);
                unsubscribe(); // Stop the initial listener

                // Set up a permanent listener for real-time auth changes
                onAuthStateChanged(auth, async (user) => {
                    // Only re-run setup if the user object changed after initialization
                    if (authInitialized) await setupUser(user);
                });
            });

            // Wire up payment toggle event listeners globally
            const onlineToggle = document.getElementById('toggle-online-payments');
            const codToggle = document.getElementById('toggle-cod');

            if (onlineToggle) {
                onlineToggle.addEventListener('change', (e) => {
                    updatePaymentSetting('online', e.target.checked);
                });
            }

            if (codToggle) {
                codToggle.addEventListener('change', (e) => {
                    updatePaymentSetting('cod', e.target.checked);
                });
            }
        }

        // --- FAST NOTIFICATION INIT ---
        function initFastNotification(shopId, role) {
            if (fastMonitor) fastMonitor.stopListening();

            fastMonitor = new FastOrderMonitor(db, shopId);
            fastMonitor.startListening(role); // Pass role to monitor

            // Smart Audio Unlock: Unlock on ANY user interaction
            const unlockAudio = async () => {
                console.log("🔓 Unlocking audio and requesting notifications...");

                // 1. Request Notification Permission
                if ("Notification" in window && Notification.permission === "default") {
                    try {
                        const permission = await Notification.requestPermission();
                        console.log("System Notification Permission:", permission);
                    } catch (e) { console.error("Permission request failed", e); }
                }

                if (fastMonitor) {
                    fastMonitor.enableAudio();
                    // Hide the button once audio is unlocked
                    const audioBtn = document.getElementById('enable-audio-btn');
                    if (audioBtn) audioBtn.classList.add('hidden');
                }

                // Remove listeners once unlocked to avoid redundant calls
                document.removeEventListener('click', unlockAudio);
                document.removeEventListener('touchstart', unlockAudio);
                document.removeEventListener('keydown', unlockAudio);
            };

            // Add global listeners for any user interaction
            document.addEventListener('click', unlockAudio, { once: true });
            document.addEventListener('touchstart', unlockAudio, { once: true });
            document.addEventListener('keydown', unlockAudio, { once: true });



            // Show button as visual feedback (will auto-hide on first interaction)
            const audioBtn = document.getElementById('enable-audio-btn');
            if (audioBtn) {
                audioBtn.classList.remove('hidden');
                audioBtn.addEventListener('click', (e) => {
                    e.stopPropagation(); // Prevent double firing
                    unlockAudio();
                }, { once: true });
            }

            // Listen for the Alert Event
            window.addEventListener('fast-order-alert', (e) => {
                const { order, title } = e.detail;
                // Show Global Stop Button

                // Determine which stop button to show based on role
                let stopBtn, stopText;

                if (role === 'delivery') {
                    stopBtn = document.getElementById('global-stop-alarm-btn-delivery');
                    stopText = document.getElementById('global-stop-alarm-text-delivery');
                } else {
                    stopBtn = document.getElementById('global-stop-alarm-btn');
                    stopText = document.getElementById('global-stop-alarm-text');
                }

                if (stopBtn && stopText) {
                    stopText.textContent = `STOP ALARM (${title || 'NEW ALERT'})`;
                    stopBtn.classList.remove('hidden');

                    // When clicked, stop alarm and hide button
                    stopBtn.onclick = () => {
                        fastMonitor.stopAlarm();
                        stopBtn.classList.add('hidden');

                        // Switch to appropriate view based on role
                        if (role === 'delivery') {
                            const transportBtn = document.querySelector('[data-view="transport"]');
                            if (transportBtn) transportBtn.click();
                        } else {
                            const kitchenBtn = document.querySelector('[data-view="kitchen"]');
                            if (kitchenBtn) kitchenBtn.click();
                        }
                    };
                }
            });

            console.log(`FastOrderMonitor initialized for shop: ${shopId}, role: ${role}`);
        }

        function updateAuthStatusUI() {
            const avatarImg = document.getElementById('auth-avatar-img');
            const avatarText = document.getElementById('auth-avatar-text');

            // Update avatar
            if (userPhotoURL) {
                avatarImg.src = userPhotoURL;
                avatarImg.classList.remove('hidden');
                avatarText.classList.add('hidden');
            } else {
                avatarImg.classList.add('hidden');
                avatarText.classList.remove('hidden');
                // Show first letter of display name
                const firstLetter = (userDisplayName && userDisplayName !== 'Guest')
                    ? userDisplayName.charAt(0).toUpperCase()
                    : 'V';
                avatarText.textContent = firstLetter;
            }

            // Update status text - show display name and role
            let statusText = 'Guest';
            if (userDisplayName !== 'Guest' && !userEmail.includes('Offline')) {
                statusText = `${userDisplayName} (${userRole})`;
            }
            authStatusEl.textContent = statusText;
            authBtn.textContent = (userEmail === 'Guest' || userEmail.includes('Offline')) ? 'Login' : 'Profile';

            let subtitle = 'Find your favorite local kitchens';
            if (currentShopName) {
                if (userRole === 'developer') {
                    subtitle = `Dev View: ${currentShopName}`;
                } else if (userRole === 'customer') {
                    subtitle = `Ordering from ${currentShopName}`;
                } else {
                    subtitle = `Managing: ${currentShopName}`;
                }
            }
            document.getElementById('header-subtitle').textContent = subtitle;
        }

        function updateVisibleViews() {
            // Bug Fix: Only hide the view switcher if the current user is ONLY a customer
            const isPureCustomer = userRole === 'customer' && !currentUserShopId && userEmail !== DEVELOPER_EMAIL;
            viewSwitcher.classList.toggle('hidden', isPureCustomer && userDevPermissions.length === 0);

            // Show My Orders button for logged-in customers
            const myOrdersBtn = document.getElementById('my-orders-btn');
            if (myOrdersBtn) {
                const isLoggedInCustomer = !auth.currentUser?.isAnonymous && userRole === 'customer';
                myOrdersBtn.classList.toggle('hidden', !isLoggedInCustomer);
            }

            const isDev = userRole === 'developer';

            // RBAC Logic: 
            // - Dev Panel is strictly for developers
            // - Kitchen is for kitchen staff, owners, and developers
            // - Transport (Delivery) is for delivery staff and developers only
            // - Dashboard (Owner) is for owners and developers
            const canSeeDevPanel = isDev;
            const canSeeKitchen = isDev || (['kitchen', 'owner'].includes(userRole) && currentUserShopId);
            const canSeeTransport = isDev || (userRole === 'delivery' && currentUserShopId);
            const canSeeOwner = isDev || (userRole === 'owner' && currentUserShopId);

            document.querySelector('[data-view="kitchen"]').classList.toggle('hidden', !canSeeKitchen);
            document.querySelector('[data-view="transport"]').classList.toggle('hidden', !canSeeTransport);
            document.querySelector('[data-view="owner"]').classList.toggle('hidden', !canSeeOwner);
            document.querySelector('[data-view="developer"]').classList.toggle('hidden', !canSeeDevPanel);

            // Set nav item visibility
            const navDev = document.getElementById('nav-developer');
            if (navDev) navDev.classList.toggle('hidden', !canSeeDevPanel);

            // Granular Developer Section Visibility
            if (canSeeDevPanel) {
                const sections = ['summary', 'payments', 'shops', 'users', 'menu', 'tools'];
                sections.forEach(s => {
                    const el = document.getElementById(`dev-section-${s}`);
                    if (el) {
                        // Show if user is developer OR has specific permission
                        const hasPerm = isDev || userDevPermissions.includes(s);
                        el.classList.toggle('hidden', !hasPerm);
                    }
                });
            }

            if (!canSeeKitchen && !canSeeTransport && !canSeeOwner && !canSeeDevPanel) {
                if (document.querySelector('[data-view="customer"]')) {
                    Array.from(viewSwitcher.querySelectorAll('button')).forEach(btn => btn.classList.remove('btn-active'));
                    document.querySelector('[data-view="customer"]').classList.add('btn-active');
                }
            }
        }

        // --- Customer View Logic ---

        function renderCustomerUI() {
            renderOrderForm();
            startTrackingLatestOrder();
            showShopSelector();
        }

        // --- SHOP SCHEDULE CHECKER ---
        function isShopOpen(schedule) {
            if (!schedule || !schedule.openTime || !schedule.closeTime || !schedule.daysOpen || schedule.daysOpen.length === 0) {
                // Default: Always open if schedule isn't set
                return true;
            }

            const now = new Date();
            const currentDay = DAYS_OF_WEEK[now.getDay()]; // Sun (0) -> 'Sun'

            // Check if shop is open today
            if (!schedule.daysOpen.includes(currentDay)) {
                return false;
            }

            // --- CRITICAL FIX: Use Local Time instead of UTC ---
            // Previously used getUTCHours()/getUTCMinutes(), which caused time mismatches (e.g., IST vs UTC)
            const currentHours = now.getHours();
            const currentMinutes = now.getMinutes();
            const currentTimeInMinutes = currentHours * 60 + currentMinutes;

            // Convert schedule times (e.g., "09:00") to minutes from midnight
            const [openHour, openMinute] = schedule.openTime.split(':').map(Number);
            const [closeHour, closeMinute] = schedule.closeTime.split(':').map(Number);

            const openTimeInMinutes = openHour * 60 + openMinute;
            const closeTimeInMinutes = closeHour * 60 + closeMinute;

            if (openTimeInMinutes < closeTimeInMinutes) {
                // Simple case: 09:00 to 23:00 (within the same day)
                return currentTimeInMinutes >= openTimeInMinutes && currentTimeInMinutes < closeTimeInMinutes;
            } else {
                // Complex case: overnight shift, e.g., 23:00 to 05:00
                return currentTimeInMinutes >= openTimeInMinutes || currentTimeInMinutes < closeTimeInMinutes;
            }
        }

        function renderShopSelector() {
            const container = document.getElementById('shop-list-container');
            if (!container) return;
            if (allShops.length === 0) {
                container.innerHTML = '<p class="text-gray-500 col-span-full text-center">No kitchens are currently available. This might be because the database is empty or security rules are blocking access.</p>';
                return;
            }

            container.innerHTML = allShops.map(shop => {
                const isOpen = isShopOpen(shop.schedule);
                const statusTag = isOpen
                    ? `<span class="tag-open px-2 py-0.5 rounded-full text-xs font-semibold">OPEN</span>`
                    : `<span class="tag-closed px-2 py-0.5 rounded-full text-xs font-semibold">CLOSED</span>`;

                const schedule = shop.schedule || {};
                const timeTag = (schedule.openTime && schedule.closeTime) ?
                    `<span class="tag-schedule px-2 py-0.5 rounded-full text-xs font-medium">${schedule.openTime} - ${schedule.closeTime} (${schedule.daysOpen ? schedule.daysOpen.join('/') : 'Everyday'})</span>` :
                    '';

                return `
                    <div class="shop-card card p-0 cursor-pointer ${isOpen ? '' : 'opacity-60'}" data-shop-id="${shop.id}" data-shop-name="${shop.name}">
                        <div class="relative w-full h-40 bg-gray-200 overflow-hidden">
                            <img src="${shop.image || 'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22600%22 height=%22400%22%3E%3Crect fill=%22%23e5e7eb%22 width=%22600%22 height=%22400%22/%3E%3Ctext fill=%22%23999%22 font-family=%22sans-serif%22 font-size=%2224%22 x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 dominant-baseline=%22middle%22%3EShop%3C/text%3E%3C/svg%3E'}" 
                                alt="${shop.name}" 
                                class="w-full h-full object-cover" 
                                loading="lazy"
                                onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22600%22 height=%22400%22%3E%3Crect fill=%22%23e5e7eb%22 width=%22600%22 height=%22400%22/%3E%3Ctext fill=%22%23999%22 font-family=%22sans-serif%22 font-size=%2224%22 x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 dominant-baseline=%22middle%22%3EImage%3C/text%3E%3C/svg%3E'">
                        </div>
                        <div class="p-5">
                            <h3 class="text-lg font-semibold">${shop.name}</h3>
                            <p class="text-gray-600 text-sm mb-3">${shop.address || 'No address provided'}</p>
                            <div class="flex flex-wrap gap-2">${statusTag} ${timeTag}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        document.getElementById('shop-list-container').addEventListener('click', (e) => {
            const card = e.target.closest('.shop-card');
            if (card) {
                selectShop(card.dataset.shopId, card.dataset.shopName);
            }
        });

        document.getElementById('back-to-shops').addEventListener('click', showShopSelector);
        document.getElementById('back-to-shops-from-history').addEventListener('click', showShopSelector);
        document.getElementById('my-orders-btn').addEventListener('click', showCustomerOrderHistory);

        function showShopSelector() {
            document.getElementById('shop-selector-view').style.display = 'block';
            document.getElementById('menu-and-cart-view').style.display = 'none';
            document.getElementById('order-history-view').style.display = 'none';
            selectedShopId = null;
            currentMenu = [];
            cart = [];
            updateCart();
            if (userRole === 'customer') {
                document.getElementById('header-subtitle').textContent = 'Find your favorite local kitchens';
            }
        }

        async function selectShop(shopId, shopName) {
            selectedShopId = shopId;
            document.getElementById('shop-selector-view').style.display = 'none';
            document.getElementById('menu-and-cart-view').style.display = 'block';
            document.getElementById('menu-shop-name').textContent = shopName;
            if (userRole === 'customer') {
                document.getElementById('header-subtitle').textContent = `Ordering from ${shopName}`;
            }

            // Check closure status and set global flag
            const shop = allShops.find(s => s.id === shopId);
            isShopCurrentlyClosed = shop ? !isShopOpen(shop.schedule) : false;

            if (isShopCurrentlyClosed) {
                // If closed, clear cart and disable ordering elements
                cart = [];
                updateCart();
                // Alert removed - UI will show disabled buttons instead
            }

            await renderMenu(shopId);
        }

        async function showCustomerOrderHistory() {
            // Check if user is logged in
            if (!userId || userId.startsWith('offline') || auth.currentUser?.isAnonymous) {
                showAlert('Please log in to view your order history.', true);
                openProfileModal(true);
                return;
            }

            // Show order history view
            document.getElementById('shop-selector-view').style.display = 'none';
            document.getElementById('menu-and-cart-view').style.display = 'none';
            document.getElementById('order-history-view').style.display = 'block';

            const container = document.getElementById('customer-order-list');
            container.innerHTML = '<p class="text-gray-500 text-center py-12">Loading your orders...</p>';

            try {
                // Subscribe to user orders in real-time
                const ordersQuery = query(
                    collection(db, "orders"),
                    where("userId", "==", userId)
                );

                onSnapshot(ordersQuery, (snapshot) => {
                    const orders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))
                        .sort((a, b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0));

                    if (orders.length === 0) {
                        container.innerHTML = `
                            <div class="text-center py-12">
                                <svg class="w-20 h-20 mx-auto text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                                </svg>
                                <h3 class="text-xl font-semibold text-gray-700 mb-2">No Orders Yet</h3>
                                <p class="text-gray-500">Your order history will appear here once you place an order.</p>
                            </div>
                        `;
                        return;
                    }

                    container.innerHTML = orders.map(order => {
                        const date = order.createdAt?.toDate();
                        const formattedDate = date ? new Intl.DateTimeFormat('en-IN', {
                            month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
                        }).format(date) : 'Date N/A';

                        const shopName = allShops.find(s => s.id === order.shopId)?.name || 'Unknown Shop';
                        const itemCount = order.items?.reduce((sum, item) => sum + (item.quantity || 1), 0) || 0;

                        return `
                            <div class="card p-4 cursor-pointer hover:shadow-lg transition-all" onclick="viewOrderTracking('${order.id}')">
                                <div class="flex justify-between items-start mb-3">
                                    <div>
                                        <h4 class="font-bold text-gray-900">${shopName}</h4>
                                        <p class="text-xs text-gray-500">${formattedDate}</p>
                                    </div>
                                    <span class="status-tag status-tag-${order.status}">${order.status.replace(/_/g, ' ')}</span>
                                </div>
                                <p class="text-sm text-gray-600 mb-2">${itemCount} item${itemCount > 1 ? 's' : ''}</p>
                                <div class="flex justify-between items-center pt-2 border-t">
                                    <span class="text-lg font-bold text-gray-900">₹${order.totalAmount}</span>
                                    ${order.paymentMethod === 'cash' ? '<span class="cash-badge">💵 CASH</span>' : '<span class="text-xs text-green-600">✓ Paid Online</span>'}
                                </div>
                            </div>
                        `;
                    }).join('');
                }, (error) => {
                    console.error('Error loading orders:', error);
                    container.innerHTML = '<p class="text-red-500 text-center py-12">Failed to load orders. Please try again.</p>';
                });
            } catch (error) {
                console.error('Error in showCustomerOrderHistory:', error);
                container.innerHTML = '<p class="text-red-500 text-center py-12">Failed to load orders. Please try again.</p>';
            }
        }

        function viewOrderTracking(orderId) {
            currentTrackingOrderId = orderId;
            startTrackingLatestOrder();
        }

        async function renderMenu(shopId) {
            const container = document.getElementById('menu-items');
            if (!container) return;
            container.innerHTML = '<p class="text-gray-500">Loading menu...</p>';

            try {
                const menuSnapshot = await getDocs(query(collection(db, "menus"), where("shopId", "==", shopId)));
                currentMenu = menuSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                if (currentMenu.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 col-span-full text-center">This kitchen has not set up its menu yet.</p>';
                    return;
                }

                container.innerHTML = '';
                currentMenu.forEach(item => {
                    const cartItem = cart.find(ci => ci.id === item.id);
                    let buttonHTML;

                    if (isShopCurrentlyClosed) {
                        buttonHTML = `<button disabled class="mt-4 btn-danger w-full opacity-70">CLOSED</button>`;
                    } else if (cartItem) {
                        buttonHTML = `
                            <div class="quantity-selector mt-4">
                                <button class="quantity-btn quantity-minus" data-id="${item.id}">-</button>
                                <span class="quantity-display">${cartItem.quantity}</span>
                                <button class="quantity-btn quantity-plus" data-id="${item.id}">+</button>
                            </div>
                        `;
                    } else {
                        buttonHTML = `<button data-id="${item.id}" class="add-to-cart-btn mt-4 btn-primary w-full">Add to Cart</button>`;
                    }

                    container.innerHTML += `
                        <div class="menu-item card p-0">
                            <div class="relative w-full h-40 bg-gray-200 overflow-hidden">
                                <img src="${item.image || 'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22600%22 height=%22400%22%3E%3Crect fill=%22%23e5e7eb%22 width=%22600%22 height=%22400%22/%3E%3Ctext fill=%22%23999%22 font-family=%22sans-serif%22 font-size=%2224%22 x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 dominant-baseline=%22middle%22%3EItem%3C/text%3E%3C/svg%3E'}" 
                                     alt="${item.name}" 
                                     class="w-full h-full object-cover" 
                                     loading="lazy"
                                     onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22600%22 height=%22400%22%3E%3Crect fill=%22%23e5e7eb%22 width=%22600%22 height=%22400%22/%3E%3Ctext fill=%22%23999%22 font-family=%22sans-serif%22 font-size=%2224%22 x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 dominant-baseline=%22middle%22%3EImage%3C/text%3E%3C/svg%3E'">
                            </div>
                            <div class="p-5">
                                <h3 class="text-lg font-semibold">${item.name}</h3>
                                <p class="text-gray-600">₹${item.price}</p>
                                ${buttonHTML}
                            </div>
                        </div>`;
                });
            } catch (error) {
                console.error("Error loading menu:", error);
                container.innerHTML = '<p class="text-red-500">Could not load menu.</p>';
            }

            // Re-render order form to disable it if necessary
            renderOrderForm(null, isShopCurrentlyClosed);

            // Reset and initialize menu search
            originalMenuItems = [...currentMenu];
            setupCustomerSearchFunctionality();
        }


        // ============ PAYMENT SETTINGS ============
        let paymentSettingsListener = null;

        function initPaymentSettingsListener() {
            if (paymentSettingsListener) return; // Already listening

            const settingsRef = doc(db, "settings", "paymentConfig");
            paymentSettingsListener = onSnapshot(settingsRef, (settingsDoc) => {
                if (settingsDoc.exists()) {
                    const data = settingsDoc.data();
                    paymentSettings.onlinePaymentsEnabled = data.onlinePaymentsEnabled !== false;
                    paymentSettings.codEnabled = data.codEnabled !== false;
                }

                updatePaymentToggles();

                // If shop menu is open, re-render order form to show/hide methods
                if (selectedShopId && document.getElementById('order-form')) {
                    renderOrderForm(null, isShopCurrentlyClosed);
                }
            }, (error) => {
                console.error('Error listening to payment settings:', error);
            });
        }

        async function updatePaymentSetting(type, enabled) {
            try {
                const settingsRef = doc(db, "settings", "paymentConfig");
                const updateData = {
                    [type === 'online' ? 'onlinePaymentsEnabled' : 'codEnabled']: enabled,
                    updatedAt: serverTimestamp(),
                    updatedBy: userId || 'system'
                };

                // Use setDoc with merge to create document if it doesn't exist
                await setDoc(settingsRef, updateData, { merge: true });
                paymentSettings[type === 'online' ? 'onlinePaymentsEnabled' : 'codEnabled'] = enabled;

                updatePaymentToggles();
                showAlert(`${type === 'online' ? 'Online payments' : 'Cash on Delivery'} ${enabled ? 'enabled' : 'disabled'} successfully.`);
            } catch (error) {
                console.error('Error updating payment setting:', error);
                showAlert('Failed to update payment settings: ' + error.message, true);
            }
        }

        function updatePaymentToggles() {
            const onlineToggle = document.getElementById('toggle-online-payments');
            const codToggle = document.getElementById('toggle-cod');
            const onlineStatus = document.getElementById('online-payment-status');
            const codStatus = document.getElementById('cod-status');

            if (onlineToggle) {
                onlineToggle.checked = paymentSettings.onlinePaymentsEnabled;
                if (onlineStatus) {
                    onlineStatus.textContent = paymentSettings.onlinePaymentsEnabled
                        ? '✓ Currently Enabled'
                        : '✗ Currently Disabled';
                    onlineStatus.className = paymentSettings.onlinePaymentsEnabled
                        ? 'text-sm font-medium text-green-600'
                        : 'text-sm font-medium text-red-600';
                }
            }

            if (codToggle) {
                codToggle.checked = paymentSettings.codEnabled;
                if (codStatus) {
                    codStatus.textContent = paymentSettings.codEnabled
                        ? '✓ Currently Enabled'
                        : '✗ Currently Disabled';
                    codStatus.className = paymentSettings.codEnabled
                        ? 'text-sm font-medium text-green-600'
                        : 'text-sm font-medium text-red-600';
                }
            }
        }


        function updateCart() {
            const itemsEl = document.getElementById('cart-items');
            const summaryEl = document.getElementById('cart-summary');
            if (!itemsEl || !summaryEl) return;

            if (cart.length === 0) {
                itemsEl.innerHTML = '<p class="text-gray-400 text-center py-8">Your cart is empty</p>';
                summaryEl.innerHTML = '';
                return;
            }

            // Get shop pricing settings
            const shop = allShops.find(s => s.id === selectedShopId);
            const minimumOrderAmount = shop?.minimumOrderAmount || 0;
            const deliveryCharge = shop?.deliveryCharge || 0;
            const gstPercentage = shop?.gstPercentage || 5;

            // Calculate pricing breakdown
            const subtotal = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
            const gstAmount = Math.round(subtotal * (gstPercentage / 100));
            const total = subtotal + deliveryCharge + gstAmount;
            const isBelowMinimum = subtotal < minimumOrderAmount && minimumOrderAmount > 0;

            itemsEl.innerHTML = cart.map(item => `
                <div class="flex justify-between items-center">
                    <div><p class="font-medium">${item.name}</p><p class="text-sm text-gray-500">₹${item.price} x ${item.quantity}</p></div>
                    <span class="font-semibold w-16 text-right">₹${item.price * item.quantity}</span>
                </div>`).join('');

            // Build pricing summary with breakdown
            let summaryHTML = '';

            // Minimum order warning
            if (isBelowMinimum) {
                summaryHTML += `
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 mb-4">
                        <p class="text-yellow-700 text-sm font-medium">
                            ⚠️ Minimum order: ₹${minimumOrderAmount}. Add ₹${minimumOrderAmount - subtotal} more.
                        </p>
                    </div>`;
            }

            // Subtotal
            summaryHTML += `
                <div class="flex justify-between text-gray-600">
                    <span>Subtotal</span>
                    <span>₹${subtotal}</span>
                </div>`;

            // Delivery charge
            if (deliveryCharge > 0) {
                summaryHTML += `
                    <div class="flex justify-between text-gray-600 mt-1">
                        <span>Delivery Charge</span>
                        <span>₹${deliveryCharge}</span>
                    </div>`;
            }

            // GST
            if (gstPercentage > 0) {
                summaryHTML += `
                    <div class="flex justify-between text-gray-600 mt-1">
                        <span>GST (${gstPercentage}%)</span>
                        <span>₹${gstAmount}</span>
                    </div>`;
            }

            // Total
            summaryHTML += `
                <div class="border-t mt-3 pt-3">
                    <div class="flex justify-between font-bold text-xl">
                        <span>Total</span>
                        <span>₹${total}</span>
                    </div>
                </div>`;

            summaryEl.innerHTML = summaryHTML;
        }

        function renderOrderForm(order = null, isDisabled = false) {
            const container = document.getElementById('order-form-container');
            if (!container) return;
            const isUpdate = !!order;

            let buttonText = isUpdate ? 'Update & Pay Difference' : 'Pay & Place Order';
            if (isDisabled) {
                buttonText = 'Shop is Closed';
            }

            // Check payment settings - hide disabled methods
            const bothDisabled = !paymentSettings.onlinePaymentsEnabled && !paymentSettings.codEnabled;
            const onlyOnline = paymentSettings.onlinePaymentsEnabled && !paymentSettings.codEnabled;
            const onlyCOD = !paymentSettings.onlinePaymentsEnabled && paymentSettings.codEnabled;

            let paymentMethodsHTML = '';
            if (bothDisabled) {
                paymentMethodsHTML = '<p class="text-red-600 text-sm font-medium">⚠ All payment methods are currently disabled. Please contact support.</p>';
            } else {
                paymentMethodsHTML = `
                    <div class="flex flex-col sm:flex-row gap-4">
                        <label class="flex items-center gap-2 cursor-pointer px-4 py-3 border rounded-lg transition-all flex-1 ${!paymentSettings.onlinePaymentsEnabled || isDisabled ? 'opacity-50 cursor-not-allowed bg-gray-100' : 'hover:bg-blue-50'}">
                            <input type="radio" name="payment-method" value="online" ${onlyOnline ? 'checked' : ''} 
                                ${!paymentSettings.onlinePaymentsEnabled || isDisabled ? 'disabled' : ''} 
                                class="w-4 h-4 text-blue-600">
                            <div class="flex flex-col">
                                <span class="font-medium text-gray-900">Online Payment</span>
                                ${!paymentSettings.onlinePaymentsEnabled ? '<span class="text-[10px] text-red-600 font-bold">TEMPORARILY DISABLED</span>' : '<span class="text-[10px] text-gray-500">Fast & Secure via Razorpay</span>'}
                            </div>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer px-4 py-3 border rounded-lg transition-all flex-1 ${!paymentSettings.codEnabled || isDisabled ? 'opacity-50 cursor-not-allowed bg-gray-100' : 'hover:bg-yellow-50'}">
                            <input type="radio" name="payment-method" value="cash" ${onlyCOD ? 'checked' : ''} 
                                ${!paymentSettings.codEnabled || isDisabled ? 'disabled' : ''} 
                                class="w-4 h-4 text-yellow-600">
                            <div class="flex flex-col">
                                <span class="font-medium text-gray-900">Cash on Delivery</span>
                                ${!paymentSettings.codEnabled ? '<span class="text-[10px] text-red-600 font-bold">TEMPORARILY DISABLED</span>' : '<span class="text-[10px] text-gray-500">Pay when food arrives</span>'}
                            </div>
                        </label>
                    </div>
                `;
            }

            container.innerHTML = `
                <h2 class="text-xl font-semibold text-gray-900 mb-4">${isUpdate ? 'Update Your Order' : 'Delivery Details'}</h2>
                <form id="order-form" class="space-y-4" data-mode="${isUpdate ? 'update' : 'create'}">
                    <div><label class="block text-sm font-medium">Name</label><input type="text" id="customer-name" class="w-full" value="${order?.customerName || ''}" ${isUpdate || isDisabled ? 'disabled' : ''} required></div>
                    <div><label class="block text-sm font-medium">Address</label><input type="text" id="customer-address" class="w-full" value="${order?.customerAddress || ''}" ${isUpdate || isDisabled ? 'disabled' : ''} required></div>
                    <div><label class="block text-sm font-medium">Phone</label><input type="tel" id="customer-phone" class="w-full" value="${order?.customerPhone || ''}" ${isUpdate || isDisabled ? 'disabled' : ''} required></div>
                    <div class="bg-gray-50 p-4 rounded-xl border">
                        <label class="block text-sm font-bold text-gray-700 mb-3">Payment Method</label>
                        ${paymentMethodsHTML}
                    </div>
                    <button type="submit" id="place-order-btn" class="btn-primary w-full" ${isDisabled || bothDisabled ? 'disabled' : ''}>${bothDisabled ? 'No Payment Methods Available' : buttonText}</button>
                </form>
            `;

            // Update button text dynamically based on payment method
            document.querySelectorAll('input[name="payment-method"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    const btn = document.getElementById('place-order-btn');
                    if (btn && !isDisabled && !isUpdate) {
                        btn.textContent = e.target.value === 'cash' ? 'Confirm Order (COD)' : 'Pay & Place Order';
                    }
                });
            });
        }

        async function placeOrder() {
            if (cart.length === 0) return showAlert('Your cart is empty.');
            if (!selectedShopId) return showAlert('No shop selected.', true);

            // CRITICAL CHECK: Prevent ordering if shop is closed
            if (isShopCurrentlyClosed) {
                return showAlert("Cannot place order: The selected shop is closed.", true);
            }

            // Critical Fix: Open login modal instead of showing alert on order attempt by guest
            if (auth.currentUser?.isAnonymous || userId.startsWith('offline')) {
                openProfileModal(true);
                return;
            }

            const customerName = document.getElementById('customer-name').value;
            const customerAddress = document.getElementById('customer-address').value;
            const customerPhone = document.getElementById('customer-phone').value;
            const paymentMethod = document.querySelector('input[name="payment-method"]:checked')?.value || 'online';

            // Basic form validation before payment
            if (!customerName || !customerAddress || !customerPhone) {
                return showAlert("Please fill out all delivery details.", true);
            }

            // ========== PRICING BREAKDOWN CALCULATION ==========
            const shop = allShops.find(s => s.id === selectedShopId);
            const minimumOrderAmount = shop?.minimumOrderAmount || 0;
            const deliveryCharge = shop?.deliveryCharge || 0;
            const gstPercentage = shop?.gstPercentage || 5;

            const subtotal = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
            const gstAmount = Math.round(subtotal * (gstPercentage / 100));
            const totalAmount = subtotal + deliveryCharge + gstAmount;

            // ========== MINIMUM ORDER VALIDATION ==========
            if (subtotal < minimumOrderAmount && minimumOrderAmount > 0) {
                return showAlert(`Minimum order amount is ₹${minimumOrderAmount}. Add ₹${minimumOrderAmount - subtotal} more.`, true);
            }

            // CRITICAL: Validate payment method is enabled
            if (paymentMethod === 'online' && !paymentSettings.onlinePaymentsEnabled) {
                return showAlert('Online payments are currently unavailable. Please try cash on delivery.', true);
            }
            if (paymentMethod === 'cash' && !paymentSettings.codEnabled) {
                return showAlert('Cash on delivery is currently unavailable. Please try online payment.', true);
            }

            // Handle Cash on Delivery directly
            if (paymentMethod === 'cash') {
                const orderData = {
                    shopId: selectedShopId,
                    customerName,
                    customerAddress,
                    deliveryAddress: customerAddress,
                    customerPhone,
                    items: cart.map(item => ({ ...item, ready: false })),
                    subtotal,
                    deliveryCharge,
                    gstAmount,
                    totalAmount,
                    status: 'new',
                    createdAt: serverTimestamp(),
                    userId,
                    isTestOrder: false,
                    paymentMethod: 'cash',
                    cashStatus: 'pending',
                    paymentId: null
                };
                await saveOrderToFirestore(orderData);
                return;
            }

            // Online Payment via Razorpay
            const options = {
                key: "rzp_test_RU9lPJQl5wqQFM",
                amount: totalAmount * 100,
                currency: "INR", name: "CloudKitchen", description: "Order Payment",
                image: "https://placehold.co/100x100/000000/FFFFFF?text=CK",
                handler: async (response) => {
                    const orderData = {
                        shopId: selectedShopId,
                        customerName,
                        customerAddress,
                        deliveryAddress: customerAddress,
                        customerPhone,
                        items: cart.map(item => ({ ...item, ready: false })),
                        subtotal,
                        deliveryCharge,
                        gstAmount,
                        totalAmount,
                        status: 'new',
                        createdAt: serverTimestamp(),
                        userId,
                        isTestOrder: false,
                        paymentMethod: 'online',
                        cashStatus: 'none',
                        paymentId: response.razorpay_payment_id,
                        paymentIds: [response.razorpay_payment_id]
                    };
                    await saveOrderToFirestore(orderData);
                },
                prefill: { name: customerName, email: userEmail.includes('Guest') ? '' : userEmail, contact: customerPhone },
                notes: { address: customerAddress },
                theme: { color: "#0071e3" },
                modal: { ondismiss: () => showAlert("Payment was cancelled.", true) }
            };
            const rzp = new Razorpay(options);
            rzp.open();
        }

        async function saveOrderToFirestore(orderData) {
            try {
                const docRef = await addDoc(collection(db, "orders"), orderData);
                showAlert('Payment successful! Order placed.');
                cart = []; isEditingOrder = false;
                updateCart();
                renderMenu(selectedShopId);
                currentTrackingOrderId = docRef.id;
                startTrackingLatestOrder();

                // --- Notification: Notify kitchen and owner ---
                const usersSnapshot = await getDocs(query(collection(db, "users"), where("shopId", "==", orderData.shopId), where("role", "in", ["kitchen", "owner"])));
                usersSnapshot.docs.forEach(userDoc => {
                    createNotification({
                        // Notification Fix: userDoc.id is the target's UID
                        userId: userDoc.id,
                        role: userDoc.data().role,
                        shopId: orderData.shopId,
                        message: `New order received from ${orderData.customerName}.`,
                        orderId: docRef.id
                    });
                });
                // --- END Notification ---

            } catch (error) {
                showAlert('Failed to save order after payment.', true);
                console.error("Order save error: ", error);
            }
        }

        async function updateOrder() {
            if (cart.length === 0) return showAlert('Your cart cannot be empty.');
            if (!currentTrackingOrderId) return showAlert('No order selected for update.', true);

            const orderDocRef = doc(db, "orders", currentTrackingOrderId);
            try {
                const orderDocSnap = await getDoc(orderDocRef);
                if (!orderDocSnap.exists()) {
                    showAlert("Order not found.", true); return;
                }

                const originalOrderData = orderDocSnap.data();
                const currentStatus = originalOrderData.status;

                if (!['new', 'preparing'].includes(currentStatus)) {
                    showAlert('Sorry, it is too late to modify this order.', true);
                    cart = []; isEditingOrder = false;
                    updateCart();
                    renderMenu(selectedShopId);
                    renderOrderForm();
                    startTrackingLatestOrder();
                    return;
                }

                const originalTotal = originalOrderData.totalAmount;
                const newTotal = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
                const amountDue = newTotal - originalTotal;

                const finalUpdateLogic = async (paymentId = null) => {
                    // Bug Fix: Ensure new items are added with 'ready: false' status if they didn't exist before
                    const updatedItems = cart.map(item => {
                        const existingItem = originalOrderData.items.find(i => i.id === item.id);
                        return { ...item, ready: existingItem ? existingItem.ready : false };
                    });

                    let paymentIds = originalOrderData.paymentIds || [originalOrderData.paymentId];
                    if (paymentId) {
                        paymentIds.push(paymentId);
                    }

                    await updateDoc(orderDocRef, { items: updatedItems, totalAmount: newTotal, paymentIds });
                    showAlert('Order updated successfully!');
                    cart = []; isEditingOrder = false;
                    updateCart();
                    renderMenu(selectedShopId);
                    renderOrderForm();
                    startTrackingLatestOrder();
                };

                if (amountDue > 0) {
                    const options = {
                        key: "rzp_test_RU9lPJQl5wqQFM",
                        amount: amountDue * 100,
                        currency: "INR", name: "CloudKitchen", description: `Additional payment for Order #${currentTrackingOrderId.substring(0, 6)}`,
                        image: "https://placehold.co/100x100/000000/FFFFFF?text=CK",
                        handler: async (response) => {
                            await finalUpdateLogic(response.razorpay_payment_id);
                        },
                        prefill: { name: originalOrderData.customerName, email: userEmail.includes('Guest') ? '' : userEmail, contact: originalOrderData.customerPhone },
                        theme: { color: "#0071e3" },
                        modal: { ondismiss: () => showAlert("Additional payment was cancelled. Order not updated.", true) }
                    };
                    const rzp = new Razorpay(options);
                    rzp.open();
                } else {
                    await finalUpdateLogic();
                }
            } catch (error) {
                showAlert('Failed to update order.', true);
                console.error("Order update error: ", error);
            }
        }

        async function startEditingOrder(order) {
            isEditingOrder = true;

            // Bug Fix: Ensure allShops is loaded when editing an order if coming from a different view/load state
            if (allShops.length === 0) await loadAllShops();

            await selectShop(order.shopId, allShops.find(s => s.id === order.shopId)?.name || 'Selected Shop');

            // Bug Fix: Deep copy of items array is crucial to prevent modifying live listener data
            cart = order.items.map(item => ({ ...item }));
            document.getElementById('order-status-container').classList.add('hidden');
            document.getElementById('order-form-container').style.display = 'block';
            updateCart();
            renderMenu(order.shopId);
            renderOrderForm(order);
        }

        function startTrackingLatestOrder() {
            if (!userId || !isFirebaseReady || userId.startsWith('offline') || auth.currentUser?.isAnonymous) return;
            currentOrderListener?.();

            // NOTE: This query requires a composite Firestore index on (userId, createdAt DESC).
            // The query is semantically correct (fetches the latest order for a specific user).
            // If you see a Firestore error, create the index using the link provided in the console.
            console.warn("⚠️ Order tracking query requires Firestore index: (userId ASC, createdAt DESC)");
            const q = query(collection(db, "orders"), where("userId", "==", userId), orderBy("createdAt", "desc"), limit(1)); // Only track the very latest order

            currentOrderListener = onSnapshot(q, async (snapshot) => {
                const orderFormContainer = document.getElementById('order-form-container');
                const orderStatusContainer = document.getElementById('order-status-container');

                if (snapshot.docs.length > 0 && !isEditingOrder) {
                    const latestOrder = snapshot.docs[0];
                    currentTrackingOrderId = latestOrder.id;
                    const orderData = latestOrder.data();

                    if (orderData.status === 'completed') {
                        // Order is complete, reset to shop selector
                        currentTrackingOrderId = null;
                        orderFormContainer.style.display = 'block';
                        orderStatusContainer.classList.add('hidden');
                        showShopSelector();
                        return;
                    }

                    if (orderData.shopId !== selectedShopId) {
                        // Bug Fix: Ensure allShops is loaded here
                        if (allShops.length === 0) await loadAllShops();
                        await selectShop(orderData.shopId, allShops.find(s => s.id === orderData.shopId)?.name || 'Your Order');
                    }

                    trackOrderStatus(latestOrder.id, orderData);
                    orderFormContainer.style.display = 'none';
                    orderStatusContainer.classList.remove('hidden');
                } else if (!isEditingOrder) {
                    currentTrackingOrderId = null;
                    orderFormContainer.style.display = 'block';
                    orderStatusContainer.classList.add('hidden');
                    // Reset to initial view if no active orders
                    if (document.getElementById('menu-and-cart-view').style.display === 'block') {
                        showShopSelector();
                    }
                }
            }, error => {
                // --- MODIFICATION: Do NOT show public alert for order status errors on load ---
                // This prevents the "Could not fetch your order status" message on page load for guests/unauthorized users.
                console.error("Error tracking latest order:", error);
                // showAlert("Could not fetch your order status.", true); // Removed public alert
                // --- END MODIFICATION ---
            });
        }

        function trackOrderStatus(orderId, order) {
            const statusContainer = document.getElementById('order-status-container');
            if (!statusContainer) return;

            const canAddItems = ['new', 'preparing'].includes(order.status);
            const stages = ['new', 'preparing', 'ready_for_pickup', 'out_for_delivery', 'completed'];
            const currentStageIndex = stages.indexOf(order.status);

            let progressStepsHTML = '';
            stages.forEach((stage, index) => {
                const isActive = index <= currentStageIndex ? 'active' : '';
                progressStepsHTML += `<div class="progress-step ${isActive}">${index + 1}</div>`;
            });

            const progressPercentage = (currentStageIndex / (stages.length - 1)) * 100;

            statusContainer.innerHTML = `
                <div class="mb-4">
                    <h2 class="text-xl font-semibold mb-1">Your Order Status</h2>
                    <p class="text-sm text-gray-500">Order ID: ${orderId.substring(0, 8)}</p>
                </div>
        
                <div class="progress-container">
                    <div class="progress-line"><div class="progress-line-fill" style="width: ${progressPercentage}%;"></div></div>
                    ${progressStepsHTML}
                </div>
                <div class="flex justify-between text-xs text-gray-500 px-2">
                    <span>Placed</span>
                    <span>Preparing</span>
                    <span>Ready</span>
                    <span>Out for Delivery</span>
                    <span>Completed</span>
                </div>
        
                <div class="mt-6 p-4 bg-gray-50 rounded-lg">
                    <h3 class="font-semibold mb-2">Item Details</h3>
                    <div class="divide-y">${order.items.map(item => `<div class="flex justify-between items-center py-2"><span>${item.name} x ${item.quantity}</span><span class="text-sm font-medium ${item.ready ? 'text-green-600' : 'text-orange-500'}">${item.ready ? 'Ready' : 'Preparing'}</span></div>`).join('')}</div>
                    <p class="text-right font-bold text-lg mt-4">Total: ₹${order.totalAmount}</p>
                </div>
                <p class="text-center mt-4 text-sm text-gray-600">Overall Status: <span class="font-bold uppercase">${order.status.replace(/_/g, ' ')}</span></p>
                ${canAddItems ? `<button id="add-more-items-btn" class="btn-primary w-full mt-6 bg-green-600 hover:bg-green-700">Add More Items</button>` : ''}
            `;
        }

        // --- Staff & Owner Views Logic ---

        function listenToStaffOrders() {
            const kitchenList = document.getElementById('kitchen-orders-list');
            const transportList = document.getElementById('transport-orders-list');

            if (!['kitchen', 'owner', 'delivery', 'developer'].includes(userRole) || !isFirebaseReady) {
                return;
            }

            if (!currentUserShopId) {
                const msg = (userRole === 'developer')
                    ? 'Please select a shop from the Dev Panel to view this section.'
                    : 'You are not assigned to a shop.';
                if (kitchenList) kitchenList.innerHTML = `<p class="text-gray-500 col-span-full text-center">${msg}</p>`;
                if (transportList) transportList.innerHTML = `<p class="text-gray-500 col-span-full text-center">${msg}</p>`;
                return;
            }

            // Bug Fix: Only show "new" and "preparing" in the kitchen view
            const kitchenQuery = query(collection(db, "orders"), where("status", "in", ["new", "preparing"]), where("shopId", "==", currentUserShopId));
            onSnapshot(kitchenQuery, s => {
                originalKitchenOrders = s.docs; // Store for search
                renderOrders(kitchenList, s.docs, 'kitchen');
            });

            // For delivery staff with multiple shops, show orders from all assigned shops
            // Firestore 'in' query supports up to 10 values
            const shopIdsForTransport = (userRole === 'delivery' && currentUserShopIds.length > 0)
                ? currentUserShopIds.slice(0, 10) // Firestore limit
                : [currentUserShopId];

            const transportQuery = query(
                collection(db, "orders"),
                where("status", "in", ["ready_for_pickup", "out_for_delivery"]),
                where("shopId", "in", shopIdsForTransport)
            );
            onSnapshot(transportQuery, s => {
                originalTransportOrders = s.docs; // Store for search
                renderOrders(transportList, s.docs, 'transport');
            });

            // Initialize search functionality
            setupSearchFunctionality();
        }

        async function toggleItemReady(orderId, itemId) {
            const orderRef = doc(db, "orders", orderId);
            const orderSnap = await getDoc(orderRef);
            if (orderSnap.exists()) {
                if (orderSnap.data().shopId !== currentUserShopId && userRole !== 'developer') {
                    return showAlert("You don't have permission for this order.", true);
                }
                // Fix: Compare string representations of IDs since firestore items can be objects/strings
                const items = orderSnap.data().items.map(item => String(item.id) === String(itemId) ? { ...item, ready: !item.ready } : item);
                await updateDoc(orderRef, { items });
            }
        }

        function renderOrders(container, docs, viewType) {
            if (!container) return;
            container.innerHTML = docs.length === 0
                ? `<p class="text-gray-500 col-span-full text-center">No orders to show.</p>`
                : docs.sort((a, b) => (a.data().createdAt?.toMillis() || 0) - (b.data().createdAt?.toMillis() || 0)).map(doc => {
                    const order = doc.data();
                    let actionButton = '';
                    if (viewType === 'kitchen') {
                        if (order.status === 'new') actionButton = `<button data-id="${doc.id}" data-status="preparing" class="update-status-btn btn-primary btn-preparing w-full mt-4">Start Preparing</button>`;
                        else if (order.status === 'preparing') actionButton = `<button data-id="${doc.id}" data-status="ready_for_pickup" class="update-status-btn btn-primary btn-ready w-full mt-4">Mark Ready</button>`;
                    } else if (viewType === 'transport') {
                        if (order.status === 'ready_for_pickup') actionButton = `<button data-id="${doc.id}" data-status="out_for_delivery" class="update-status-btn btn-primary btn-delivery w-full mt-4">Out for Delivery</button>`;
                        else if (order.status === 'out_for_delivery') {
                            // Different buttons for COD vs Online orders
                            if (order.paymentMethod === 'cash') {
                                actionButton = `
                                    <button data-id="${doc.id}" data-status="completed" data-cash="true" class="update-status-btn btn-primary btn-completed w-full mt-4">💵 Collect Cash & Complete</button>
                                    <button onclick="showReturnDialog('${doc.id}')" class="btn-secondary w-full mt-2 text-red-600">↩️ Return to Shop</button>
                                `;
                            } else {
                                actionButton = `
                                    <button data-id="${doc.id}" data-status="completed" class="update-status-btn btn-primary btn-completed w-full mt-4">Mark Delivered</button>
                                    <button onclick="showReturnDialog('${doc.id}')" class="btn-secondary w-full mt-2 text-red-600">↩️ Return to Shop</button>
                                `;
                            }
                        }
                    }

                    // Bug Fix: Checkbox event listener should be on the change event
                    const itemsList = order.items.map(item => `<div class="flex justify-between items-center text-sm py-1"><span>${item.name} x ${item.quantity}</span>${order.status === 'preparing' ? `<label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" onchange="toggleItemReady('${doc.id}', '${item.id}')" ${item.ready ? 'checked' : ''}><span class="text-xs font-medium ${item.ready ? 'text-green-600' : ''}">Ready</span></label>` : ''}</div>`).join('');

                    // Show shop name badge for delivery staff with multiple shops
                    const shopName = allShops.find(s => s.id === order.shopId)?.name || 'Unknown';
                    const shopBadge = (userRole === 'delivery' && currentUserShopIds.length > 1)
                        ? `<span class="text-xs bg-indigo-100 text-indigo-700 px-2 py-1 rounded-full">${shopName}</span>`
                        : '';

                    // Cash badge for COD orders
                    const cashBadge = order.paymentMethod === 'cash'
                        ? `<span class="cash-badge">💵 CASH</span>`
                        : '';

                    const customerInfoHTML = `
                        <div class="text-sm text-gray-700 mt-3 space-y-1">
                            <p><span class="font-medium">Phone:</span> ${order.customerPhone || 'N/A'}</p>
                            <p><span class="font-medium">Address:</span> ${order.customerAddress || 'N/A'}</p>
                            ${viewType === 'transport' ? `
                                <div class="flex gap-2 mt-2">
                                    <button onclick="navigateToCustomer('${order.customerAddress || ''}', ${order.customerLatitude || 'null'}, ${order.customerLongitude || 'null'})" 
                                        class="flex-1 flex items-center justify-center gap-2 px-3 py-2 bg-blue-50 hover:bg-blue-100 text-blue-700 rounded-lg transition-all text-xs font-medium">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                                d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                        </svg>
                                        Navigate
                                    </button>
                                    <button onclick="window.location.href='tel:${order.customerPhone || ''}'" 
                                        class="flex-1 flex items-center justify-center gap-2 px-3 py-2 bg-green-50 hover:bg-green-100 text-green-700 rounded-lg transition-all text-xs font-medium">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                                        </svg>
                                        Call
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    `;

                    return `<div class="card p-4 flex flex-col justify-between"><div><div class="flex justify-between items-start mb-2 gap-2"><strong class="text-gray-800">${order.customerName}</strong><div class="flex gap-1 flex-wrap">${cashBadge}${shopBadge}${order.isTestOrder ? '<span class="text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded">TEST</span>' : ''}</div></div>${customerInfoHTML}<div class="mt-2 border-t pt-2">${itemsList}</div><div class="mt-4 flex justify-between items-center"><span class="status-tag status-tag-${order.status}">${order.status.replace(/_/g, ' ')}</span><p class="text-lg font-bold">₹${order.totalAmount}</p></div></div>${actionButton}</div>`;
                }).join('');
        }

        // Search functionality for kitchen and transport views  
        let originalKitchenOrders = [];
        let originalTransportOrders = [];

        function setupSearchFunctionality() {
            const kitchenSearchInput = document.getElementById('kitchen-search-input');
            const kitchenSearchClear = document.getElementById('kitchen-search-clear');
            const kitchenSearchResults = document.getElementById('kitchen-search-results');

            const transportSearchInput = document.getElementById('transport-search-input');
            const transportSearchClear = document.getElementById('transport-search-clear');
            const transportSearchResults = document.getElementById('transport-search-results');

            // Kitchen search
            if (kitchenSearchInput) {
                kitchenSearchInput.addEventListener('input', (e) => {
                    const searchTerm = e.target.value.toLowerCase().trim();

                    // Show/hide clear button
                    if (searchTerm) {
                        kitchenSearchClear.classList.remove('hidden');
                    } else {
                        kitchenSearchClear.classList.add('hidden');
                    }

                    filterOrders('kitchen', searchTerm);
                });

                kitchenSearchClear.addEventListener('click', () => {
                    kitchenSearchInput.value = '';
                    kitchenSearchClear.classList.add('hidden');
                    kitchenSearchResults.textContent = '';
                    filterOrders('kitchen', '');
                });
            }

            // Transport search
            if (transportSearchInput) {
                transportSearchInput.addEventListener('input', (e) => {
                    const searchTerm = e.target.value.toLowerCase().trim();

                    // Show/hide clear button
                    if (searchTerm) {
                        transportSearchClear.classList.remove('hidden');
                    } else {
                        transportSearchClear.classList.add('hidden');
                    }

                    filterOrders('transport', searchTerm);
                });

                transportSearchClear.addEventListener('click', () => {
                    transportSearchInput.value = '';
                    transportSearchClear.classList.add('hidden');
                    transportSearchResults.textContent = '';
                    filterOrders('transport', '');
                });
            }
        }

        function filterOrders(viewType, searchTerm) {
            const container = viewType === 'kitchen'
                ? document.getElementById('kitchen-orders-list')
                : document.getElementById('transport-orders-list');

            const results = viewType === 'kitchen'
                ? document.getElementById('kitchen-search-results')
                : document.getElementById('transport-search-results');

            const orders = viewType === 'kitchen' ? originalKitchenOrders : originalTransportOrders;

            if (!container || !orders || orders.length === 0) return;

            if (!searchTerm) {
                // Show all orders
                renderOrders(container, orders, viewType);
                if (results) results.textContent = '';
                return;
            }

            // Filter orders based on search term
            const filteredOrders = orders.filter(doc => {
                const order = doc.data();
                const orderId = doc.id.toLowerCase();
                const customerName = (order.customerName || '').toLowerCase();
                const customerPhone = (order.customerPhone || '').toLowerCase();
                const items = (order.items || []).map(item => item.name.toLowerCase()).join(' ');

                return orderId.includes(searchTerm) ||
                    customerName.includes(searchTerm) ||
                    customerPhone.includes(searchTerm) ||
                    items.includes(searchTerm);
            });

            // Render filtered results
            renderOrders(container, filteredOrders, viewType);

            // Update results count
            if (results) {
                if (filteredOrders.length === 0) {
                    results.textContent = 'No orders found';
                    results.className = 'mt-2 text-sm text-red-500';
                } else {
                    results.textContent = `Showing ${filteredOrders.length} of ${orders.length} orders`;
                    results.className = 'mt-2 text-sm text-gray-500';
                }
            }
        }

        // Customer search functionality
        let originalShopsList = [];
        let originalMenuItems = [];
        let originalCustomerOrders = [];

        function setupCustomerSearchFunctionality() {
            // Shop search
            const shopSearchInput = document.getElementById('shop-search-input');
            const shopSearchClear = document.getElementById('shop-search-clear');
            const shopSearchResults = document.getElementById('shop-search-results');

            if (shopSearchInput) {
                shopSearchInput.addEventListener('input', (e) => {
                    const searchTerm = e.target.value.toLowerCase().trim();

                    if (searchTerm) {
                        shopSearchClear.classList.remove('hidden');
                    } else {
                        shopSearchClear.classList.add('hidden');
                    }

                    filterShops(searchTerm);
                });

                shopSearchClear.addEventListener('click', () => {
                    shopSearchInput.value = '';
                    shopSearchClear.classList.add('hidden');
                    shopSearchResults.textContent = '';
                    filterShops('');
                });
            }

            // Menu search
            const menuSearchInput = document.getElementById('menu-search-input');
            const menuSearchClear = document.getElementById('menu-search-clear');
            const menuSearchResults = document.getElementById('menu-search-results');

            if (menuSearchInput) {
                menuSearchInput.addEventListener('input', (e) => {
                    const searchTerm = e.target.value.toLowerCase().trim();

                    if (searchTerm) {
                        menuSearchClear.classList.remove('hidden');
                    } else {
                        menuSearchClear.classList.add('hidden');
                    }

                    filterMenuItems(searchTerm);
                });

                menuSearchClear.addEventListener('click', () => {
                    menuSearchInput.value = '';
                    menuSearchClear.classList.add('hidden');
                    menuSearchResults.textContent = '';
                    filterMenuItems('');
                });
            }

            // Order history search
            const orderHistorySearchInput = document.getElementById('order-history-search-input');
            const orderHistorySearchClear = document.getElementById('order-history-search-clear');
            const orderHistorySearchResults = document.getElementById('order-history-search-results');

            if (orderHistorySearchInput) {
                orderHistorySearchInput.addEventListener('input', (e) => {
                    const searchTerm = e.target.value.toLowerCase().trim();

                    if (searchTerm) {
                        orderHistorySearchClear.classList.remove('hidden');
                    } else {
                        orderHistorySearchClear.classList.add('hidden');
                    }

                    filterCustomerOrders(searchTerm);
                });

                orderHistorySearchClear.addEventListener('click', () => {
                    orderHistorySearchInput.value = '';
                    orderHistorySearchClear.classList.add('hidden');
                    orderHistorySearchResults.textContent = '';
                    filterCustomerOrders('');
                });
            }
        }

        function filterShops(searchTerm) {
            const container = document.getElementById('shop-list-container');
            const results = document.getElementById('shop-search-results');

            if (!container) return;

            // Store all shops if not already stored
            if (originalShopsList.length === 0 && allShops.length > 0) {
                originalShopsList = [...allShops];
            }

            if (!searchTerm) {
                // Show all shops
                renderShopSelector();
                if (results) results.textContent = '';
                return;
            }

            // Filter shops
            const filteredShops = originalShopsList.filter(shop => {
                const name = (shop.name || '').toLowerCase();
                const address = (shop.address || '').toLowerCase();

                return name.includes(searchTerm) || address.includes(searchTerm);
            });

            // Render filtered shops (temporarily replace allShops)
            const tempShops = allShops;
            allShops = filteredShops;
            renderShopSelector();
            allShops = tempShops;

            // Update results
            if (results) {
                if (filteredShops.length === 0) {
                    results.textContent = 'No shops found';
                    results.className = 'mt-2 text-sm text-red-500';
                } else {
                    results.textContent = `Showing ${filteredShops.length} of ${originalShopsList.length} shops`;
                    results.className = 'mt-2 text-sm text-gray-500';
                }
            }
        }

        function filterMenuItems(searchTerm) {
            const container = document.getElementById('menu-items');
            const results = document.getElementById('menu-search-results');

            if (!container) return;

            // Store original menu items if not already stored
            if (originalMenuItems.length === 0 && currentMenu.length > 0) {
                originalMenuItems = [...currentMenu];
            }

            if (!searchTerm) {
                // Restore all items
                currentMenu = [...originalMenuItems];
                renderMenuDisplay();
                if (results) results.textContent = '';
                return;
            }

            // Filter menu items
            const filteredItems = originalMenuItems.filter(item => {
                const name = (item.name || '').toLowerCase();
                const price = String(item.price || '');

                return name.includes(searchTerm) || price.includes(searchTerm);
            });

            // Update currentMenu and re-render
            currentMenu = filteredItems;
            renderMenuDisplay();

            // Update results
            if (results) {
                if (filteredItems.length === 0) {
                    results.textContent = 'No dishes found';
                    results.className = 'mt-2 text-sm text-red-500';
                } else {
                    results.textContent = `Showing ${filteredItems.length} of ${originalMenuItems.length} dishes`;
                    results.className = 'mt-2 text-sm text-gray-500';
                }
            }
        }

        function renderMenuDisplay() {
            const container = document.getElementById('menu-items');
            if (!container) return;

            if (currentMenu.length === 0) {
                container.innerHTML = '<p class=\"text-gray-500 col-span-full text-center\">No items match your search.</p>';
                return;
            }

            container.innerHTML = '';
            currentMenu.forEach(item => {
                const cartItem = cart.find(ci => ci.id === item.id);
                let buttonHTML;

                if (isShopCurrentlyClosed) {
                    buttonHTML = `<button disabled class="mt-4 btn-danger w-full opacity-70">CLOSED</button>`;
                } else if (cartItem) {
                    buttonHTML = `
                        <div class="quantity-selector mt-4">
                            <button class="quantity-btn quantity-minus" data-id="${item.id}">-</button>
                            <span class="quantity-display">${cartItem.quantity}</span>
                            <button class="quantity-btn quantity-plus" data-id="${item.id}">+</button>
                        </div>
                    `;
                } else {
                    buttonHTML = `<button data-id="${item.id}" class="add-to-cart-btn mt-4 btn-primary w-full">Add to Cart</button>`;
                }

                container.innerHTML += `
                    <div class="menu-item card p-0">
                        <div class="relative w-full h-40 bg-gray-200 overflow-hidden">
                            <img src="${item.image || 'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22600%22 height=%22400%22%3E%3Crect fill=%22%23e5e7eb%22 width=%22600%22 height=%22400%22/%3E%3Ctext fill=%22%23999%22 font-family=%22sans-serif%22 font-size=%2224%22 x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 dominant-baseline=%22middle%22%3EItem%3C/text%3E%3C/svg%3E'}" 
                                 alt="${item.name}" 
                                 class="w-full h-full object-cover" 
                                 loading="lazy"
                                 onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22600%22 height=%22400%22%3E%3Crect fill=%22%23e5e7eb%22 width=%22600%22 height=%22400%22/%3E%3Ctext fill=%22%23999%22 font-family=%22sans-serif%22 font-size=%2224%22 x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 dominant-baseline=%22middle%22%3EImage%3C/text%3E%3C/svg%3E'">
                        </div>
                        <div class="p-5">
                            <h3 class="text-lg font-semibold">${item.name}</h3>
                            <p class="text-gray-600">₹${item.price}</p>
                            ${buttonHTML}
                        </div>
                    </div>`;
            });
        }

        function filterCustomerOrders(searchTerm) {
            const container = document.getElementById('customer-order-list');
            const results = document.getElementById('order-history-search-results');

            if (!container || originalCustomerOrders.length === 0) return;

            if (!searchTerm) {
                // Show all orders
                renderCustomerOrderList(originalCustomerOrders);
                if (results) results.textContent = '';
                return;
            }

            // Filter orders
            const filteredOrders = originalCustomerOrders.filter(order => {
                const orderId = (order.id || '').toLowerCase();
                const shopName = (allShops.find(s => s.id === order.shopId)?.name || '').toLowerCase();
                const items = (order.items || []).map(item => item.name.toLowerCase()).join(' ');
                const status = (order.status || '').toLowerCase();
                const date = order.createdAt?.toDate();
                const dateStr = date ? date.toLocaleDateString().toLowerCase() : '';

                return orderId.includes(searchTerm) ||
                    shopName.includes(searchTerm) ||
                    items.includes(searchTerm) ||
                    status.includes(searchTerm) ||
                    dateStr.includes(searchTerm);
            });

            // Render filtered orders
            renderCustomerOrderList(filteredOrders);

            // Update results
            if (results) {
                if (filteredOrders.length === 0) {
                    results.textContent = 'No orders found';
                    results.className = 'mt-2 text-sm text-red-500';
                } else {
                    results.textContent = `Showing ${filteredOrders.length} of ${originalCustomerOrders.length} orders`;
                    results.className = 'mt-2 text-sm text-gray-500';
                }
            }
        }

        function renderCustomerOrderList(orders) {
            const container = document.getElementById('customer-order-list');
            if (!container) return;

            if (orders.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <svg class="w-20 h-20 mx-auto text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                        </svg>
                        <h3 class="text-xl font-semibold text-gray-700 mb-2">No Orders Found</h3>
                        <p class="text-gray-500">Try adjusting your search.</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = orders.map(order => {
                const date = order.createdAt?.toDate();
                const formattedDate = date ? new Intl.DateTimeFormat('en-IN', {
                    month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
                }).format(date) : 'Date N/A';

                const shopName = allShops.find(s => s.id === order.shopId)?.name || 'Unknown Shop';
                const itemCount = order.items?.reduce((sum, item) => sum + (item.quantity || 1), 0) || 0;

                return `
                    <div class="card p-4 cursor-pointer hover:shadow-lg transition-all" onclick="viewOrderTracking('${order.id}')">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <h4 class="font-bold text-gray-900">${shopName}</h4>
                                <p class="text-xs text-gray-500">${formattedDate}</p>
                            </div>
                            <span class="status-tag status-tag-${order.status}">${order.status.replace(/_/g, ' ')}</span>
                        </div>
                        <p class="text-sm text-gray-600 mb-2">${itemCount} item${itemCount > 1 ? 's' : ''}</p>
                        <div class="flex justify-between items-center pt-2 border-t">
                            <span class="text-lg font-bold text-gray-900">₹${order.totalAmount}</span>
                            ${order.paymentMethod === 'cash' ? '<span class="cash-badge">💵 CASH</span>' : '<span class="text-xs text-green-600">✓ Paid Online</span>'}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ========== UNIFIED SEARCH FUNCTIONALITY ==========
        function setupUnifiedSearch() {
            const searchModal = document.getElementById('unified-search-modal');
            const searchBtn = document.getElementById('unified-search-btn');
            const searchInput = document.getElementById('unified-search-input');
            const searchClose = document.getElementById('unified-search-close');
            const searchResults = document.getElementById('unified-search-results');

            // Open search modal
            function openUnifiedSearch() {
                searchModal.classList.remove('hidden');
                setTimeout(() => searchInput.focus(), 100);
            }

            // Close search modal
            function closeUnifiedSearch() {
                searchModal.classList.add('hidden');
                searchInput.value = '';
                searchResults.innerHTML = `
                    <div class="text-center py-12 text-gray-400">
                        <svg class="w-16 h-16 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                        <p>Start typing to search...</p>
                    </div>
                `;
            }

            // Event listeners
            if (searchBtn) {
                searchBtn.addEventListener('click', openUnifiedSearch);
            }

            if (searchClose) {
                searchClose.addEventListener('click', closeUnifiedSearch);
            }

            // Click outside to close
            if (searchModal) {
                searchModal.addEventListener('click', (e) => {
                    if (e.target === searchModal) {
                        closeUnifiedSearch();
                    }
                });
            }

            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                // Ctrl+K or Cmd+K to open search
                if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                    e.preventDefault();
                    openUnifiedSearch();
                }

                // ESC to close
                if (e.key === 'Escape' && !searchModal.classList.contains('hidden')) {
                    closeUnifiedSearch();
                }
            });

            // Real-time search
            if (searchInput) {
                let searchTimeout;
                searchInput.addEventListener('input', (e) => {
                    clearTimeout(searchTimeout);
                    const searchTerm = e.target.value.toLowerCase().trim();

                    if (!searchTerm) {
                        searchResults.innerHTML = `
                            <div class="text-center py-12 text-gray-400">
                                <svg class="w-16 h-16 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                </svg>
                                <p>Start typing to search...</p>
                            </div>
                        `;
                        return;
                    }

                    // Debounce search
                    searchTimeout = setTimeout(() => {
                        performUnifiedSearch(searchTerm);
                    }, 200);
                });
            }
        }

        function performUnifiedSearch(searchTerm) {
            const searchResults = document.getElementById('unified-search-results');

            // Search shops
            const matchedShops = allShops.filter(shop => {
                const name = (shop.name || '').toLowerCase();
                const address = (shop.address || '').toLowerCase();
                return name.includes(searchTerm) || address.includes(searchTerm);
            });

            // Search menu items (from ALL shops, not just current shop)
            const matchedMenuItems = allMenuItems.filter(item => {
                const name = (item.name || '').toLowerCase();
                const price = String(item.price || '');
                const shopName = (item.shopName || '').toLowerCase();
                return name.includes(searchTerm) ||
                    price.includes(searchTerm) ||
                    shopName.includes(searchTerm);
            });

            // Search orders (staff orders or customer orders)
            let matchedOrders = [];

            // For staff: search kitchen and transport orders
            if (['kitchen', 'owner', 'delivery', 'developer'].includes(userRole)) {
                const allStaffOrders = [...originalKitchenOrders, ...originalTransportOrders];
                matchedOrders = allStaffOrders.filter(doc => {
                    const order = doc.data();
                    const orderId = doc.id.toLowerCase();
                    const customerName = (order.customerName || '').toLowerCase();
                    const customerPhone = (order.customerPhone || '').toLowerCase();
                    const items = (order.items || []).map(item => item.name.toLowerCase()).join(' ');

                    return orderId.includes(searchTerm) ||
                        customerName.includes(searchTerm) ||
                        customerPhone.includes(searchTerm) ||
                        items.includes(searchTerm);
                });
            } else {
                // For customers: search their own orders
                matchedOrders = originalCustomerOrders.filter(order => {
                    const orderId = (order.id || '').toLowerCase();
                    const shopName = (allShops.find(s => s.id === order.shopId)?.name || '').toLowerCase();
                    const items = (order.items || []).map(item => item.name.toLowerCase()).join(' ');
                    const status = (order.status || '').toLowerCase();

                    return orderId.includes(searchTerm) ||
                        shopName.includes(searchTerm) ||
                        items.includes(searchTerm) ||
                        status.includes(searchTerm);
                });
            }

            // Render results
            renderUnifiedSearchResults(matchedShops, matchedMenuItems, matchedOrders, searchTerm);
        }

        function renderUnifiedSearchResults(shops, menuItems, orders, searchTerm) {
            const searchResults = document.getElementById('unified-search-results');

            const totalResults = shops.length + menuItems.length + orders.length;

            if (totalResults === 0) {
                searchResults.innerHTML = `
                    <div class="text-center py-12 text-gray-400">
                        <svg class="w-16 h-16 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <p class="text-lg font-medium mb-2">No results found</p>
                        <p class="text-sm">Try searching for something else</p>
                    </div>
                `;
                return;
            }

            let html = `<div class="text-sm text-gray-500 mb-4">Found ${totalResults} result${totalResults > 1 ? 's' : ''}</div>`;

            // Render Shops
            if (shops.length > 0) {
                html += `
                    <div class="mb-6">
                        <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wide mb-3">Shops (${shops.length})</h3>
                        <div class="space-y-2">
                            ${shops.slice(0, 5).map(shop => `
                                <div class="p-3 hover:bg-gray-50 rounded-lg cursor-pointer transition-colors" onclick="unifiedSearchSelectShop('${shop.id}', '${shop.name}')">
                                    <div class="flex items-center gap-3">
                                        <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center flex-shrink-0">
                                            <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                                            </svg>
                                        </div>
                                        <div class="flex-1 min-w-0">
                                            <p class="font-semibold text-gray-900 truncate">${shop.name}</p>
                                            <p class="text-sm text-gray-500 truncate">${shop.address || 'No address'}</p>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                            ${shops.length > 5 ? `<p class="text-xs text-gray-400 pl-3">+${shops.length - 5} more shops</p>` : ''}
                        </div>
                    </div>
                `;
            }

            // Render Menu Items
            if (menuItems.length > 0) {
                html += `
                    <div class="mb-6">
                        <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wide mb-3">Menu Items (${menuItems.length})</h3>
                        <div class="space-y-2">
                            ${menuItems.slice(0, 5).map(item => `
                                <div class="p-3 hover:bg-gray-50 rounded-lg cursor-pointer transition-colors" onclick="unifiedSearchSelectShop('${item.shopId}', '${item.shopName}')">
                                    <div class="flex items-center gap-3">
                                        <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center flex-shrink-0">
                                            <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                            </svg>
                                        </div>
                                        <div class="flex-1 min-w-0">
                                            <p class="font-semibold text-gray-900 truncate">${item.name}</p>
                                            <p class="text-sm text-gray-500">${item.shopName} • <span class="text-green-600 font-medium">₹${item.price}</span></p>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                            ${menuItems.length > 5 ? `<p class="text-xs text-gray-400 pl-3">+${menuItems.length - 5} more items</p>` : ''}
                        </div>
                    </div>
                `;
            }

            // Render Orders
            if (orders.length > 0) {
                html += `
                    <div class="mb-6">
                        <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wide mb-3">Orders (${orders.length})</h3>
                        <div class="space-y-2">
                            ${orders.slice(0, 5).map(order => {
                    // Handle both staff orders (Firestore docs) and customer orders (plain objects)
                    const orderData = order.data ? order.data() : order;
                    const orderId = order.id || order.id;
                    const shopName = allShops.find(s => s.id === orderData.shopId)?.name || 'Unknown Shop';
                    const itemCount = orderData.items?.length || 0;

                    return `
                                    <div class="p-3 hover:bg-gray-50 rounded-lg cursor-pointer transition-colors" onclick="unifiedSearchViewOrder('${orderId}')">
                                        <div class="flex items-center gap-3">
                                            <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center flex-shrink-0">
                                                <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                                                </svg>
                                            </div>
                                            <div class="flex-1 min-w-0">
                                                <p class="font-semibold text-gray-900 truncate">${orderData.customerName || 'Order'}</p>
                                                <p class="text-sm text-gray-500">${shopName} • ${itemCount} item${itemCount > 1 ? 's' : ''} • ₹${orderData.totalAmount}</p>
                                            </div>
                                            <span class="status-tag status-tag-${orderData.status} text-xs whitespace-nowrap">${orderData.status.replace(/_/g, ' ')}</span>
                                        </div>
                                    </div>
                                `;
                }).join('')}
                            ${orders.length > 5 ? `<p class="text-xs text-gray-400 pl-3">+${orders.length - 5} more orders</p>` : ''}
                        </div>
                    </div>
                `;
            }

            searchResults.innerHTML = html;
        }

        // Search result actions
        function unifiedSearchSelectShop(shopId, shopName) {
            document.getElementById('unified-search-modal').classList.add('hidden');
            selectShop(shopId, shopName);
        }

        function unifiedSearchViewOrder(orderId) {
            document.getElementById('unified-search-modal').classList.add('hidden');
            if (typeof viewOrderTracking === 'function') {
                viewOrderTracking(orderId);
            }
        }

        // Make functions global for onclick handlers
        window.unifiedSearchSelectShop = unifiedSearchSelectShop;
        window.unifiedSearchViewOrder = unifiedSearchViewOrder;


        async function handleEmailAuth(e, isSignup) {
            e.preventDefault();
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;
            const profileModal = document.getElementById('profile-modal');
            try {
                if (isSignup) {
                    await createUserWithEmailAndPassword(auth, email, password);
                } else {
                    await signInWithEmailAndPassword(auth, email, password);
                }
                showAlert(isSignup ? 'Account created successfully!' : 'Logged in successfully!');
                profileModal?.classList.add('hidden');
            } catch (error) {
                const messages = { 'auth/invalid-credential': 'Invalid email or password.', 'auth/user-not-found': 'Invalid email or password.', 'auth/wrong-password': 'Invalid email or password.', 'auth/email-already-in-use': 'This email is already registered. Please log in.', 'auth/weak-password': 'Password must be at least 6 characters long.' };
                showAlert(messages[error.code] || `Authentication failed. Code: ${error.code}`, true);
                console.error("Auth error:", error.code);
            }
        }

        async function handleGoogleLogin() {
            const provider = new GoogleAuthProvider();
            const isStandalone = window.matchMedia('(display-mode: standalone)').matches;

            try {
                // Always try popup first - it's more reliable when it works
                await signInWithPopup(auth, provider);
                document.getElementById('profile-modal')?.classList.add('hidden');
                showAlert('Logged in with Google successfully!');
            } catch (error) {
                console.warn("Google sign-in error:", error.code, error.message);

                // Handle specific error cases
                if (error.code === 'auth/popup-blocked' || error.code === 'auth/popup-closed-by-user' || error.code === 'auth/cancelled-popup-request') {
                    // Try redirect as fallback
                    try {
                        await signInWithRedirect(auth, provider);
                    } catch (redirectError) {
                        // If redirect also fails (common in standalone PWA), guide user to email login
                        if (isStandalone) {
                            showAlert("Google login is not available in the installed app. Please use Email/Password login above.", true);
                        } else {
                            showAlert("Login failed. Please try again or use Email/Password login.", true);
                        }
                    }
                } else if (error.code === 'auth/unauthorized-domain') {
                    showAlert("This domain is not authorized for Google login. Please use Email/Password login.", true);
                } else if (error.code === 'auth/network-request-failed') {
                    showAlert("Network error. Please check your internet connection.", true);
                } else if (isStandalone) {
                    // Generic fallback for standalone mode
                    showAlert("Google login may not work in the installed app. Please use Email/Password login above.", true);
                } else {
                    showAlert("Login failed: " + (error.message || error.code), true);
                }
            }
        }

        // Check for Redirect Result (for Mobile Auth return)
        if (isFirebaseReady) {
            getRedirectResult(auth).then((result) => {
                if (result) {
                    document.getElementById('profile-modal')?.classList.add('hidden');
                    showAlert('Logged in with Google successfully!');
                }
            }).catch((error) => {
                console.error("Redirect auth error:", error);
                showAlert(error.message, true);
            });
        }

        viewSwitcher.addEventListener('click', (e) => {
            if (e.target.tagName !== 'BUTTON') return;
            const view = e.target.dataset.view;

            orderQueryUnsubscribe?.(); orderQueryUnsubscribe = null;

            const allowed = {
                customer: ['customer', 'kitchen', 'delivery', 'owner', 'developer'],
                kitchen: ['kitchen', 'owner', 'developer'],
                transport: ['delivery', 'owner', 'developer'],
                owner: ['owner', 'developer'],
                developer: ['developer']
            };

            allowed.delivery = ['delivery', 'owner', 'developer']; // Fix for 'transport' view data name

            if (userRole === 'developer') {
                // No permission check needed for developer
            } else {
                if (!allowed[view]?.includes(userRole)) {
                    return showAlert("You don't have permission to access this view.", true);
                }
                if (['kitchen', 'transport', 'owner'].includes(view) && !currentUserShopId) {
                    return showAlert("You must be assigned to a shop to access this view.", true);
                }
            }

            Object.values(views).forEach(v => v.classList.add('view-hidden'));
            views[view].classList.remove('view-hidden');
            views[view].classList.add('view-active');

            // --- MODIFICATION: Updated to use querySelectorAll ---
            Array.from(viewSwitcher.querySelectorAll('button')).forEach(btn => btn.classList.toggle('btn-active', btn.dataset.view === view));

            if (currentUserShopId) {
                if (view === 'owner') {
                    loadOwnerDashboard();
                    listenToOrderHistory();
                } else if (view === 'kitchen' || view === 'transport') {
                    listenToStaffOrders();
                }
            }

            if (view === 'developer' && userRole === 'developer') {
                orderCurrentPage = 1;
                orderFirstVisibleDoc = null;
                orderLastVisibleDoc = null;
                orderDateFilter = 'all';
                updateOrderFilterButtons();
                loadAllOrders('start');
                updateDevSummary();
            }
        });

        function loadOwnerDashboard() {
            if (!isFirebaseReady) return;
            if (!['owner', 'developer'].includes(userRole)) return;

            if (!currentUserShopId) {
                if (userRole === 'developer') {
                    document.getElementById('kpi-total-revenue').textContent = `₹0`;
                    document.getElementById('kpi-total-orders').textContent = `0`;
                    document.getElementById('kpi-avg-order-value').textContent = `₹0`;
                    document.getElementById('owner-view-title').textContent = 'Owner Dashboard';
                    document.getElementById('owner-view').querySelector('p').textContent = 'Please select a shop from the Dev Panel to view its dashboard.';
                    salesChartInstance?.destroy();
                    statusChartInstance?.destroy();
                }
                return;
            }

            document.getElementById('owner-view-title').textContent = currentShopName ? `${currentShopName} - Dashboard` : 'Owner Dashboard';
            document.getElementById('owner-view').querySelector('p').textContent = 'A high-level overview of your kitchen\'s performance.';

            onSnapshot(query(collection(db, "orders"), where("shopId", "==", currentUserShopId)), (snapshot) => {
                updateDashboard(snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id })))
            });
            loadStaffList();
            listenToCashTransactions();
            listenToUnsettledCashOrders();
        }


        function updateDashboard(allOrders) {
            // Filter out test orders for real revenue/orders in production dashboard
            const liveOrders = allOrders.filter(o => !o.isTestOrder);

            const totalRevenue = liveOrders.reduce((sum, order) => sum + (order.totalAmount || 0), 0);
            const totalOrders = liveOrders.length;
            const avgOrderValue = totalOrders > 0 ? totalRevenue / totalOrders : 0;
            document.getElementById('kpi-total-revenue').textContent = `₹${totalRevenue.toFixed(2)}`;
            document.getElementById('kpi-total-orders').textContent = totalOrders;
            document.getElementById('kpi-avg-order-value').textContent = `₹${avgOrderValue.toFixed(2)}`;
            drawSalesChart(liveOrders); // Use liveOrders for accurate charts
            drawStatusChart(liveOrders); // Use liveOrders for accurate charts
        }

        function drawSalesChart(orders) {
            const ctx = document.getElementById('sales-chart-canvas')?.getContext('2d');
            if (!ctx) return;
            salesChartInstance?.destroy();
            const salesByDate = orders.reduce((acc, order) => {
                if (order.createdAt?.toDate) {
                    const date = order.createdAt.toDate().toLocaleDateString('en-CA');
                    acc[date] = (acc[date] || 0) + (order.totalAmount || 0);
                }
                return acc;
            }, {});
            const sortedDates = Object.keys(salesByDate).sort();
            salesChartInstance = new Chart(ctx, { type: 'bar', data: { labels: sortedDates.map(d => new Date(d).toLocaleDateString('en-GB', { day: 'numeric', month: 'short' })), datasets: [{ label: 'Sales', data: sortedDates.map(d => salesByDate[d]), backgroundColor: 'rgba(94, 92, 230, 0.8)', borderRadius: 8 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { callback: v => '₹' + v } } }, plugins: { legend: { display: false }, tooltip: { callbacks: { label: c => ` Sales: ₹${c.raw.toFixed(2)}` } } } } });
        }

        function drawStatusChart(orders) {
            const ctx = document.getElementById('status-chart-canvas')?.getContext('2d');
            if (!ctx) return;
            statusChartInstance?.destroy();
            const statusCounts = orders.reduce((acc, order) => {
                const status = order.status ? order.status.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()) : 'Unknown';
                acc[status] = (acc[status] || 0) + 1;
                return acc;
            }, {});
            const statusLabels = Object.keys(statusCounts);
            const statusColors = { 'New': '#0071e3', 'Preparing': '#f59e0b', 'Ready For Pickup': '#10b981', 'Out For Delivery': '#6366f1', 'Completed': '#4b5563' };
            statusChartInstance = new Chart(ctx, { type: 'doughnut', data: { labels: statusLabels, datasets: [{ label: 'Orders', data: Object.values(statusCounts), backgroundColor: statusLabels.map(l => statusColors[l] || '#cccccc'), borderColor: '#ffffff', borderWidth: 4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } } });
        }

        function listenToOrderHistory() {
            if (!['owner', 'developer'].includes(userRole)) return;

            const listEl = document.getElementById('order-history-list');
            if (!currentUserShopId) {
                if (userRole === 'developer' && listEl) listEl.innerHTML = '<p class="text-gray-500 text-center py-4">Select a shop from the Dev Panel to see history.</p>';
                return;
            }

            onSnapshot(query(collection(db, "orders"), where("status", "==", "completed"), where("shopId", "==", currentUserShopId)), snapshot => {
                // Filter out test orders for history view
                completedOrders = snapshot.docs
                    .map(d => ({ id: d.id, ...d.data() }))
                    .filter(o => !o.isTestOrder)
                    .sort((a, b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0));
                filterAndRenderHistory();
            });
        }

        function filterAndRenderHistory() {
            const listEl = document.getElementById('order-history-list');
            if (!listEl) return;
            if (!currentUserShopId && userRole === 'developer') {
                listEl.innerHTML = '<p class="text-gray-500 text-center py-4">Select a shop from the Dev Panel to see history.</p>';
                return;
            }
            const now = new Date(); const startOfWeek = new Date(now); startOfWeek.setDate(startOfWeek.getDate() - startOfWeek.getDay()); startOfWeek.setHours(0, 0, 0, 0); const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
            let filtered = completedOrders;
            if (historyFilter === 'week') filtered = completedOrders.filter(o => o.createdAt?.toDate() >= startOfWeek);
            if (historyFilter === 'month') filtered = completedOrders.filter(o => o.createdAt?.toDate() >= startOfMonth);
            listEl.innerHTML = filtered.length === 0 ? `<p class="text-gray-500 text-center py-4">No past orders for this period.</p>` : filtered.map(o => `<div class="bg-gray-50 p-4 rounded-lg border"><div class="flex justify-between items-start"><div><p class="font-semibold">${o.customerName}</p><p class="text-sm text-gray-500">${o.createdAt.toDate().toLocaleDateString('en-GB', { year: 'numeric', month: 'long', day: 'numeric' })}</p><p class="text-sm text-gray-600 mt-1">Total: ₹${o.totalAmount}</p></div><div class="flex flex-col items-end gap-2"><p class="text-xs text-gray-500 bg-white px-2 py-1 rounded-md">ID: ${o.id.substring(0, 8)}</p>${o.isTestOrder ? '<span class="text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full">TEST</span>' : ''}</div></div><p class="text-sm text-gray-500 mt-2 pt-2 border-t">Items: ${o.items.map(i => `${i.name} x${i.quantity}`).join(', ')}</p></div>`).join('');
        }

        function updateHistoryFilterButtons() {
            document.querySelectorAll('.history-filter-btn').forEach(btn => btn.classList.toggle('btn-active', btn.dataset.filter === historyFilter));
        }

        async function loadStaffList() {
            if (!['owner', 'developer'].includes(userRole)) return;

            const staffListEl = document.getElementById('staff-list');
            if (!currentUserShopId) {
                if (userRole === 'developer' && staffListEl) staffListEl.innerHTML = '<p class="text-gray-500">Select a shop from the Dev Panel to see staff.</p>';
                return;
            }

            const snapshot = await getDocs(query(collection(db, "users"), where("role", "in", ["kitchen", "delivery"]), where("shopId", "==", currentUserShopId)));
            staffListEl.innerHTML = snapshot.empty ? '<p class="text-gray-500">No staff members found.</p>' : snapshot.docs.map(doc => { const s = doc.data(); return `<div class="flex justify-between items-center bg-gray-50 p-3 rounded-lg"><div><p class="font-medium">${s.email}</p><p class="text-sm text-gray-500 capitalize">${s.role}</p></div><button data-id="${doc.id}" class="remove-staff-btn bg-red-100 text-red-700 px-3 py-1 rounded-md text-sm hover:bg-red-200">Remove</button></div>` }).join('');
        }

        // --- CASH AUDIT MANAGEMENT ---
        let cashTransactionsUnsubscribe = null;
        let unsettledOrdersUnsubscribe = null;

        function listenToCashTransactions() {
            if (!currentUserShopId) return;
            if (cashTransactionsUnsubscribe) cashTransactionsUnsubscribe();

            const q = query(
                collection(db, "cash_transactions"),
                where("shopId", "==", currentUserShopId),
                orderBy("timestamp", "desc"),
                limit(100)
            );

            cashTransactionsUnsubscribe = onSnapshot(q, (snapshot) => {
                let collected = 0;
                let settled = 0;
                snapshot.docs.forEach(doc => {
                    const tx = doc.data();
                    if (tx.type === 'collection') collected += (tx.amount || 0);
                    else if (tx.type === 'settlement') settled += (tx.amount || 0);
                });

                document.getElementById('owner-cash-total-collected').textContent = `₹${collected.toFixed(0)}`;
                document.getElementById('owner-cash-total-settled').textContent = `₹${settled.toFixed(0)}`;
                document.getElementById('owner-cash-outstanding').textContent = `₹${(collected - settled).toFixed(0)}`;
            });
        }

        function listenToUnsettledCashOrders() {
            if (!currentUserShopId) return;
            if (unsettledOrdersUnsubscribe) unsettledOrdersUnsubscribe();

            const q = query(
                collection(db, "orders"),
                where("shopId", "==", currentUserShopId),
                where("paymentMethod", "==", "cash"),
                where("cashStatus", "==", "collected")
            );

            unsettledOrdersUnsubscribe = onSnapshot(q, async (snapshot) => {
                const listEl = document.getElementById('owner-unsettled-cash-list');
                if (snapshot.empty) {
                    listEl.innerHTML = '<tr><td colspan="4" class="px-6 py-8 text-center text-gray-400 italic text-sm">No unsettled cash orders.</td></tr>';
                    return;
                }

                // Fetch delivery users to show names
                const deliveryStaffDocs = await getDocs(query(collection(db, "users"), where("shopId", "==", currentUserShopId), where("role", "==", "delivery")));
                const staffMap = {};
                deliveryStaffDocs.forEach(d => staffMap[d.id] = d.data().displayName || d.data().email);

                listEl.innerHTML = snapshot.docs.map(doc => {
                    const o = doc.data();
                    const deliveryStaff = staffMap[o.deliveryStaffId] || 'Unknown Staff';
                    const date = o.createdAt?.toDate() ? o.createdAt.toDate().toLocaleDateString('en-GB') : 'N/A';

                    return `
                        <tr>
                            <td class="px-6 py-4">
                                <p class="text-sm font-bold text-gray-900">#${doc.id.substring(0, 6)}</p>
                                <p class="text-xs text-gray-500">${o.customerName} • ${date}</p>
                            </td>
                            <td class="px-6 py-4">
                                <div class="flex items-center gap-2">
                                    <div class="w-6 h-6 rounded-full bg-purple-100 flex items-center justify-center text-[10px] text-purple-600 font-bold">
                                        ${deliveryStaff.charAt(0).toUpperCase()}
                                    </div>
                                    <span class="text-sm text-gray-700">${deliveryStaff}</span>
                                </div>
                            </td>
                            <td class="px-6 py-4">
                                <span class="text-sm font-bold text-gray-900">₹${o.totalAmount}</span>
                            </td>
                            <td class="px-6 py-4 text-center">
                                <button onclick="settleCashOrder('${doc.id}', ${o.totalAmount}, '${o.deliveryStaffId}')" 
                                    class="bg-green-600 text-white px-4 py-1.5 rounded-lg text-xs font-bold hover:bg-green-700 transition-colors shadow-sm">
                                    SETTLE
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');
            });
        }

        window.settleCashOrder = async function (orderId, amount, deliveryStaffId) {
            if (!confirm(`Confirm settlement of ₹${amount} for order #${orderId.substring(0, 6)}?`)) return;

            try {
                const batch = writeBatch(db);

                // 1. Update order status
                const orderRef = doc(db, "orders", orderId);
                batch.update(orderRef, { cashStatus: 'settled' });

                // 2. Create settlement transaction
                const txRef = doc(collection(db, "cash_transactions"));
                batch.set(txRef, {
                    shopId: currentUserShopId,
                    orderId: orderId,
                    userId: deliveryStaffId,
                    amount: amount,
                    type: 'settlement',
                    timestamp: serverTimestamp(),
                    settledBy: userId
                });

                await batch.commit();
                showAlert(`Order #${orderId.substring(0, 6)} settled successfully.`);
            } catch (error) {
                console.error("Error settling cash order:", error);
                showAlert("Failed to settle order: " + error.message, true);
            }
        }

        async function addStaff() {
            if (!currentUserShopId) {
                const msg = (userRole === 'developer') ? "Please select a shop from the Dev Panel first." : "You must manage a shop to add staff.";
                return showAlert(msg, true);
            }
            const email = document.getElementById('staff-email').value; const role = document.getElementById('staff-role').value;
            const snapshot = await getDocs(query(collection(db, "users"), where("email", "==", email)));
            if (snapshot.empty) return showAlert("Error: User must sign up first before being assigned a role.", true);
            await setDoc(doc(db, "users", snapshot.docs[0].id), { role, shopId: currentUserShopId }, { merge: true });
            showAlert(`Role updated for ${email}.`); document.getElementById('add-staff-form').reset(); loadStaffList();
        }

        // --- Notification Functions ---

        /**
         * Creates a new notification document in Firestore.
         * @param {object} data - Notification data ({ userId, message, orderId, role, shopId })
         */
        async function createNotification(data) {
            if (!db) return;
            try {
                // Notification Fix: Only create notifications if a relevant UID is provided (staff/owner or customer)
                if (data.userId || data.role) {
                    await addDoc(collection(db, "notifications"), {
                        ...data,
                        createdAt: serverTimestamp(),
                        read: false,
                    });
                }
            } catch (error) {
                console.error("Error creating notification:", error);
            }
        }

        // --- Notification State Management ---
        let pendingNotificationUpdate = false; // Flag to prevent re-render during optimistic updates

        /**
         * Sets up the real-time listener for notifications based on user role.
         */
        function listenForNotifications() {
            if (notificationListener) notificationListener();

            if (!auth.currentUser || auth.currentUser.isAnonymous) {
                updateNotificationUI([]);
                return;
            }

            let q;
            if (userId && !userId.includes('offline-guest')) {
                // Everyone (Customers, Staff, Owners, Developers) now only sees notifications directed specifically to them.
                // This ensures they have permission to delete them and prevents "permission denied" errors.
                // We sort locally for everyone to keep queries simple and avoid composite index errors.
                q = query(collection(db, "notifications"), where("userId", "==", userId), limit(50));
            } else {
                updateNotificationUI([]);
                return;
            }

            notificationListener = onSnapshot(q, (snapshot) => {
                if (pendingNotificationUpdate) return;
                let notifications = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                // Sort all notifications locally by creation time (descending)
                notifications.sort((a, b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0));
                allNotifications = notifications;
                updateNotificationUI(allNotifications);
            }, (error) => {
                console.error("Error listening for notifications:", error);
            });
        }

        // --- Notification UI Updates ---
        /**
         * Updates the notification bell icon and panel.
         * @param {Array} notifications - List of notification objects.
         */
        function updateNotificationUI(notifications) {
            const listEl = document.getElementById('notification-list');
            const dotEl = document.getElementById('notification-dot');
            const panelEl = document.getElementById('notification-panel');

            if (!listEl || !dotEl || !panelEl) return;

            const unreadCount = notifications.filter(n => !n.read).length;
            dotEl.classList.toggle('hidden', unreadCount === 0);

            // NEW: Trigger System Notification for the latest unread notification
            if (unreadCount > 0 && notifications.length > 0) {
                const latest = notifications[0];
                const now = Date.now();
                const notifTime = latest.createdAt ? latest.createdAt.toMillis() : now;
                if (now - notifTime < 10000 && !latest.read) {
                    if (Notification.permission === 'granted') {
                        navigator.serviceWorker.ready.then(registration => {
                            registration.showNotification('Foody Vrinda', {
                                body: latest.message,
                                icon: './public/foodyVrinda-logo.png',
                                vibrate: [200, 100, 200],
                                tag: latest.id
                            });
                        });
                    }
                }
            }

            if (notifications.length === 0) {
                listEl.innerHTML = `<p class="p-4 text-gray-500 text-center">No notifications.</p>`;
            } else {
                listEl.innerHTML = notifications.map(n => {
                    const time = n.createdAt ? new Date(n.createdAt.toMillis()).toLocaleString('en-US', { hour: 'numeric', minute: '2-digit', day: 'numeric', month: 'short' }) : 'Just now';
                    const isRead = n.read;

                    // Use button instead of checkbox for more reliable toggle
                    const toggleBtn = isRead
                        ? `<button type="button" onclick="event.stopPropagation(); toggleNotificationRead('${n.id}', false)" 
                            class="w-5 h-5 rounded border-2 border-green-500 bg-green-500 flex items-center justify-center flex-shrink-0 hover:bg-green-600 transition-colors" 
                            title="Mark as unread">
                            <svg class="w-3 h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>
                          </button>`
                        : `<button type="button" onclick="event.stopPropagation(); toggleNotificationRead('${n.id}', true)" 
                            class="w-5 h-5 rounded border-2 border-gray-300 bg-white flex items-center justify-center flex-shrink-0 hover:border-green-500 transition-colors" 
                            title="Mark as read"></button>`;

                    return `
                    <div class="p-3 hover:bg-gray-50 ${isRead ? 'bg-white' : 'bg-blue-50'} flex items-start gap-3 transition-colors">
                        ${toggleBtn}
                        <div class="flex-1 min-w-0 cursor-pointer" onclick="handleNotificationClick('${n.id}', '${n.orderId || ''}')">
                            <p class="text-sm ${isRead ? 'text-gray-600' : 'text-gray-900 font-medium'}">${n.message}</p>
                            <p class="text-xs text-gray-400 mt-1">${time}</p>
                        </div>
                        ${!isRead ? '<span class="w-2 h-2 bg-blue-500 rounded-full flex-shrink-0 mt-2"></span>' : ''}
                    </div>`;
                }).join('');
            }

            // Update button states based on notification counts
            const markAllBtn = document.getElementById('mark-all-read-btn');
            const clearBtn = document.getElementById('clear-all-notifications');
            const readCount = notifications.filter(n => n.read).length;

            if (markAllBtn) {
                markAllBtn.disabled = unreadCount === 0;
                markAllBtn.classList.toggle('opacity-50', unreadCount === 0);
            }
            if (clearBtn) {
                clearBtn.disabled = readCount === 0;
                clearBtn.classList.toggle('opacity-50', readCount === 0);
            }
        }

        // Notification Function: Toggle read/unread status with OPTIMISTIC UI UPDATE
        window.toggleNotificationRead = async (id, isRead) => {
            if (!db) return;

            // OPTIMISTIC UPDATE: Update local state immediately
            const notifIndex = allNotifications.findIndex(n => n.id === id);
            if (notifIndex !== -1) {
                allNotifications[notifIndex].read = isRead;
                pendingNotificationUpdate = true;
                updateNotificationUI(allNotifications);
            }

            try {
                await updateDoc(doc(db, "notifications", id), { read: isRead });
            } catch (error) {
                console.error("Error toggling notification read status:", error);
                // Revert on error
                if (notifIndex !== -1) {
                    allNotifications[notifIndex].read = !isRead;
                    updateNotificationUI(allNotifications);
                }
            } finally {
                pendingNotificationUpdate = false;
            }
        }

        // Notification Function: Handle click on notification content
        window.handleNotificationClick = async (notificationId, orderId) => {
            // Mark as read
            await toggleNotificationRead(notificationId, true);

            // If there's an order, navigate to it
            if (orderId) {
                document.getElementById('notification-panel').classList.add('hidden');

                const targetView = (userRole === 'delivery' || userRole === 'transport') ? 'transport' : 'kitchen';
                const viewButton = document.querySelector(`button[data-view="${targetView}"]`);

                if (viewButton && !viewButton.classList.contains('hidden')) {
                    viewButton.click();
                }
            }
        }

        // Notification Function: Mark a single notification as read (kept for compatibility)
        window.markSingleNotificationRead = async (id) => {
            await toggleNotificationRead(id, true);
        }

        // Notification Function: Mark as read and attempt to switch to kitchen/transport view
        window.markNotificationReadAndOpenOrder = async (notificationId, orderId) => {
            await handleNotificationClick(notificationId, orderId);
        }

        /**
         * Marks all unread notifications as read in Firestore with OPTIMISTIC UI UPDATE.
         */
        window.markNotificationsAsRead = async function () {
            const unreadIds = allNotifications.filter(n => !n.read).map(n => n.id);
            if (unreadIds.length === 0) return;

            // OPTIMISTIC UPDATE: Update local state immediately
            pendingNotificationUpdate = true;
            allNotifications.forEach(n => { n.read = true; });
            updateNotificationUI(allNotifications);

            try {
                const batch = writeBatch(db);
                unreadIds.forEach(id => {
                    batch.update(doc(db, "notifications", id), { read: true });
                });
                await batch.commit();
            } catch (error) {
                console.error("Error marking notifications as read:", error);
                // Note: On error, the next snapshot will correct the state
            } finally {
                pendingNotificationUpdate = false;
            }
        }

        /**
         * Deletes only READ notifications for the current user/query.
         * Unread notifications are preserved to ensure staff don't miss important orders.
         */
        window.clearAllNotifications = async function () {
            const readNotifications = allNotifications.filter(n => n.read);

            if (readNotifications.length === 0) {
                showAlert("No read notifications to clear. You must mark notifications as read first.", true);
                return;
            }

            const unreadCount = allNotifications.filter(n => !n.read).length;
            const message = unreadCount > 0
                ? `Clear ${readNotifications.length} read notification(s)? ${unreadCount} unread notification(s) will be kept.`
                : `Clear all ${readNotifications.length} notification(s)?`;

            showAlert(message, false, async () => {
                // OPTIMISTIC UPDATE: Remove from local state immediately
                const remaining = allNotifications.filter(n => !n.read);
                pendingNotificationUpdate = true;
                allNotifications = remaining;
                updateNotificationUI(remaining);

                if (remaining.length === 0) {
                    document.getElementById('notification-panel').classList.add('hidden');
                }

                try {
                    const batch = writeBatch(db);
                    readNotifications.forEach(n => {
                        batch.delete(doc(db, "notifications", n.id));
                    });
                    await batch.commit();
                } catch (error) {
                    console.error("Error clearing notifications:", error);
                    showAlert("Failed to clear notifications. You may only clear your own notifications.", true);
                } finally {
                    pendingNotificationUpdate = false;
                }
            });
        }

        // --- END Notification Functions ---

        /**
         * Shows a temporary toast notification.
         * @param {string} message - The message to display.
         * @param {string} type - 'success', 'error', or 'info'
         */

        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            if (!container) return;

            const toast = document.createElement('div');
            toast.className = `pointer-events-auto flex items-center w-full max-w-xs p-4 space-x-4 text-gray-500 bg-white rounded-lg shadow dark:text-gray-400 dark:bg-gray-800 transform transition-all duration-300 translate-x-full opacity-0`;

            let icon = '';
            if (type === 'success') icon = '<div class="inline-flex items-center justify-center flex-shrink-0 w-8 h-8 text-green-500 bg-green-100 rounded-lg"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg></div>';
            else if (type === 'error') icon = '<div class="inline-flex items-center justify-center flex-shrink-0 w-8 h-8 text-red-500 bg-red-100 rounded-lg"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg></div>';
            else icon = '<div class="inline-flex items-center justify-center flex-shrink-0 w-8 h-8 text-blue-500 bg-blue-100 rounded-lg"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a6 6 0 00-6 6v3.586l-.707.707A1 1 0 004 14h12a1 1 0 00.707-1.707L16 11.586V8a6 6 0 00-6-6zM10 18a3 3 0 01-3-3h6a3 3 0 01-3 3z"></path></svg></div>';

            toast.innerHTML = `${icon}<div class="pl-4 text-sm font-normal">${message}</div>`;
            container.appendChild(toast);

            // Animate in
            requestAnimationFrame(() => {
                toast.classList.remove('translate-x-full', 'opacity-0');
            });

            // Remove after 5 seconds
            setTimeout(() => {
                toast.classList.add('translate-x-full', 'opacity-0');
                setTimeout(() => {
                    if (container.contains(toast)) container.removeChild(toast);
                }, 300);
            }, 5000);
        }

        // --- Developer Panel Logic ---

        async function loadDeveloperPanel() {
            await loadAllShops();
            await loadAdminPanel();
            const orderSearchInput = document.getElementById('order-search-input-dev');
            if (orderSearchInput) {
                orderSearchInput.addEventListener('input', () => {
                    orderCurrentPage = 1;
                    orderFirstVisibleDoc = null;
                    orderLastVisibleDoc = null;
                    loadAllOrders('start');
                });
            }
            const menuShopSelect = document.getElementById('dev-menu-shop-select');
            if (menuShopSelect) {
                menuShopSelect.addEventListener('change', (e) => {
                    const shopId = e.target.value;
                    const managerContent = document.getElementById('dev-menu-manager-content');
                    if (shopId) {
                        if (managerContent) managerContent.classList.remove('hidden');
                        renderDevMenuItemList(shopId);
                    } else {
                        if (managerContent) managerContent.classList.add('hidden');
                        const menuList = document.getElementById('dev-menu-item-list');
                        if (menuList) menuList.innerHTML = '<p class="text-gray-500">Select a shop to see its menu.</p>';
                    }
                });
            }
            const testOrderShopSelect = document.getElementById('test-order-shop-select');
            if (testOrderShopSelect) {
                testOrderShopSelect.addEventListener('change', (e) => {
                    renderTestMenuItems(e.target.value);
                });
            }

            document.querySelectorAll('#developer-view .sortable-header').forEach(header => {
                header.addEventListener('click', handleUserSort);
            });
            updateDevSummary();
            loadAllOrders('start');
        }

        async function updateDevSummary() {
            if (userRole !== 'developer') return;
            try {
                if (document.getElementById('summary-shops-count')) document.getElementById('summary-shops-count').textContent = allShops.length;

                // Filter out anonymous guests for better user count accuracy
                const usersSnapshot = await getDocs(collection(db, "users"));
                const realUsers = usersSnapshot.docs.filter(doc => doc.data().email && doc.data().email !== DEVELOPER_EMAIL);
                if (document.getElementById('summary-users-count')) document.getElementById('summary-users-count').textContent = realUsers.length;

                const allOrdersSnapshot = await getDocs(collection(db, "orders"));
                if (document.getElementById('summary-orders-count')) document.getElementById('summary-orders-count').textContent = allOrdersSnapshot.size;

                if (document.getElementById('summary-firebase-status')) {
                    document.getElementById('summary-firebase-status').textContent = 'CONNECTED';
                    document.getElementById('summary-firebase-status').className = 'text-sm font-bold text-green-600';
                }
            } catch (error) {
                console.error("Error updating dev summary:", error);
                if (document.getElementById('summary-firebase-status')) {
                    document.getElementById('summary-firebase-status').textContent = 'ERROR';
                    document.getElementById('summary-firebase-status').className = 'text-sm font-bold text-red-600';
                }
            }
        }


        function populateShopDropdowns() {
            const shopOptions = allShops.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
            document.getElementById('dev-menu-shop-select').innerHTML = `<option value="">-- Select a Shop --</option>${shopOptions}`;
            document.getElementById('test-order-shop-select').innerHTML = `<option value="">-- Select a Shop --</option>${shopOptions}`;
            document.getElementById('dev-dashboard-shop-select').innerHTML = `<option value="">-- Select a Shop --</option>${shopOptions}`;
            document.getElementById('dev-staff-shop').innerHTML = `<option value="">-- Assign Shop --</option>${shopOptions}`;
            document.getElementById('dev-delivery-shop-select').innerHTML = `<option value="">-- Select a Shop --</option>${shopOptions}`;
            document.getElementById('cash-audit-shop-select').innerHTML = `<option value="">-- All Shops --</option>${shopOptions}`;
        }

        async function renderDevShopList() {
            const container = document.getElementById('dev-shop-list');
            if (!container) return;
            if (allShops.length === 0) {
                container.innerHTML = '<p class="text-gray-500">No shops created yet.</p>';
                return;
            }

            // Fetch staff counts for all shops
            try {
                const usersSnapshot = await getDocs(collection(db, "users"));
                const staffByShop = {};

                // Initialize counts for each shop
                allShops.forEach(shop => {
                    staffByShop[shop.id] = { kitchen: 0, delivery: 0, owner: 0 };
                });

                // Count staff per shop (handle both shopId and shopIds)
                usersSnapshot.docs.forEach(docSnap => {
                    const userData = docSnap.data();
                    if (!userData.role || userData.role === 'customer' || userData.role === 'developer') return;

                    // Handle delivery staff with multiple shops (shopIds array)
                    if (userData.role === 'delivery' && userData.shopIds && Array.isArray(userData.shopIds)) {
                        userData.shopIds.forEach(shopId => {
                            if (staffByShop[shopId]) {
                                staffByShop[shopId].delivery++;
                            }
                        });
                    }
                    // Handle single shopId (kitchen, owner, or legacy delivery)
                    else if (userData.shopId && staffByShop[userData.shopId]) {
                        if (userData.role === 'kitchen') staffByShop[userData.shopId].kitchen++;
                        else if (userData.role === 'owner') staffByShop[userData.shopId].owner++;
                        else if (userData.role === 'delivery') staffByShop[userData.shopId].delivery++;
                    }
                });

                container.innerHTML = allShops.map(shop => {
                    const counts = staffByShop[shop.id] || { kitchen: 0, delivery: 0, owner: 0 };
                    const totalStaff = counts.kitchen + counts.delivery + counts.owner;

                    return `
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <div class="flex justify-between items-start mb-3">
                            <div class="flex-1 min-w-0 mr-3">
                                <p class="font-semibold text-gray-900">${shop.name}</p>
                                <p class="text-sm text-gray-500">${shop.address || 'No address'}</p>
                                ${shop.image ? `<p class="text-xs text-gray-400 truncate mt-1" title="${shop.image}">📷 Image set</p>` : ''}
                            </div>
                            <div class="flex gap-2 flex-shrink-0">
                                <button data-id="${shop.id}" class="dev-edit-shop-btn bg-blue-100 text-blue-700 px-3 py-1 rounded-md text-sm hover:bg-blue-200 flex items-center gap-1">
                                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                                    Edit
                                </button>
                                <button data-id="${shop.id}" class="dev-remove-shop-btn bg-red-100 text-red-700 px-3 py-1 rounded-md text-sm hover:bg-red-200">Remove</button>
                            </div>
                        </div>
                        <div class="flex flex-wrap gap-2 mt-2">
                            <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-medium ${counts.owner > 0 ? 'bg-purple-100 text-purple-700' : 'bg-gray-200 text-gray-500'}">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path></svg>
                                ${counts.owner} Owner${counts.owner !== 1 ? 's' : ''}
                            </span>
                            <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-medium ${counts.kitchen > 0 ? 'bg-orange-100 text-orange-700' : 'bg-gray-200 text-gray-500'}">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                ${counts.kitchen} Kitchen
                            </span>
                            <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-medium ${counts.delivery > 0 ? 'bg-blue-100 text-blue-700' : 'bg-gray-200 text-gray-500'}">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                                ${counts.delivery} Delivery
                            </span>
                            <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-600">
                                Total: ${totalStaff}
                            </span>
                        </div>
                    </div>`;
                }).join('');
            } catch (error) {
                console.error("Error loading staff counts:", error);
                container.innerHTML = '<p class="text-red-500">Error loading shop data.</p>';
            }
        }

        async function createShop(e) {
            e.preventDefault();
            const name = document.getElementById('shop-name').value;
            const address = document.getElementById('shop-address').value;
            const image = document.getElementById('shop-image').value;
            const phone = document.getElementById('shop-phone').value;
            const lat = parseFloat(document.getElementById('shop-lat').value);
            const lng = parseFloat(document.getElementById('shop-lng').value);

            // Get Wait Time and Display Settings
            const estimatedWaitTime = parseInt(document.getElementById('shop-wait-time').value) || 15;
            const showWaitTime = document.getElementById('shop-show-wait').checked;
            const showOrderQueue = document.getElementById('shop-show-queue').checked;

            // Get schedule data
            const openTime = document.getElementById('shop-open-time').value;
            const closeTime = document.getElementById('shop-close-time').value;
            const daysOpen = Array.from(document.querySelectorAll('input[name="shop-days"]:checked')).map(cb => cb.value);
            const timePeriods = Array.from(document.querySelectorAll('input[name="shop-periods"]:checked')).map(cb => cb.value);

            const shopData = {
                name,
                address,
                image: image || null,
                phoneNumber: phone || null,
                latitude: isNaN(lat) ? null : lat,
                longitude: isNaN(lng) ? null : lng,
                rating: 0.0,
                ratingCount: 0,
                estimatedWaitTime,
                showWaitTime,
                showOrderQueue,
                createdAt: serverTimestamp(),
                alarmSettings: {
                    kitchenNew: true,
                    kitchenReady: false,
                    deliveryReady: true
                }
            };

            // Add schedule if provided
            if (openTime || closeTime || daysOpen.length > 0 || timePeriods.length > 0) {
                shopData.schedule = {
                    openTime: openTime || "09:00",
                    closeTime: closeTime || "21:00",
                    daysOpen: daysOpen.length > 0 ? daysOpen : ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                    timePeriods: timePeriods
                };
            }

            try {
                await addDoc(collection(db, "shops"), shopData);
                showAlert('Shop created successfully!');
                document.getElementById('create-shop-form').reset();
                await loadAllShops();
            } catch (error) {
                console.error("Error creating shop: ", error);
                showAlert("Failed to create shop.", true);
            }
        }

        // --- EDIT SHOP FUNCTIONS ---
        function openEditShopModal(shopId) {
            const shop = allShops.find(s => s.id === shopId);
            if (!shop) {
                showAlert('Shop not found.', true);
                return;
            }

            const modal = document.getElementById('edit-shop-modal');

            // Populate form with current shop data
            document.getElementById('edit-shop-id').value = shopId;
            document.getElementById('edit-shop-name').value = shop.name || '';
            document.getElementById('edit-shop-address').value = shop.address || '';
            document.getElementById('edit-shop-image').value = shop.image || '';
            document.getElementById('edit-shop-phone').value = shop.phoneNumber || '';
            document.getElementById('edit-shop-lat').value = shop.latitude || '';
            document.getElementById('edit-shop-lng').value = shop.longitude || '';
            document.getElementById('edit-shop-wait-time').value = shop.estimatedWaitTime || 15;
            document.getElementById('edit-shop-show-wait').checked = shop.showWaitTime !== false;
            document.getElementById('edit-shop-show-queue').checked = shop.showOrderQueue === true;

            // Populate pricing configuration fields
            document.getElementById('edit-shop-min-order').value = shop.minimumOrderAmount || 0;
            document.getElementById('edit-shop-delivery-charge').value = shop.deliveryCharge || 0;
            document.getElementById('edit-shop-gst').value = shop.gstPercentage || 5;

            // Set schedule values
            const sched = shop.schedule || {};
            document.getElementById('edit-shop-open-time').value = sched.openTime || '09:00';
            document.getElementById('edit-shop-close-time').value = sched.closeTime || '21:00';

            const days = sched.daysOpen || [];
            document.querySelectorAll('input[name="edit-shop-days"]').forEach(cb => {
                cb.checked = days.includes(cb.value);
            });

            const periods = sched.timePeriods || [];
            document.querySelectorAll('input[name="edit-shop-periods"]').forEach(cb => {
                cb.checked = periods.includes(cb.value);
            });

            // Handle image preview
            const previewContainer = document.getElementById('edit-shop-image-preview');
            const previewImg = document.getElementById('edit-shop-image-img');
            if (shop.image) {
                previewImg.src = shop.image;
                previewContainer.classList.remove('hidden');
            } else {
                previewContainer.classList.add('hidden');
            }

            // Populate alarm data
            const alarms = shop.alarmSettings || { kitchenNew: true, kitchenReady: false, deliveryReady: true };
            document.getElementById('edit-alarm-kitchen-new').checked = alarms.kitchenNew !== false;
            document.getElementById('edit-alarm-kitchen-ready').checked = !!alarms.kitchenReady;
            document.getElementById('edit-alarm-delivery-ready').checked = alarms.deliveryReady !== false;

            // Show modal
            modal.classList.remove('hidden');
        }

        async function saveShopEdit(e) {
            e.preventDefault();

            const shopId = document.getElementById('edit-shop-id').value;
            if (!shopId) {
                showAlert('No shop selected for editing.', true);
                return;
            }

            const name = document.getElementById('edit-shop-name').value.trim();
            const address = document.getElementById('edit-shop-address').value.trim();
            const image = document.getElementById('edit-shop-image').value;
            const phone = document.getElementById('edit-shop-phone').value;
            const lat = parseFloat(document.getElementById('edit-shop-lat').value);
            const lng = parseFloat(document.getElementById('edit-shop-lng').value);
            const waitTime = parseInt(document.getElementById('edit-shop-wait-time').value) || 15;
            const showWait = document.getElementById('edit-shop-show-wait').checked;
            const showQueue = document.getElementById('edit-shop-show-queue').checked;

            // Read pricing configuration values
            const minimumOrderAmount = parseFloat(document.getElementById('edit-shop-min-order').value) || 0;
            const deliveryCharge = parseFloat(document.getElementById('edit-shop-delivery-charge').value) || 0;
            const gstPercentage = parseFloat(document.getElementById('edit-shop-gst').value) || 5;

            const openTime = document.getElementById('edit-shop-open-time').value;
            const closeTime = document.getElementById('edit-shop-close-time').value;
            const daysOpen = Array.from(document.querySelectorAll('input[name="edit-shop-days"]:checked')).map(cb => cb.value);
            const periods = Array.from(document.querySelectorAll('input[name="edit-shop-periods"]:checked')).map(cb => cb.value);

            if (!name) {
                showAlert('Shop name is required.', true);
                return;
            }

            const alarmSettings = {
                kitchenNew: document.getElementById('edit-alarm-kitchen-new').checked,
                kitchenReady: document.getElementById('edit-alarm-kitchen-ready').checked,
                deliveryReady: document.getElementById('edit-alarm-delivery-ready').checked
            };

            const updates = {
                name,
                address: address || null,
                image: image || null,
                phoneNumber: phone || null,
                latitude: isNaN(lat) ? null : lat,
                longitude: isNaN(lng) ? null : lng,
                estimatedWaitTime: waitTime,
                showWaitTime: showWait,
                showOrderQueue: showQueue,
                minimumOrderAmount,
                deliveryCharge,
                gstPercentage,
                alarmSettings
            };

            // Add schedule if provided
            if (openTime && closeTime) {
                updates.schedule = {
                    openTime,
                    closeTime,
                    daysOpen: daysOpen.length > 0 ? daysOpen : ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                    timePeriods: periods
                };
            } else if (!openTime && !closeTime) {
                // Clear schedule if both times are empty
                updates.schedule = null;
            }

            try {
                await updateDoc(doc(db, "shops", shopId), updates);
                showAlert('Shop updated successfully!');
                document.getElementById('edit-shop-modal').classList.add('hidden');

                // Refresh shop list
                await loadAllShops();

                // If this is the current active shop, re-initialize the monitor to apply new alarm settings
                if (shopId === currentUserShopId && ['kitchen', 'owner', 'delivery'].includes(userRole)) {
                    initFastNotification(currentUserShopId, userRole);
                }
            } catch (error) {
                console.error("Error updating shop: ", error);
                showAlert("Failed to update shop.", true);
            }
        }

        // Edit Shop Modal Event Listeners
        document.getElementById('edit-shop-close').addEventListener('click', () => {
            document.getElementById('edit-shop-modal').classList.add('hidden');
        });
        document.getElementById('edit-shop-cancel').addEventListener('click', () => {
            document.getElementById('edit-shop-modal').classList.add('hidden');
        });
        document.getElementById('edit-shop-form').addEventListener('submit', saveShopEdit);

        // Live preview for image URL in edit modal
        document.getElementById('edit-shop-image').addEventListener('input', (e) => {
            const url = e.target.value.trim();
            const previewContainer = document.getElementById('edit-shop-image-preview');
            const previewImg = document.getElementById('edit-shop-image-img');

            if (url) {
                previewImg.src = url;
                previewImg.onerror = () => previewContainer.classList.add('hidden');
                previewImg.onload = () => previewContainer.classList.remove('hidden');
            } else {
                previewContainer.classList.add('hidden');
            }
        });

        // --- SCHEDULE MANAGEMENT ---
        function populateScheduleSelect() {
            const select = document.getElementById('schedule-shop-select');
            if (!select) return; // Element doesn't exist
            select.innerHTML = '<option value="">-- Select Shop to Update Schedule --</option>' +
                allShops.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
        }

        const scheduleShopSelect = document.getElementById('schedule-shop-select');
        if (scheduleShopSelect) {
            scheduleShopSelect.addEventListener('change', async (e) => {
                const shopId = e.target.value;
                const editor = document.getElementById('schedule-editor');

                if (!shopId) {
                    if (editor) editor.classList.add('hidden');
                    return;
                }

                const shop = allShops.find(s => s.id === shopId);
                if (shop && editor) {
                    editor.classList.remove('hidden');

                    // Populate current schedule
                    const schedule = shop.schedule || {};
                    const editOpenTime = document.getElementById('edit-open-time');
                    const editCloseTime = document.getElementById('edit-close-time');
                    if (editOpenTime) editOpenTime.value = schedule.openTime || '';
                    if (editCloseTime) editCloseTime.value = schedule.closeTime || '';

                    // Set checkboxes
                    document.querySelectorAll('input[name="edit-days"]').forEach(cb => {
                        cb.checked = schedule.daysOpen ? schedule.daysOpen.includes(cb.value) : true;
                    });
                }
            });
        }

        const updateScheduleBtn = document.getElementById('update-schedule-btn');
        if (updateScheduleBtn) {
            updateScheduleBtn.addEventListener('click', async () => {
                const shopId = document.getElementById('schedule-shop-select')?.value;
                if (!shopId) return;

                const openTime = document.getElementById('edit-open-time')?.value || '';
                const closeTime = document.getElementById('edit-close-time')?.value || '';
                const daysOpen = Array.from(document.querySelectorAll('input[name="edit-days"]:checked')).map(cb => cb.value);

                try {
                    await updateDoc(doc(db, "shops", shopId), {
                        schedule: {
                            openTime,
                            closeTime,
                            daysOpen: daysOpen.length > 0 ? daysOpen : ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun']
                        }
                    });
                    showAlert('Schedule updated successfully!');
                    await loadAllShops();
                    const scheduleEditor = document.getElementById('schedule-editor');
                    const scheduleShopSelect = document.getElementById('schedule-shop-select');
                    if (scheduleEditor) scheduleEditor.classList.add('hidden');
                    if (scheduleShopSelect) scheduleShopSelect.value = '';
                } catch (error) {
                    console.error("Error updating schedule: ", error);
                    showAlert("Failed to update schedule.", true);
                }
            });
        }


        async function createMenuItem(e) {
            e.preventDefault();
            const shopId = document.getElementById('dev-menu-shop-select').value;
            if (!shopId) return showAlert("Please select a shop first.", true);

            const name = document.getElementById('menu-item-name').value;
            const price = parseFloat(document.getElementById('menu-item-price').value);
            const image = document.getElementById('menu-item-image').value;

            if (isNaN(price) || price <= 0) return showAlert("Please enter a valid price.", true);

            try {
                await addDoc(collection(db, "menus"), { shopId, name, price, image: image || null });
                showAlert('Menu item added!');
                document.getElementById('create-menu-item-form').reset();
                renderDevMenuItemList(shopId);
            } catch (error) {
                console.error("Error adding menu item: ", error);
                showAlert("Failed to add item.", true);
            }
        }

        async function renderDevMenuItemList(shopId) {
            const container = document.getElementById('dev-menu-item-list');
            container.innerHTML = '<p class="text-gray-500">Loading items...</p>';
            const snapshot = await getDocs(query(collection(db, "menus"), where("shopId", "==", shopId)));
            const items = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            if (items.length === 0) {
                container.innerHTML = '<p class="text-gray-500">No menu items for this shop.</p>';
                return;
            }
            container.innerHTML = items.map(item => `
                <div class="flex justify-between items-center bg-gray-50 p-3 rounded-lg">
                    <div>
                        <p class="font-medium">${item.name}</p>
                        <p class="text-sm text-gray-500">₹${item.price}</p>
                    </div>
                    <button data-id="${item.id}" data-shop-id="${shopId}" class="dev-remove-menu-item-btn bg-red-100 text-red-700 px-3 py-1 rounded-md text-sm hover:bg-red-200">Remove</button>
                </div>
            `).join('');
        }

        async function renderTestMenuItems(shopId) {
            const container = document.getElementById('test-menu-items');
            const detailsSection = document.getElementById('test-order-details');

            if (!shopId) {
                if (detailsSection) detailsSection.classList.add('hidden');
                if (container) container.innerHTML = '<p class="text-gray-500 text-xs">Select a shop to see items.</p>';
                return;
            }

            // Show the details section
            if (detailsSection) detailsSection.classList.remove('hidden');

            if (container) container.innerHTML = '<p class="text-gray-500 text-xs">Loading items...</p>';
            const snapshot = await getDocs(query(collection(db, "menus"), where("shopId", "==", shopId)));
            const items = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            if (items.length === 0) {
                if (container) container.innerHTML = '<p class="text-gray-500 text-xs">No items for this shop.</p>';
                return;
            }
            if (container) container.innerHTML = items.map(item => `<label class="flex items-center gap-2 p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100"><input type="checkbox" class="test-menu-checkbox" data-id="${item.id}" data-name="${item.name}" data-price="${item.price}"><span class="text-sm">${item.name} (₹${item.price})</span></label>`).join('');
        }

        async function runSystemTests() {
            const tests = { firebase: document.getElementById('test-firebase'), database: document.getElementById('test-database'), auth: document.getElementById('test-auth') };
            const setStatus = (el, pass) => { if (el) { el.textContent = pass ? 'PASS' : 'FAIL'; el.className = `test-badge ${pass ? 'test-pass' : 'test-fail'}`; } };
            setStatus(tests.firebase, isFirebaseReady);
            try { await getDoc(doc(db, "users", "test-read")); setStatus(tests.database, true); } catch (e) { setStatus(tests.database, e.code === 'permission-denied' || e.message.includes("Missing or insufficient permissions")); }
            setStatus(tests.auth, !!auth.currentUser && !auth.currentUser.isAnonymous); // Check if authenticated and not anonymous
        }

        // --- Data Consistency Check & Fix Functions ---

        let dataConsistencyResults = {
            orphanShops: [],
            deliveryMigration: [],
            shopsNoOwner: [],
            orphanMenus: [],
            orphanOrders: [],
            duplicates: []
        };

        async function runDataConsistencyCheck() {
            if (userRole !== 'developer') return;

            const setStatus = (id, count, isError = null) => {
                const el = document.getElementById(id);
                if (!el) return;
                el.textContent = count;
                if (isError === null) {
                    el.className = count === 0 ? 'test-badge test-pass' : 'test-badge test-fail';
                } else {
                    el.className = isError ? 'test-badge test-fail' : 'test-badge test-pass';
                }
            };

            try {
                // Reset results
                dataConsistencyResults = {
                    orphanShops: [],
                    deliveryMigration: [],
                    shopsNoOwner: [],
                    orphanMenus: [],
                    orphanOrders: [],
                    duplicates: []
                };

                // Fetch all data
                const [usersSnapshot, menusSnapshot, ordersSnapshot] = await Promise.all([
                    getDocs(collection(db, "users")),
                    getDocs(collection(db, "menus")),
                    getDocs(collection(db, "orders"))
                ]);

                const shopIds = new Set(allShops.map(s => s.id));
                const users = usersSnapshot.docs.map(d => ({ id: d.id, ...d.data() }));

                // 1. Check for staff assigned to non-existent shops
                users.forEach(user => {
                    if (['kitchen', 'owner', 'delivery'].includes(user.role)) {
                        if (user.shopId && !shopIds.has(user.shopId)) {
                            dataConsistencyResults.orphanShops.push({ userId: user.id, email: user.email, invalidShopId: user.shopId });
                        }
                        if (user.shopIds && Array.isArray(user.shopIds)) {
                            user.shopIds.forEach(sid => {
                                if (!shopIds.has(sid)) {
                                    dataConsistencyResults.orphanShops.push({ userId: user.id, email: user.email, invalidShopId: sid });
                                }
                            });
                        }
                    }
                });
                setStatus('check-orphan-shops', dataConsistencyResults.orphanShops.length);

                // 2. Check delivery staff needing migration to shopIds array
                users.forEach(user => {
                    if (user.role === 'delivery' && user.shopId && (!user.shopIds || !Array.isArray(user.shopIds))) {
                        dataConsistencyResults.deliveryMigration.push({ userId: user.id, email: user.email, shopId: user.shopId });
                    }
                });
                setStatus('check-delivery-migration', dataConsistencyResults.deliveryMigration.length);

                // 3. Check shops without an owner
                const ownersPerShop = {};
                users.forEach(user => {
                    if (user.role === 'owner' && user.shopId) {
                        ownersPerShop[user.shopId] = (ownersPerShop[user.shopId] || 0) + 1;
                    }
                });
                allShops.forEach(shop => {
                    if (!ownersPerShop[shop.id]) {
                        dataConsistencyResults.shopsNoOwner.push({ shopId: shop.id, shopName: shop.name });
                    }
                });
                setStatus('check-shops-no-owner', dataConsistencyResults.shopsNoOwner.length);

                // 4. Check orphan menu items
                menusSnapshot.docs.forEach(d => {
                    const menu = d.data();
                    if (menu.shopId && !shopIds.has(menu.shopId)) {
                        dataConsistencyResults.orphanMenus.push({ menuId: d.id, name: menu.name, invalidShopId: menu.shopId });
                    }
                });
                setStatus('check-orphan-menus', dataConsistencyResults.orphanMenus.length);

                // 5. Check orphan orders
                ordersSnapshot.docs.forEach(d => {
                    const order = d.data();
                    if (order.shopId && !shopIds.has(order.shopId)) {
                        dataConsistencyResults.orphanOrders.push({ orderId: d.id, customer: order.customerName, invalidShopId: order.shopId });
                    }
                });
                setStatus('check-orphan-orders', dataConsistencyResults.orphanOrders.length);

                // 6. Check duplicate shop assignments (shopId appears in shopIds too)
                users.forEach(user => {
                    if (user.role === 'delivery' && user.shopIds && Array.isArray(user.shopIds)) {
                        const uniqueShops = new Set(user.shopIds);
                        if (uniqueShops.size !== user.shopIds.length) {
                            dataConsistencyResults.duplicates.push({ userId: user.id, email: user.email, issue: 'duplicate shops in shopIds' });
                        }
                    }
                });
                setStatus('check-duplicates', dataConsistencyResults.duplicates.length);

                const totalIssues = Object.values(dataConsistencyResults).reduce((sum, arr) => sum + arr.length, 0);
                document.getElementById('data-fix-status').textContent = totalIssues === 0
                    ? '✅ All checks passed!'
                    : `⚠️ Found ${totalIssues} issue(s)`;

            } catch (error) {
                console.error("Data consistency check error:", error);
                document.getElementById('data-fix-status').textContent = '❌ Check failed: ' + error.message;
            }
        }

        async function fixDataInconsistencies() {
            if (userRole !== 'developer') return;

            showAlert('Are you sure you want to fix all data inconsistencies? This will modify your database.', false, async () => {
                const statusEl = document.getElementById('data-fix-status');
                statusEl.textContent = '🔄 Fixing issues...';
                let fixedCount = 0;

                try {
                    // 1. Fix orphan shop assignments - clear invalid shopId
                    for (const item of dataConsistencyResults.orphanShops) {
                        const userRef = doc(db, "users", item.userId);
                        const userSnap = await getDoc(userRef);
                        if (userSnap.exists()) {
                            const userData = userSnap.data();
                            const update = {};

                            if (userData.shopId === item.invalidShopId) {
                                update.shopId = null;
                            }
                            if (userData.shopIds && Array.isArray(userData.shopIds)) {
                                update.shopIds = userData.shopIds.filter(sid => sid !== item.invalidShopId);
                                if (update.shopIds.length === 0) update.shopIds = null;
                            }

                            if (Object.keys(update).length > 0) {
                                await setDoc(userRef, update, { merge: true });
                                fixedCount++;
                            }
                        }
                    }

                    // 2. Migrate delivery staff to use shopIds array
                    for (const item of dataConsistencyResults.deliveryMigration) {
                        await setDoc(doc(db, "users", item.userId), {
                            shopIds: [item.shopId]
                        }, { merge: true });
                        fixedCount++;
                    }

                    // 3. Fix duplicate shop assignments
                    for (const item of dataConsistencyResults.duplicates) {
                        const userRef = doc(db, "users", item.userId);
                        const userSnap = await getDoc(userRef);
                        if (userSnap.exists()) {
                            const userData = userSnap.data();
                            if (userData.shopIds && Array.isArray(userData.shopIds)) {
                                const uniqueShops = [...new Set(userData.shopIds)];
                                await setDoc(userRef, { shopIds: uniqueShops }, { merge: true });
                                fixedCount++;
                            }
                        }
                    }

                    // 4. Delete orphan menu items
                    for (const item of dataConsistencyResults.orphanMenus) {
                        await deleteDoc(doc(db, "menus", item.menuId));
                        fixedCount++;
                    }

                    // Note: We don't auto-delete orphan orders as they contain important customer data
                    // Just log a warning

                    statusEl.textContent = `✅ Fixed ${fixedCount} issue(s)! Run check again to verify.`;
                    showAlert(`Fixed ${fixedCount} data inconsistency issue(s). Please run the check again to verify.`);

                    // Refresh UI
                    await loadAllShops();
                    await loadAdminPanel();
                    await runDataConsistencyCheck();

                } catch (error) {
                    console.error("Data fix error:", error);
                    statusEl.textContent = '❌ Fix failed: ' + error.message;
                    showAlert("Failed to fix some issues: " + error.message, true);
                }
            });
        }

        // Event listeners for data consistency buttons
        document.getElementById('run-data-check-btn')?.addEventListener('click', runDataConsistencyCheck);
        document.getElementById('fix-data-btn')?.addEventListener('click', fixDataInconsistencies);

        let lastCashAuditData = [];

        window.loadCashAuditData = async function () {
            const shopId = document.getElementById('cash-audit-shop-select').value;
            const listEl = document.getElementById('dev-cash-audit-list');
            const footerEl = document.getElementById('dev-cash-audit-footer');
            const totalEl = document.getElementById('dev-cash-audit-total');

            listEl.innerHTML = '<tr><td colspan="5" class="px-6 py-10 text-center text-gray-500 italic">Syncing with Firestore...</td></tr>';
            footerEl.classList.add('hidden');

            try {
                let q = query(collection(db, "orders"), where("paymentMethod", "==", "cod"), where("cashStatus", "==", "unsettled"));
                if (shopId) {
                    q = query(q, where("shopId", "==", shopId));
                }

                const snapshot = await getDocs(q);
                lastCashAuditData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                if (lastCashAuditData.length === 0) {
                    listEl.innerHTML = '<tr><td colspan="5" class="px-6 py-10 text-center text-gray-400 italic">No unsettled cash orders found.</td></tr>';
                    return;
                }

                // Fetch all unique delivery staff and shop names for display
                const staffIds = [...new Set(lastCashAuditData.map(o => o.deliveryStaffId).filter(id => !!id))];
                const staffMap = {};
                for (const sid of staffIds) {
                    const sdoc = await getDoc(doc(db, "users", sid));
                    if (sdoc.exists()) staffMap[sid] = sdoc.data().displayName || sdoc.data().email;
                }

                let totalAmount = 0;
                listEl.innerHTML = lastCashAuditData.map(o => {
                    const staffName = staffMap[o.deliveryStaffId] || 'Unknown';
                    const shopName = allShops.find(s => s.id === o.shopId)?.name || 'Unknown Shop';
                    const date = o.createdAt?.toDate() ? o.createdAt.toDate().toLocaleDateString('en-GB') : 'N/A';
                    totalAmount += (o.totalAmount || 0);

                    return `
                        <tr>
                            <td class="px-6 py-4">
                                <p class="text-sm font-bold text-gray-900">#${o.id.substring(0, 6)}</p>
                                <p class="text-xs text-gray-500">${o.customerName} • ${date}</p>
                            </td>
                            <td class="px-6 py-4">
                                <span class="text-xs text-gray-600 font-medium">${shopName}</span>
                            </td>
                            <td class="px-6 py-4">
                                <div class="flex items-center gap-2">
                                    <div class="w-6 h-6 rounded-full bg-blue-100 flex items-center justify-center text-[10px] text-blue-600 font-bold">
                                        ${staffName.charAt(0).toUpperCase()}
                                    </div>
                                    <span class="text-sm text-gray-700">${staffName}</span>
                                </div>
                            </td>
                            <td class="px-6 py-4 text-right">
                                <span class="text-sm font-bold text-gray-900">₹${o.totalAmount}</span>
                            </td>
                            <td class="px-6 py-4 text-center">
                                <button onclick="settleCashOrderFromAudit('${o.id}', ${o.totalAmount}, '${o.deliveryStaffId}', '${o.shopId}')" 
                                    class="text-blue-600 hover:text-blue-800 text-xs font-bold uppercase">Settle</button>
                            </td>
                        </tr>
                    `;
                }).join('');

                totalEl.textContent = `₹${totalAmount}`;
                footerEl.classList.remove('hidden');

            } catch (error) {
                console.error("Cash audit load error:", error);
                listEl.innerHTML = `<tr><td colspan="5" class="px-6 py-10 text-center text-red-500">Error: ${error.message}</td></tr>`;
            }
        };

        window.settleCashOrderFromAudit = async function (orderId, amount, deliveryStaffId, shopId) {
            if (!confirm(`Confirm settlement of ₹${amount} for order #${orderId.substring(0, 6)}?`)) return;
            try {
                const batch = writeBatch(db);
                batch.update(doc(db, "orders", orderId), { cashStatus: 'settled' });
                batch.set(doc(collection(db, "cash_transactions")), {
                    shopId, orderId, userId: deliveryStaffId, amount, type: 'settlement',
                    method: 'cash', createdAt: serverTimestamp(), settledBy: auth.currentUser.uid
                });
                await batch.commit();
                showAlert('Order settled successfully');
                loadCashAuditData();
            } catch (error) {
                showAlert('Settlement failed: ' + error.message, true);
            }
        };

        window.testAlarm = function () {
            if (!fastMonitor) {
                const msg = (userRole === 'developer')
                    ? "Notification system not initialized. Please select a shop from the 'Switch View' panel below first."
                    : "Notification system not initialized. Please log in first.";
                showAlert(msg, true);
                return;
            }

            if (Notification.permission !== "granted") {
                showAlert("Notification permission not granted. Please click 'Enable Sound' first.", true);
            }

            console.log("🔔 Triggering Test Alarm...");
            fastMonitor.triggerAlert({
                customerName: "TEST CUSTOMER",
                totalAmount: 999,
                status: 'new'
            }, "TEST_ORDER_ID", "TEST ALARM!");

            showAlert("Test Alarm triggered! Check your notifications and sound.");
        };

        window.batchSettleCash = async function () {
            const count = lastCashAuditData.length;
            if (count === 0) return;
            if (!confirm(`Are you sure you want to settle ALL ${count} pending orders? This cannot be undone.`)) return;

            const btn = document.getElementById('batch-settle-btn');
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = 'SETTLING...';

            try {
                // Firestore batches are limited to 500 operations. Cash Audit usually won't exceed this, 
                // but we'll process in chunks of 100 just to be safe.
                const chunks = [];
                for (let i = 0; i < lastCashAuditData.length; i += 100) {
                    chunks.push(lastCashAuditData.slice(i, i + 100));
                }

                for (const chunk of chunks) {
                    const batch = writeBatch(db);
                    for (const o of chunk) {
                        batch.update(doc(db, "orders", o.id), { cashStatus: 'settled' });
                        batch.set(doc(collection(db, "cash_transactions")), {
                            shopId: o.shopId,
                            orderId: o.id,
                            userId: o.deliveryStaffId,
                            amount: o.totalAmount,
                            type: 'settlement',
                            method: 'cash',
                            createdAt: serverTimestamp(),
                            settledBy: auth.currentUser.uid,
                            batchId: `batch_${Date.now()}`
                        });
                    }
                    await batch.commit();
                }

                showAlert(`Successfully settled ${count} orders!`);
                loadCashAuditData();
            } catch (error) {
                console.error("Batch settlement error:", error);
                showAlert('Batch settlement failed: ' + error.message, true);
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        };


        async function createTestOrder(e) {
            e.preventDefault();
            const shopId = document.getElementById('test-order-shop-select').value;
            if (!shopId) return showAlert('Please select a shop.', true);

            const items = Array.from(document.querySelectorAll('.test-menu-checkbox:checked')).map(cb => ({ id: cb.dataset.id, name: cb.dataset.name, price: parseFloat(cb.dataset.price), quantity: 1, ready: false }));
            if (items.length === 0) return showAlert('Please select at least one item.', true);

            const orderData = {
                shopId,
                customerName: document.getElementById('test-name').value,
                customerAddress: document.getElementById('test-address').value,
                customerPhone: document.getElementById('test-phone').value,
                items,
                totalAmount: items.reduce((s, i) => s + i.price, 0),
                status: 'new',
                createdAt: serverTimestamp(),
                // FIX: Use actual user ID to pass security rules
                userId: auth.currentUser ? auth.currentUser.uid : 'test-developer',
                paymentId: 'dev-test-skip', // Dummy payment ID for test orders
                paymentIds: ['dev-test-skip'],
                isTestOrder: true,
            };
            try {
                const docRef = await addDoc(collection(db, "orders"), orderData);
                showAlert('Test order created successfully!');
                document.getElementById('test-order-form').reset();

                // --- Notification: Notify kitchen and owner ---
                const usersSnapshot = await getDocs(query(collection(db, "users"), where("shopId", "==", shopId), where("role", "in", ["kitchen", "owner"])));
                usersSnapshot.docs.forEach(userDoc => {
                    createNotification({
                        userId: userDoc.id,
                        role: userDoc.data().role,
                        shopId: shopId,
                        message: `New TEST order received from ${orderData.customerName}.`,
                        orderId: docRef.id
                    });
                });
                // --- END Notification ---

            } catch (error) { showAlert('Failed to create test order.', true); console.error(error); }
        }

        async function resetCustomerOrders() {
            if (userRole !== 'developer') return showAlert("You don't have permission for this.", true);

            showAlert(`Are you sure you want to delete ALL non-test orders? This cannot be undone.`, false, async () => {
                // Bug Fix: Filter out documents where isTestOrder does NOT exist OR is set to false
                const nonTestQuery = query(collection(db, "orders"), where("isTestOrder", "==", false));
                const nonTestSnapshot = await getDocs(nonTestQuery);

                const ordersToDelete = [...nonTestSnapshot.docs];

                // Also check for documents where isTestOrder field is completely missing (treat as non-test)
                const missingFieldQuery = query(collection(db, "orders"), where("isTestOrder", "==", undefined));
                const missingFieldSnapshot = await getDocs(missingFieldQuery);
                ordersToDelete.push(...missingFieldSnapshot.docs);

                if (ordersToDelete.length === 0) return showAlert('No non-test orders to reset.', false);
                try {
                    const batch = writeBatch(db);
                    ordersToDelete.forEach(d => batch.delete(d.ref));
                    await batch.commit();

                    showAlert(`Successfully deleted ${ordersToDelete.length} customer orders.`, false);
                    updateDevSummary(); // Refresh summary
                } catch (error) {
                    console.error("Error resetting orders:", error);
                    showAlert("Failed to reset orders.", true);
                }
            });
        }

        function loadAllOrders(direction = 'start') {
            const container = document.getElementById('all-orders-list');
            if (!container || userRole !== 'developer') return;
            container.innerHTML = '<p class="text-gray-500 text-center py-4">Loading orders...</p>';

            orderQueryUnsubscribe?.();

            let q = collection(db, "orders");
            const constraints = [];

            const now = new Date();
            let startDate, endDate = Timestamp.now();
            if (orderDateFilter === 'today') {
                startDate = new Date(now); startDate.setHours(0, 0, 0, 0);
                startDate = Timestamp.fromDate(startDate);
            } else if (orderDateFilter === 'week') {
                startDate = new Date(now); startDate.setDate(startDate.getDate() - now.getDay()); startDate.setHours(0, 0, 0, 0);
                startDate = Timestamp.fromDate(startDate);
            } else if (orderDateFilter === 'month') {
                startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                startDate = Timestamp.fromDate(startDate);
            }

            if (startDate) constraints.push(where("createdAt", ">=", startDate));

            // Bug Fix: Firestore requires orderBy before startAfter/endBefore
            constraints.push(orderBy("createdAt", "desc"));

            if (direction === 'next' && orderLastVisibleDoc) {
                constraints.push(startAfter(orderLastVisibleDoc));
            } else if (direction === 'prev' && orderFirstVisibleDoc) {
                // To go back, we need to order by ASC, limit, then reverse the results
                // For simplicity with this current pagiantion structure, we rely on `endBefore` 
                // which requires an index, which is already in constraints (orderBy).
                constraints.push(endBefore(orderFirstVisibleDoc));
            }

            constraints.push(limit(orderQueryLimit));


            const finalQuery = query(q, ...constraints);

            orderQueryUnsubscribe = onSnapshot(finalQuery, (snapshot) => {
                let docs = snapshot.docs;

                if (docs.length > 0) {
                    orderFirstVisibleDoc = docs[0];
                    orderLastVisibleDoc = docs[docs.length - 1];
                } else {
                    // Logic remains mostly the same for button disabling
                    if (direction === 'prev' && orderCurrentPage > 1) {
                        // If no docs came back when going prev, we stay on the current page, so only prev is disabled
                        if (prevOrdersBtn) prevOrdersBtn.disabled = true;
                    } else if (direction === 'next' && orderCurrentPage >= 1) {
                        if (nextOrdersBtn) nextOrdersBtn.disabled = true;
                    } else {
                        orderFirstVisibleDoc = null; orderLastVisibleDoc = null;
                    }
                }

                renderAllOrdersList(docs);

                if (prevOrdersBtn) prevOrdersBtn.disabled = orderCurrentPage <= 1;
                // Note: The determination of the last page when moving forward is tricky with the startAfter/endBefore method 
                // in real time listeners. We'll rely on the snapshot size being less than the limit for now.
                if (nextOrdersBtn) nextOrdersBtn.disabled = docs.length < orderQueryLimit;

                if (orderPageInfoEl) orderPageInfoEl.textContent = `Page ${orderCurrentPage}`;

            }, (error) => {
                console.error("Error loading all orders:", error);
                if (container) container.innerHTML = `<p class="text-red-500 text-center py-4">Error loading orders.</p>`;
                if (prevOrdersBtn) prevOrdersBtn.disabled = true;
                if (nextOrdersBtn) nextOrdersBtn.disabled = true;
            });
        }

        function renderAllOrdersList(docs) {
            const container = document.getElementById('all-orders-list');
            if (!container) return;
            const searchInput = document.getElementById('order-search-input-dev');
            const searchTerm = searchInput ? searchInput.value.trim().toLowerCase() : '';
            let filteredDocs = docs.filter(doc => !searchTerm || (doc.data().customerName || '').toLowerCase().includes(searchTerm));

            container.innerHTML = filteredDocs.length === 0
                ? '<p class="text-gray-500 text-center py-4">No orders found for this filter/page.</p>'
                : filteredDocs.map(docSnap => {
                    const order = docSnap.data();
                    const shopName = allShops.find(s => s.id === order.shopId)?.name || 'Unknown Shop';
                    const statusColors = { 'new': 'bg-blue-100 text-blue-800', 'preparing': 'bg-orange-100 text-orange-800', 'ready_for_pickup': 'bg-green-100 text-green-800', 'out_for_delivery': 'bg-purple-100 text-purple-800', 'completed': 'bg-gray-100 text-gray-800' };
                    const devButtonStatusColors = { 'new': 'bg-blue-500 hover:bg-blue-600', 'preparing': 'bg-orange-500 hover:bg-orange-600', 'ready_for_pickup': 'bg-green-500 hover:bg-green-600', 'out_for_delivery': 'bg-purple-500 hover:bg-purple-600', 'completed': 'bg-gray-500 hover:bg-gray-600' };
                    const devButtonsHTML = ['new', 'preparing', 'ready_for_pickup', 'out_for_delivery', 'completed'].map(s => `<button data-id="${docSnap.id}" data-status="${s}" class="dev-update-status text-xs px-3 py-1 text-white rounded ${devButtonStatusColors[s]} capitalize">${s.split('_')[0]}</button>`).join('');
                    const deleteButtonHTML = `<button data-id="${docSnap.id}" class="dev-delete-order-btn text-xs px-3 py-1 text-white rounded bg-red-600 hover:bg-red-700">Delete</button>`;

                    return `<div class="bg-gray-50 p-4 rounded-lg"><div class="flex justify-between items-start mb-3"><div><p class="font-semibold">${order.customerName} (<span class="text-sm font-normal text-indigo-600">${shopName}</span>)</p><p class="text-xs text-gray-500">ID: ${docSnap.id.substring(0, 12)}</p><p class="text-xs text-gray-500">${order.createdAt?.toDate().toLocaleString() || 'N/A'}</p></div><div class="flex gap-2 items-center">${order.isTestOrder ? '<span class="test-badge text-pending">TEST</span>' : ''}<span class="px-3 py-1 rounded-full text-xs font-semibold ${statusColors[order.status] || 'bg-gray-100'}">${order.status.replace(/_/g, ' ').toUpperCase()}</span></div></div><div class="grid grid-cols-2 gap-2 text-sm"><div><span class="text-gray-600">Phone:</span> ${order.customerPhone}</div><div><span class="text-gray-600">Amount:</span> ₹${order.totalAmount}</div><div class="col-span-2"><span class="text-gray-600">Address:</span> ${order.customerAddress}</div><div class="col-span-2"><span class="text-gray-600">Items:</span> ${order.items.map(i => i.name).join(', ')}</div></div><div class="mt-3 flex gap-2 flex-wrap">${devButtonsHTML} ${deleteButtonHTML}</div></div>`;
                }).join('');
        }

        function handleUserSort(e) {
            const newCriteria = e.target.closest('[data-sort]').dataset.sort;
            if (!newCriteria) return;

            if (userSortCriteria === newCriteria) {
                userSortDirection = userSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                userSortCriteria = newCriteria;
                userSortDirection = 'asc';
            }
            renderAdminUserList();
        }

        function sortUsers(users) {
            return users.sort((a, b) => {
                let valA, valB;
                const dataA = a.data();
                const dataB = b.data();

                switch (userSortCriteria) {
                    case 'email':
                        valA = dataA.email?.toLowerCase() || '';
                        valB = dataB.email?.toLowerCase() || '';
                        break;
                    case 'role':
                        valA = dataA.role || '';
                        valB = dataB.role || '';
                        break;
                    case 'shop':
                        const shopA = allShops.find(s => s.id === dataA.shopId)?.name?.toLowerCase() || '';
                        const shopB = allShops.find(s => s.id === dataB.shopId)?.name?.toLowerCase() || '';
                        valA = shopA;
                        valB = shopB;
                        break;
                    default:
                        return 0;
                }

                if (valA < valB) return userSortDirection === 'asc' ? -1 : 1;
                if (valA > valB) return userSortDirection === 'asc' ? 1 : -1;
                return 0;
            });
        }

        async function loadAdminPanel() {
            const userListEl = document.getElementById('admin-user-list');
            if (!userListEl) return;
            userListEl.innerHTML = `<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">Loading users...</td></tr>`;

            // Bug Fix: Filter out anonymous users which shouldn't be managed via email/role
            const usersSnapshot = await getDocs(query(collection(db, "users"), where("email", "!=", null)));
            allUsersCache = usersSnapshot.docs.filter(d => d.id !== userId && d.data().email !== DEVELOPER_EMAIL);
            renderAdminUserList();
        }

        function renderAdminUserList() {
            const userListEl = document.getElementById('admin-user-list');
            if (!userListEl) return;

            const sortedUsers = sortUsers([...allUsersCache]);

            document.querySelectorAll('#developer-view .sortable-header').forEach(header => {
                const arrow = header.querySelector('.sort-arrow');
                if (arrow) {
                    header.classList.remove('sort-asc', 'sort-desc');
                    if (header.dataset.sort === userSortCriteria) {
                        header.classList.add(userSortDirection === 'asc' ? 'sort-asc' : 'sort-desc');
                    }
                }
            });

            userListEl.innerHTML = sortedUsers.map(doc => {
                const userData = doc.data();
                const roles = ['customer', 'kitchen', 'delivery', 'owner', 'developer'];
                const roleOptions = roles.map(r => `<option value="${r}" ${userData.role === r ? 'selected' : ''}>${r.charAt(0).toUpperCase() + r.slice(1)}</option>`).join('');

                let shopSelectHTML = '<span class="text-gray-400">N/A</span>';
                if (['kitchen', 'owner'].includes(userData.role)) {
                    // Single shop select for kitchen/owner
                    shopSelectHTML = `<select data-uid="${doc.id}" class="shop-selector border rounded px-2 py-1 text-sm"><option value="">-- None --</option>${allShops.map(s => `<option value="${s.id}" ${userData.shopId === s.id ? 'selected' : ''}>${s.name}</option>`).join('')}</select>`;
                } else if (userData.role === 'delivery') {
                    // Multi-shop checkboxes for delivery staff
                    const userShopIds = userData.shopIds || (userData.shopId ? [userData.shopId] : []);
                    shopSelectHTML = `<div class="flex flex-wrap gap-1 max-w-xs">${allShops.map(s =>
                        `<label class="inline-flex items-center gap-1 bg-gray-100 px-2 py-1 rounded text-xs cursor-pointer hover:bg-gray-200">
                            <input type="checkbox" data-uid="${doc.id}" data-shop-id="${s.id}" class="delivery-shop-checkbox" ${userShopIds.includes(s.id) ? 'checked' : ''}>
                            ${s.name}
                        </label>`
                    ).join('')}</div>`;
                    if (allShops.length === 0) shopSelectHTML = '<span class="text-gray-400">No shops</span>';
                }

                const deleteButtonHTML = `<button data-id="${doc.id}" data-email="${userData.email || 'this user'}" class="dev-delete-user-btn btn-danger text-xs px-2 py-1">Delete</button>`;

                let permissionsButtonHTML = '';
                if (userData.role === 'owner') {
                    permissionsButtonHTML = `<button data-uid="${doc.id}" data-email="${userData.email}" class="dev-manage-permissions-btn bg-blue-100 text-blue-700 text-xs px-2 py-1 rounded hover:bg-blue-200 ml-2">Permissions</button>`;
                }

                return `<tr>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${userData.email || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap capitalize text-sm">${userData.role}</td>
                    <td class="px-6 py-4 whitespace-nowrap"><select data-uid="${doc.id}" class="role-selector border rounded px-2 py-1 text-sm">${roleOptions}</select></td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm" id="shop-cell-${doc.id}">${shopSelectHTML}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${deleteButtonHTML}${permissionsButtonHTML}</td> 
                </tr>`;
            }).join('');
        }

        async function deleteUserFromDatabase(deleteUserId) {
            if (!deleteUserId) return;
            try {
                await deleteDoc(doc(db, "users", deleteUserId));
                showAlert("User deleted successfully.");
                allUsersCache = allUsersCache.filter(doc => doc.id !== deleteUserId);
                renderAdminUserList();
                updateDevSummary();
            } catch (error) {
                console.error("Error deleting user:", error);
                showAlert("Failed to delete user.", true);
            }
        }

        async function renderCreateOrderModal(shopId) {
            staffCart = [];

            const menuSnapshot = await getDocs(query(collection(db, "menus"), where("shopId", "==", shopId)));
            const staffMenu = menuSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            if (staffMenu.length === 0) {
                document.getElementById('create-order-content').innerHTML = `<p class="text-red-500 text-center">Your shop has no menu items. Please ask a developer to add some.</p>`;
                return;
            }

            document.getElementById('create-order-content').innerHTML = `
                <form id="staff-create-order-form"><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div><h3 class="text-lg font-medium">Details</h3><div class="space-y-4 mt-4"><input type="text" id="staff-customer-name" placeholder="Customer Name" class="w-full" required><input type="text" id="staff-customer-address" placeholder="Address" class="w-full" required><input type="tel" id="staff-customer-phone" placeholder="Phone" class="w-full" required></div></div><div><h3 class="text-lg font-medium">Select Items</h3><div id="staff-menu-selection" class="space-y-3 mt-4 max-h-64 overflow-y-auto pr-2">${staffMenu.map(item => `<div class="flex justify-between items-center bg-gray-50 p-2 rounded-lg"><div><p class="font-medium">${item.name}</p><p class="text-sm text-gray-500">₹${item.price}</p></div><div class="quantity-selector"><button type="button" class="quantity-btn staff-quantity-minus" data-id="${item.id}" data-price="${item.price}" data-name="${item.name}">-</button><span id="staff-qty-${item.id}" class="quantity-display">0</span><button type="button" class="quantity-btn staff-quantity-plus" data-id="${item.id}" data-price="${item.price}" data-name="${item.name}">+</button></div></div>`).join('')}</div><div id="staff-cart-summary" class="border-t pt-4 mt-4"><div class="flex justify-between font-bold text-lg"><span>Total</span><span>₹0</span></div></div></div></div><div class="mt-8 pt-6 border-t"><button type="submit" class="btn-primary w-full bg-green-600 hover:bg-green-700">Create Order (No Payment)</button></div></form>`;
        }

        function updateStaffCartUI() {
            let total = staffCart.reduce((sum, item) => sum + item.price * item.quantity, 0);
            staffCart.forEach(item => {
                const el = document.getElementById(`staff-qty-${item.id}`);
                if (el) el.textContent = item.quantity;
            });
            document.querySelectorAll('#staff-menu-selection .quantity-display').forEach(el => {
                const id = el.id.replace('staff-qty-', '');
                if (!staffCart.find(item => item.id === id)) {
                    el.textContent = '0';
                }
            });

            document.querySelector('#staff-cart-summary span:last-child').textContent = `₹${total}`;
        }

        async function handleStaffOrderCreation(e) {
            e.preventDefault();
            if (staffCart.length === 0) return showAlert('Please add at least one item.', true);
            if (!currentUserShopId) return showAlert('Cannot create order, staff shop is not set.', true);

            // Validate required fields
            const customerName = document.getElementById('staff-customer-name').value.trim();
            const customerAddress = document.getElementById('staff-customer-address').value.trim();
            const customerPhone = document.getElementById('staff-customer-phone').value.trim();

            if (!customerName) return showAlert('Please enter customer name.', true);
            if (!customerAddress) return showAlert('Please enter customer address.', true);
            if (!customerPhone) return showAlert('Please enter customer phone.', true);

            // Validate user is authenticated
            if (!auth.currentUser) {
                return showAlert('You must be logged in to create orders. Please refresh and log in again.', true);
            }

            const orderData = {
                shopId: currentUserShopId,
                customerName: customerName,
                customerAddress: customerAddress,
                customerPhone: customerPhone,
                items: staffCart.map(item => ({ ...item, ready: false })),
                totalAmount: staffCart.reduce((s, i) => s + i.price * i.quantity, 0),
                status: 'new',
                createdAt: serverTimestamp(),
                userId: auth.currentUser.uid,
                paymentId: 'manual-cash-entry', // Dummy payment ID for staff orders
                paymentIds: ['manual-cash-entry'],
                isPaid: true,
                isTestOrder: false,
                createdBy: userEmail || auth.currentUser.email || 'staff'
            };

            try {
                console.log('[Staff Order] Creating order with data:', orderData);
                const docRef = await addDoc(collection(db, "orders"), orderData);
                console.log('[Staff Order] Order created successfully with ID:', docRef.id);
                showAlert('Order created successfully!');
                createOrderModal.classList.add('hidden');

                // Reset cart after successful order
                staffCart = [];

                // --- Notification: Notify kitchen and owner ---
                try {
                    const usersSnapshot = await getDocs(query(collection(db, "users"), where("shopId", "==", currentUserShopId), where("role", "in", ["kitchen", "owner"])));
                    usersSnapshot.docs.forEach(userDoc => {
                        createNotification({
                            userId: userDoc.id,
                            role: userDoc.data().role,
                            shopId: currentUserShopId,
                            message: `New order created by ${userEmail || 'staff'} for ${orderData.customerName}.`,
                            orderId: docRef.id
                        });
                    });
                } catch (notifError) {
                    console.warn('[Staff Order] Failed to send notifications:', notifError);
                    // Don't fail the order creation if notifications fail
                }
                // --- END Notification ---

            } catch (error) {
                console.error('[Staff Order] Failed to create order:', error);
                console.error('[Staff Order] Error code:', error.code);
                console.error('[Staff Order] Error message:', error.message);

                // Provide more helpful error messages
                let errorMsg = 'Failed to create order.';
                if (error.code === 'permission-denied') {
                    errorMsg = 'Permission denied. Please check if you are logged in with proper access.';
                } else if (error.code === 'unavailable') {
                    errorMsg = 'Database unavailable. Please check your internet connection.';
                } else if (error.message) {
                    errorMsg = `Failed to create order: ${error.message}`;
                }
                showAlert(errorMsg, true);
            }
        }

        // --- Core Fix: Localized Menu Item Control Update ---

        /**
         * Updates the control (Add button or Quantity Selector) for a single menu item.
         * This function avoids re-rendering the entire menu to prevent screen flicker.
         * @param {string} itemId The ID of the menu item to update.
         */
        function updateMenuItemControls(itemId) {
            // Find the menu item card using the item ID in the button/selector
            const itemCard = document.querySelector(`.menu-item button[data-id="${itemId}"]`)?.closest('.menu-item') ||
                document.querySelector(`.menu-item span[data-id="${itemId}"]`)?.closest('.menu-item');

            if (!itemCard) return;

            const item = currentMenu.find(m => m.id === itemId);
            const cartItem = cart.find(ci => ci.id === itemId);

            if (!item) return;

            let buttonHTML;
            if (cartItem) {
                // Generate quantity selector HTML
                buttonHTML = `
                    <div class="quantity-selector mt-4">
                        <button class="quantity-btn quantity-minus" data-id="${itemId}">-</button>
                        <span class="quantity-display">${cartItem.quantity}</span>
                        <button class="quantity-btn quantity-plus" data-id="${itemId}">+</button>
                    </div>
                `;
            } else {
                // Generate Add to Cart button HTML
                buttonHTML = `<button data-id="${itemId}" class="add-to-cart-btn mt-4 btn-primary w-full">Add to Cart</button>`;
            }

            // Find the dynamic controls area (it's the last element of the inner p-5 div)
            const controlsContainer = itemCard.querySelector('.p-5');
            if (!controlsContainer) return;

            // Find existing control elements
            const existingButton = controlsContainer.querySelector('.add-to-cart-btn');
            const existingSelector = controlsContainer.querySelector('.quantity-selector');

            if (existingButton && cartItem) {
                // It was 'Add to Cart', now replace it with selector
                existingButton.outerHTML = buttonHTML;
            } else if (existingSelector) {
                if (cartItem) {
                    // It's a quantity selector, update the quantity text only for smoothness
                    const display = existingSelector.querySelector('.quantity-display');
                    if (display) display.textContent = cartItem.quantity;
                } else {
                    // Quantity went to zero, replace selector with button
                    existingSelector.outerHTML = buttonHTML;
                }
            } else if (!existingButton && !existingSelector && cartItem) {
                // Fallback: If controls are missing but item is in cart (shouldn't happen often)
                controlsContainer.insertAdjacentHTML('beforeend', buttonHTML);
            }
        }

        // --- End Core Fix ---


        // --- Global Event Listeners ---

        document.body.addEventListener('click', async e => {
            const target = e.target;
            const targetId = target.dataset.id;
            let isCartAction = false;

            // Customer Cart (Modify Cart Data)
            if (target.matches('.add-to-cart-btn')) {
                const item = currentMenu.find(m => m.id === targetId);
                if (item) cart.push({ ...item, quantity: 1 });
                isCartAction = true;
            }
            if (target.matches('.quantity-plus')) {
                const item = cart.find(m => m.id === targetId);
                if (item) item.quantity++;
                isCartAction = true;
            }
            if (target.matches('.quantity-minus')) {
                const idx = cart.findIndex(m => m.id === targetId);
                if (idx > -1) {
                    cart[idx].quantity--;
                    if (cart[idx].quantity <= 0) cart.splice(idx, 1);
                }
                isCartAction = true;
            }

            if (isCartAction) {
                updateCart();
                // FIX: Use the localized update function instead of full menu re-render
                updateMenuItemControls(targetId);
                // Removed: renderMenu(selectedShopId); which caused flicker
            }

            // Staff Create Order Cart
            if (target.matches('.staff-quantity-plus')) {
                const item = { id: targetId, price: parseFloat(target.dataset.price), name: target.dataset.name };
                let cartItem = staffCart.find(ci => ci.id === targetId);
                if (cartItem) cartItem.quantity++;
                else staffCart.push({ ...item, quantity: 1 });
                updateStaffCartUI();
            }
            if (target.matches('.staff-quantity-minus')) {
                let idx = staffCart.findIndex(m => m.id === targetId);
                if (idx > -1) {
                    staffCart[idx].quantity--;
                    if (staffCart[idx].quantity <= 0) staffCart.splice(idx, 1);
                    updateStaffCartUI();
                }
            }

            // --- Notification Panel ---
            if (target.closest('#notification-bell-btn')) {
                const panel = document.getElementById('notification-panel');
                // Notification Fix: Close on mobile click
                if (window.innerWidth < 640) {
                    panel.classList.remove('hidden');
                    panel.style.top = '0';
                    panel.style.left = '0';
                    panel.style.width = '100vw';
                    panel.style.height = '100vh';
                    panel.style.backgroundColor = 'rgba(0, 0, 0, 0.4)';
                } else {
                    panel.classList.toggle('hidden');
                }

                if (!panel.classList.contains('hidden')) {
                    markNotificationsAsRead();
                }
            }
            if (target.closest('#notification-panel-close-btn')) {
                document.getElementById('notification-panel').classList.add('hidden');
                // Notification Fix: Reset mobile styles
                document.getElementById('notification-panel').removeAttribute('style');
            }
            if (target.closest('#mark-all-read-btn')) {
                markNotificationsAsRead();
            }
            if (target.closest('#clear-all-notifications')) {
                clearAllNotifications();
            }
            // Close notification panel if clicking outside (desktop only)
            if (window.innerWidth >= 640 && !target.closest('#notification-panel') && !target.closest('#notification-bell-btn')) {
                document.getElementById('notification-panel').classList.add('hidden');
            }
            // --- END Notification ---

            // Other Actions
            if (target.matches('#add-more-items-btn') && currentTrackingOrderId) { const orderDoc = await getDoc(doc(db, "orders", currentTrackingOrderId)); if (orderDoc.exists()) startEditingOrder(orderDoc.data()); }
            if (target.matches('#reset-customer-orders-btn')) await resetCustomerOrders();
            if (target.matches('.history-filter-btn')) { historyFilter = target.dataset.filter; updateHistoryFilterButtons(); filterAndRenderHistory(); }
            // Note: .item-ready-toggle handler moved to the direct HTML element via onchange for simplicity

            if (target.matches('.update-status-btn, .dev-update-status')) {
                try {
                    const newStatus = target.dataset.status;
                    const isCashCollection = target.dataset.cash === 'true';
                    const orderRef = doc(db, "orders", targetId);

                    const orderSnap = await getDoc(orderRef);
                    if (!orderSnap.exists()) return showAlert('Order not found.', true);
                    const orderData = orderSnap.data();

                    // Update the doc - also update cashStatus if this is a COD completion
                    const updateData = { status: newStatus };
                    if (isCashCollection && orderData.paymentMethod === 'cash') {
                        updateData.cashStatus = 'collected';
                        updateData.cashCollectedAt = serverTimestamp();
                    }
                    await updateDoc(orderRef, updateData);
                    showAlert(`Order status updated to ${newStatus.replace(/_/g, ' ')}!`);

                    // Stop alarm if it was ringing for this order
                    if (fastMonitor) fastMonitor.stopAlarm();
                    document.getElementById('global-stop-alarm-btn').classList.add('hidden');
                    document.getElementById('global-stop-alarm-btn-delivery').classList.add('hidden');

                    // --- Notification Logic ---
                    // 1. Notify Customer
                    let customerMessage = '';
                    switch (newStatus) {
                        case 'preparing': customerMessage = `Your order from ${currentShopName || 'the kitchen'} is now being prepared!`; break;
                        case 'ready_for_pickup': customerMessage = `Your order from ${currentShopName || 'the kitchen'} is ready for pickup!`; break;
                        case 'out_for_delivery': customerMessage = 'Your order is out for delivery!'; break;
                        case 'completed': customerMessage = 'Your order has been delivered. Enjoy!'; break;
                    }
                    // Notification Fix: Check for non-staff/non-test user ID
                    if (customerMessage && orderData.userId && orderData.userId !== 'staff-created' && orderData.userId !== 'test-developer') {
                        createNotification({
                            userId: orderData.userId,
                            message: customerMessage,
                            orderId: targetId
                        });
                    }

                    // 2. Notify Delivery Staff/Owner when ready
                    if (newStatus === 'ready_for_pickup') {
                        const usersSnapshot = await getDocs(query(collection(db, "users"), where("shopId", "==", orderData.shopId), where("role", "in", ["delivery", "owner"])));
                        usersSnapshot.docs.forEach(userDoc => {
                            createNotification({
                                userId: userDoc.id,
                                role: userDoc.data().role,
                                shopId: orderData.shopId,
                                message: `Order for ${orderData.customerName} is ready for pickup.`,
                                orderId: targetId
                            });
                        });
                    }
                    // --- END Notification ---

                } catch (e) {
                    showAlert('Failed to update status.', true);
                    console.error("Status update error:", e);
                }
            }

            // Owner Staff Management
            if (target.matches('.remove-staff-btn')) {
                showAlert(`Are you sure you want to remove this staff member?`, false, async () => {
                    await setDoc(doc(db, "users", targetId), { role: 'customer', shopId: null }, { merge: true });
                    showAlert('Staff member removed.');
                    loadStaffList();
                    if (userRole === 'developer') {
                        const userIndex = allUsersCache.findIndex(d => d.id === targetId);
                        if (userIndex > -1) {
                            allUsersCache[userIndex] = await getDoc(doc(db, "users", targetId));
                            renderAdminUserList();
                        }
                    }
                });
            }

            // Developer Panel Actions
            if (target.matches('.dev-edit-shop-btn')) {
                openEditShopModal(targetId);
            }
            if (target.matches('.dev-remove-shop-btn')) {
                showAlert(`Are you sure you want to delete this shop? This will also unassign all staff. This cannot be undone.`, false, async () => {
                    try {
                        // Handle staff with single shopId
                        const usersSnapshot = await getDocs(query(collection(db, "users"), where("shopId", "==", targetId)));
                        await Promise.all(usersSnapshot.docs.map(userDoc => setDoc(userDoc.ref, { shopId: null }, { merge: true })));

                        // Handle delivery staff with shopIds array
                        const allUsersSnapshot = await getDocs(collection(db, "users"));
                        for (const userDoc of allUsersSnapshot.docs) {
                            const userData = userDoc.data();
                            if (userData.shopIds && Array.isArray(userData.shopIds) && userData.shopIds.includes(targetId)) {
                                const newShopIds = userData.shopIds.filter(sid => sid !== targetId);
                                await setDoc(userDoc.ref, {
                                    shopIds: newShopIds.length > 0 ? newShopIds : null,
                                    // Update primary shopId if it was the deleted one
                                    shopId: userData.shopId === targetId ? (newShopIds[0] || null) : userData.shopId
                                }, { merge: true });
                            }
                        }

                        await deleteDoc(doc(db, "shops", targetId));
                        showAlert('Shop removed and staff unassigned.');
                        await loadAllShops();
                        if (userRole === 'developer') await loadAdminPanel();
                    } catch (e) { console.error(e); showAlert('Could not remove shop.', true); }
                });
            }
            if (target.matches('.dev-remove-menu-item-btn')) {
                showAlert(`Are you sure you want to delete this menu item?`, false, async () => {
                    try {
                        await deleteDoc(doc(db, "menus", targetId));
                        showAlert('Menu item removed.');
                        renderDevMenuItemList(target.dataset.shopId);
                    } catch (e) { console.error(e); showAlert('Could not remove item.', true); }
                });
            }
            if (target.matches('.dev-delete-user-btn')) {
                const userToDeleteId = target.dataset.id;
                const userToDeleteEmail = target.dataset.email;
                showAlert(`Are you sure you want to delete the user ${userToDeleteEmail}? This cannot be undone.`, false, async () => {
                    await deleteUserFromDatabase(userToDeleteId);
                });
            }
            if (target.matches('.dev-delete-order-btn')) {
                showAlert(`Are you sure you want to delete this order?`, false, async () => {
                    try {
                        await deleteDoc(doc(db, "orders", targetId));
                        showAlert('Order deleted.');
                    } catch (e) {
                        console.error("Error deleting order: ", e);
                        showAlert('Could not delete order.', true);
                    }
                });
            }
            if (target.matches('#dev-view-dashboard-btn')) {
                const shopId = document.getElementById('dev-dashboard-shop-select').value;
                if (!shopId) return showAlert('Please select a shop to view.', true);
                const shop = allShops.find(s => s.id === shopId);
                if (!shop) return showAlert('Shop not found.', true);

                currentUserShopId = shop.id;
                currentShopName = shop.name;

                document.getElementById('owner-view-title').textContent = `${currentShopName} - Dashboard`;
                updateAuthStatusUI();
                listenForNotifications(); // Refresh notifications for new shop context
                initFastNotification(currentUserShopId, userRole); // Initialize alarm system

                loadOwnerDashboard();
                listenToOrderHistory();
                listenToStaffOrders();

                Object.values(views).forEach(v => v.classList.add('view-hidden'));
                views['owner'].classList.remove('view-hidden');
                views['owner'].classList.add('view-active');
                Array.from(viewSwitcher.querySelectorAll('button')).forEach(btn => btn.classList.toggle('btn-active', btn.dataset.view === 'owner'));
            }
            if (target.matches('#dev-view-delivery-btn')) {
                const shopId = document.getElementById('dev-delivery-shop-select').value;
                if (!shopId) return showAlert('Please select a shop to view.', true);
                const shop = allShops.find(s => s.id === shopId);
                if (!shop) return showAlert('Shop not found.', true);

                currentUserShopId = shop.id;
                currentUserShopIds = [shop.id]; // Important for delivery logic
                currentShopName = shop.name;

                document.getElementById('transport-view-title').textContent = `${currentShopName} - Delivery`;
                updateAuthStatusUI();
                listenForNotifications();
                initFastNotification(currentUserShopId, userRole); // Initialize alarm system

                // Listen to orders for this shop (populate transport-orders-list)
                listenToStaffOrders();

                Object.values(views).forEach(v => v.classList.add('view-hidden'));
                views['transport'].classList.remove('view-hidden');
                views['transport'].classList.add('view-active');
                Array.from(viewSwitcher.querySelectorAll('button')).forEach(btn => btn.classList.toggle('btn-active', btn.dataset.view === 'transport'));
            }
            if (target.matches('#run-system-test') || target.matches('#run-system-test-summary')) {
                runSystemTests();
                showAlert('System tests completed.');
            }
            if (target.matches('#test-push-btn')) {
                if (Notification.permission === 'granted') {
                    showAlert('Simulating push in 5 seconds... Close the app to test background behavior (if supported).');
                    setTimeout(() => {
                        if ('serviceWorker' in navigator) {
                            navigator.serviceWorker.ready.then(registration => {
                                registration.showNotification('Test Notification', {
                                    body: 'This is a test notification from the System!',
                                    icon: './public/icon.svg',
                                    vibrate: [200, 100, 200]
                                });
                            });
                        }
                    }, 5000);
                } else {
                    showAlert('Please enable notifications first (in Notification Panel).', true);
                }
            }
            if (target.matches('#refresh-orders')) {
                orderCurrentPage = 1; orderFirstVisibleDoc = null; orderLastVisibleDoc = null;
                loadAllOrders('start');
            }
            if (target.matches('#next-orders-btn')) {
                orderCurrentPage++;
                loadAllOrders('next');
            }
            if (target.matches('#prev-orders-btn')) {
                if (orderCurrentPage > 1) {
                    orderCurrentPage--;
                    loadAllOrders('prev');
                }
            }
            if (target.matches('.order-filter-btn')) {
                orderDateFilter = target.dataset.filter;
                orderCurrentPage = 1;
                orderFirstVisibleDoc = null;
                orderLastVisibleDoc = null;
                updateOrderFilterButtons();
                loadAllOrders('start');
            }
        });

        document.body.addEventListener('submit', async e => {
            e.preventDefault();
            if (e.target.id === 'order-form') {
                // Fix: Check form validity before proceeding
                if (!e.target.checkValidity()) {
                    return showAlert("Please fill out all required fields.", true);
                }
                e.target.dataset.mode === 'update' ? await updateOrder() : await placeOrder();
            }
            if (e.target.id === 'add-staff-form') await addStaff();
            if (e.target.id === 'test-order-form') await createTestOrder(e);
            if (e.target.id === 'staff-create-order-form') await handleStaffOrderCreation(e);
            if (e.target.id === 'create-shop-form') await createShop(e);
            if (e.target.id === 'create-menu-item-form') await createMenuItem(e);
        });

        document.body.addEventListener('change', async e => {
            const uid = e.target.dataset.uid;
            if (!uid) return;

            // Dev Panel User Management
            if (e.target.classList.contains('role-selector')) {
                const newRole = e.target.value;
                const updateData = { role: newRole };

                // Clear shop assignments for non-staff roles
                if (newRole === 'customer' || newRole === 'developer') {
                    updateData.shopId = null;
                    updateData.shopIds = null;
                }

                // Clear shopIds if changing FROM delivery to non-delivery (kitchen/owner use single shopId)
                if (newRole !== 'delivery') {
                    updateData.shopIds = null;
                }

                await setDoc(doc(db, "users", uid), updateData, { merge: true });
                showAlert('User role updated.');

                const userIndex = allUsersCache.findIndex(doc => doc.id === uid);
                if (userIndex > -1) {
                    allUsersCache[userIndex] = await getDoc(doc(db, "users", uid));
                    renderAdminUserList();
                } else {
                    await loadAdminPanel();
                }
            }
            if (e.target.classList.contains('shop-selector')) {
                const newShopId = e.target.value;
                await setDoc(doc(db, "users", uid), { shopId: newShopId || null, shopIds: null }, { merge: true });

                const userIndex = allUsersCache.findIndex(doc => doc.id === uid);
                if (userIndex > -1) {
                    allUsersCache[userIndex] = await getDoc(doc(db, "users", uid));
                    renderAdminUserList();
                }
                showAlert('User shop updated.');
            }
            // Handle delivery staff multi-shop checkbox
            if (e.target.classList.contains('delivery-shop-checkbox')) {
                const shopId = e.target.dataset.shopId;
                const userDocRef = doc(db, "users", uid);
                const userSnap = await getDoc(userDocRef);
                if (userSnap.exists()) {
                    const userData = userSnap.data();
                    let shopIds = userData.shopIds || (userData.shopId ? [userData.shopId] : []);

                    if (e.target.checked) {
                        if (!shopIds.includes(shopId)) shopIds.push(shopId);
                    } else {
                        shopIds = shopIds.filter(id => id !== shopId);
                    }

                    // Update with shopIds array, set shopId to first shop or null
                    await setDoc(userDocRef, {
                        shopIds: shopIds.length > 0 ? shopIds : null,
                        shopId: shopIds.length > 0 ? shopIds[0] : null
                    }, { merge: true });

                    const userIndex = allUsersCache.findIndex(doc => doc.id === uid);
                    if (userIndex > -1) {
                        allUsersCache[userIndex] = await getDoc(userDocRef);
                    }
                    showAlert(`Delivery staff now assigned to ${shopIds.length} shop(s).`);
                }
            }
        });

        function updateOrderFilterButtons() {
            document.querySelectorAll('.order-filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.filter === orderDateFilter);
                btn.classList.toggle('btn-primary', btn.dataset.filter === orderDateFilter);
                btn.classList.toggle('btn-secondary', btn.dataset.filter !== orderDateFilter);
            });
        }

        // Register Service Worker for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./js/sw.js')
                    .then(registration => {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    })
                    .catch(err => {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            });
        }

        // --- Push Notification Logic ---
        const enablePushBtn = document.getElementById('enable-push-btn');

        function checkPushPermission() {
            if (!('Notification' in window)) return;
            if (Notification.permission === 'default') {
                enablePushBtn.classList.remove('hidden');
            } else {
                enablePushBtn.classList.add('hidden');
            }
        }

        // --- Permission Management Logic ---
        document.body.addEventListener('click', async e => {
            if (e.target.classList.contains('dev-manage-permissions-btn')) {
                const uid = e.target.dataset.uid;
                const email = e.target.dataset.email;
                openPermissionsModal(uid, email);
            }
        });

        const permissionsModal = document.getElementById('permissions-modal');
        const savePermissionsBtn = document.getElementById('save-permissions-btn');
        let currentEditingPermissionUid = null;

        document.getElementById('permissions-modal-close').onclick = () => permissionsModal.classList.add('hidden');

        async function openPermissionsModal(uid, email) {
            currentEditingPermissionUid = uid;
            document.getElementById('permissions-user-email').textContent = `Granting access to: ${email}`;

            const userSnap = await getDoc(doc(db, "users", uid));
            const userData = userSnap.data() || {};
            const currentPerms = userData.devPermissions || [];

            const availablePerms = [
                { id: 'summary', label: 'System Overview', desc: 'View global stats and dashboard' },
                { id: 'payments', label: 'Global Payment Toggles', desc: 'Enable/Disable COD or Online globally' },
                { id: 'shops', label: 'Shop Management', desc: 'Create, edit, or delete shops' },
                { id: 'menu', label: 'Global Menu Management', desc: 'Edit menu items for any shop' },
                { id: 'users', label: 'User Management', desc: 'Change roles and permissions' },
                { id: 'tools', label: 'System Tools', desc: 'Access tests and dev tools' }
            ];

            const listEl = document.getElementById('permissions-list');
            listEl.innerHTML = availablePerms.map(p => `
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-xl hover:bg-gray-100 transition-colors">
                    <div>
                        <p class="font-semibold text-gray-900">${p.label}</p>
                        <p class="text-xs text-gray-500">${p.desc}</p>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" class="sr-only peer dev-perm-checkbox" data-id="${p.id}" ${currentPerms.includes(p.id) ? 'checked' : ''}>
                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                    </label>
                </div>
            `).join('');

            permissionsModal.classList.remove('hidden');
        }

        savePermissionsBtn.onclick = async () => {
            if (!currentEditingPermissionUid) return;

            const selectedPerms = Array.from(document.querySelectorAll('.dev-perm-checkbox:checked')).map(cb => cb.dataset.id);

            try {
                await setDoc(doc(db, "users", currentEditingPermissionUid), {
                    devPermissions: selectedPerms
                }, { merge: true });

                showAlert('Permissions updated successfully.');
                permissionsModal.classList.add('hidden');

                // Refresh local cache if visible
                const userIndex = allUsersCache.findIndex(doc => doc.id === currentEditingPermissionUid);
                if (userIndex > -1) {
                    allUsersCache[userIndex] = await getDoc(doc(db, "users", currentEditingPermissionUid));
                }
            } catch (error) {
                console.error("Error saving permissions:", error);
                showAlert("Failed to save permissions.", true);
            }
        };
        checkPushPermission();

        // Auto-request permission on first load if not already decided
        if ('Notification' in window && Notification.permission === 'default') {
            // Small delay to allow page to load
            setTimeout(() => {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        console.log('Notification permission granted automatically.');
                        enablePushBtn.classList.add('hidden');
                        if ('serviceWorker' in navigator) {
                            navigator.serviceWorker.ready.then(registration => {
                                registration.showNotification('Notifications Enabled', {
                                    body: 'You will now receive updates!',
                                    icon: './public/foodyVrinda-logo.png'
                                });
                            });
                        }
                    }
                    checkPushPermission();
                });
            }, 1000);
        }

        enablePushBtn.addEventListener('click', () => {
            Notification.requestPermission().then(permission => {
                if (permission === 'granted') {
                    console.log('Notification permission granted.');
                    enablePushBtn.classList.add('hidden');
                    // Subscribe to push (mock subscription for now as we don't have a VAPID key/backend)
                    if ('serviceWorker' in navigator) {
                        navigator.serviceWorker.ready.then(registration => {
                            // In a real app, you would pass your VAPID public key here
                            // registration.pushManager.subscribe({
                            //     userVisibleOnly: true,
                            //     applicationServerKey: urlBase64ToUint8Array('YOUR_PUBLIC_VAPID_KEY')
                            // }).then(subscription => {
                            //     // Send subscription to server
                            // });

                            // For this demo, we just confirm it works
                            registration.showNotification('Notifications Enabled', {
                                body: 'You will now receive updates!',
                                icon: './public/foodyVrinda-logo.png'
                            });
                        });
                    }
                } else {
                    console.log('Notification permission denied.');
                }
            });
        });

        // --- MAP PICKER LOGIC ---
        let pickerMap, pickerMarker;
        let targetLatInput, targetLngInput;

        function initMapPicker() {
            if (typeof google === 'undefined') {
                showAlert('Google Maps SDK not loaded. Check your internet connection.', true);
                return;
            }
            const delhi = { lat: 28.6139, lng: 77.2090 };
            pickerMap = new google.maps.Map(document.getElementById("map-picker-container"), {
                zoom: 13,
                center: delhi,
                mapTypeControl: false,
                streetViewControl: false,
                fullscreenControl: false
            });

            pickerMarker = new google.maps.Marker({
                map: pickerMap,
                draggable: true,
                animation: google.maps.Animation.DROP,
            });

            pickerMap.addListener("click", (e) => {
                updatePickerMarker(e.latLng);
            });

            pickerMarker.addListener("dragend", (e) => {
                updatePickerCoordinates(e.latLng);
            });
        }

        function updatePickerMarker(latLng) {
            pickerMarker.setPosition(latLng);
            updatePickerCoordinates(latLng);
        }

        function updatePickerCoordinates(latLng) {
            document.getElementById('picked-lat').textContent = latLng.lat().toFixed(6);
            document.getElementById('picked-lng').textContent = latLng.lng().toFixed(6);
        }

        // Expose to global scope for inline onclick handlers
        window.openMapPicker = function openMapPicker(latId, lngId) {
            targetLatInput = document.getElementById(latId);
            targetLngInput = document.getElementById(lngId);

            const modal = document.getElementById('map-picker-modal');
            modal.classList.remove('hidden');

            // Initialize map if not already done
            if (!pickerMap) {
                setTimeout(() => {
                    initMapPicker();
                    if (!pickerMap) {
                        showAlert('Failed to initialize map. Please check your internet connection.', true);
                        modal.classList.add('hidden');
                        return;
                    }
                    positionMapOnOpen();
                }, 100);
            } else {
                // Trigger resize to ensure map displays correctly
                setTimeout(() => {
                    google.maps.event.trigger(pickerMap, 'resize');
                    positionMapOnOpen();
                }, 100);
            }
        }

        function positionMapOnOpen() {
            if (!pickerMap) return;

            const currentLat = parseFloat(targetLatInput.value);
            const currentLng = parseFloat(targetLngInput.value);

            if (!isNaN(currentLat) && !isNaN(currentLng)) {
                const pos = { lat: currentLat, lng: currentLng };
                pickerMap.setCenter(pos);
                updatePickerMarker(new google.maps.LatLng(currentLat, currentLng));
            } else if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition((pos) => {
                    const p = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                    pickerMap.setCenter(p);
                    updatePickerMarker(new google.maps.LatLng(p.lat, p.lng));
                }, () => {
                    // Fallback to default center if geolocation fails
                    const p = pickerMap.getCenter();
                    updatePickerMarker(p);
                });
            } else {
                const p = pickerMap.getCenter();
                updatePickerMarker(p);
            }
        }

        // ============ RETURN ORDER FUNCTIONS ============
        let returnDialogOrderId = null;

        // Show return dialog modal
        window.showReturnDialog = function showReturnDialog(orderId) {
            returnDialogOrderId = orderId;

            // Create modal if it doesn't exist
            if (!document.getElementById('return-order-modal')) {
                const modalHTML = `
                    <div id="return-order-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                        <div class="bg-white rounded-2xl p-6 max-w-md w-full shadow-2xl">
                            <h3 class="text-xl font-bold text-gray-900 mb-4">Return Order to Shop</h3>
                            <p class="text-sm text-gray-600 mb-4">Please provide a reason for returning this order.</p>
                            <div class="space-y-4">
                                <div>
                                    <label class="form-label">Return Reason</label>
                                    <select id="return-reason-select" class="w-full">
                                        <option value="Customer not available">Customer not available</option>
                                        <option value="Wrong address">Wrong address</option>
                                        <option value="Customer refused order">Customer refused order</option>
                                        <option value="Customer unreachable">Customer unreachable</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                                <div id="return-reason-other-container" class="hidden">
                                    <label class="form-label">Other Reason</label>
                                    <input type="text" id="return-reason-other" class="w-full" placeholder="Specify reason...">
                                </div>
                                <button onclick="openWhatsAppVideo()" class="btn-secondary w-full flex items-center justify-center gap-2">
                                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347z"/></svg>
                                    Video Call Shop for Help
                                </button>
                            </div>
                            <div class="flex gap-3 mt-6">
                                <button onclick="closeReturnDialog()" class="btn-secondary flex-1">Cancel</button>
                                <button onclick="confirmReturnOrder()" class="btn-danger flex-1">Confirm Return</button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', modalHTML);

                // Toggle other reason input
                document.getElementById('return-reason-select').addEventListener('change', (e) => {
                    const otherContainer = document.getElementById('return-reason-other-container');
                    if (e.target.value === 'Other') {
                        otherContainer.classList.remove('hidden');
                    } else {
                        otherContainer.classList.add('hidden');
                    }
                });
            } else {
                document.getElementById('return-order-modal').classList.remove('hidden');
            }
        }

        window.closeReturnDialog = function closeReturnDialog() {
            const modal = document.getElementById('return-order-modal');
            if (modal) modal.classList.add('hidden');
            returnDialogOrderId = null;
        }

        window.confirmReturnOrder = async function confirmReturnOrder() {
            if (!returnDialogOrderId) return;

            let reason = document.getElementById('return-reason-select').value;
            if (reason === 'Other') {
                reason = document.getElementById('return-reason-other').value || 'Other reason';
            }

            try {
                const orderRef = doc(db, "orders", returnDialogOrderId);
                await updateDoc(orderRef, {
                    status: 'returned',
                    returnReason: reason,
                    returnedAt: serverTimestamp()
                });
                showAlert('Order marked as returned.');
                closeReturnDialog();
            } catch (error) {
                console.error('Error returning order:', error);
                showAlert('Failed to return order: ' + error.message, true);
            }
        }

        window.openWhatsAppVideo = async function openWhatsAppVideo() {
            try {
                // Get the shop phone from the current order
                const orderRef = doc(db, "orders", returnDialogOrderId);
                const orderSnap = await getDoc(orderRef);
                if (!orderSnap.exists()) return showAlert('Order not found.', true);

                const shopId = orderSnap.data().shopId;
                const shop = allShops.find(s => s.id === shopId);
                if (!shop || !shop.phoneNumber) {
                    return showAlert('Shop phone number not available.', true);
                }

                let phone = shop.phoneNumber.replace(/[\s\-\(\)]/g, '');
                if (!phone.startsWith('+')) {
                    phone = '+91' + phone; // Default to India
                }

                window.open(`https://wa.me/${phone}`, '_blank');
            } catch (error) {
                console.error('Error opening WhatsApp:', error);
                showAlert('Failed to open WhatsApp.', true);
            }
        }

        // Navigate to customer location on Google Maps
        window.navigateToCustomer = function navigateToCustomer(address, lat, lng) {
            // If coordinates are available, use them for precise navigation
            if (lat !== null && lng !== null && !isNaN(lat) && !isNaN(lng)) {
                const mapsUrl = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`;
                window.open(mapsUrl, '_blank');
            }
            // Fallback to address-based navigation
            else if (address && address !== 'N/A') {
                const encodedAddress = encodeURIComponent(address);
                const mapsUrl = `https://www.google.com/maps/dir/?api=1&destination=${encodedAddress}`;
                window.open(mapsUrl, '_blank');
            } else {
                showAlert('No location information available for this order.', true);
            }
        }

        if (document.getElementById('open-map-btn')) {
            document.getElementById('open-map-btn').addEventListener('click', () => openMapPicker('shop-lat', 'shop-lng'));
        }
        if (document.getElementById('open-edit-map-picker-btn')) {
            document.getElementById('open-edit-map-picker-btn').addEventListener('click', () => openMapPicker('edit-shop-lat', 'edit-shop-lng'));
        }
        document.getElementById('map-picker-close').addEventListener('click', () => document.getElementById('map-picker-modal').classList.add('hidden'));
        document.getElementById('confirm-location-btn').addEventListener('click', () => {
            const lat = document.getElementById('picked-lat').textContent;
            const lng = document.getElementById('picked-lng').textContent;
            if (lat !== '--' && targetLatInput && targetLngInput) {
                targetLatInput.value = lat;
                targetLngInput.value = lng;
                document.getElementById('map-picker-modal').classList.add('hidden');
            }
        });

        // --- STAFF RECORD PRE-CREATION ---
        async function registerStaffRecord(e) {
            e.preventDefault();
            const name = document.getElementById('dev-staff-name').value.trim();
            const email = document.getElementById('dev-staff-email').value.trim().toLowerCase();
            const phone = document.getElementById('dev-staff-phone').value.trim();
            const role = document.getElementById('dev-staff-role').value;
            const shopId = document.getElementById('dev-staff-shop').value;

            if (!shopId) return showAlert("Please assign a shop to the staff member.", true);

            try {
                // Check if a record already exists
                // Optimization: We use getDocs for email check. Ensure users collection index is present for email.
                const qResult = await getDocs(query(collection(db, "users"), where("email", "==", email)));
                if (!qResult.empty) {
                    return showAlert("A user with this email already exists. Use the Role Management table instead.", true);
                }

                const newStaffData = {
                    displayName: name,
                    email: email,
                    phoneNumber: phone,
                    role: role,
                    shopId: shopId,
                    shopIds: [shopId],
                    isPreCreated: true, // Marker for setupUser to link
                    isOnline: false,
                    createdAt: serverTimestamp()
                };

                await addDoc(collection(db, "users"), newStaffData);

                showAlert(`Staff record created for ${name}.`);
                document.getElementById('dev-register-staff-form').reset();

                // Refresh user list if visible
                if (allUsersCache) {
                    await loadAdminPanel();
                }
            } catch (error) {
                console.error("Critical error creating staff record:", error);
                let errMsg = "Failed to create staff record.";
                if (error.code === 'permission-denied') errMsg = "Permission Denied: Ensure you have Developer access.";
                showAlert(errMsg, true);
            }
        }

        document.getElementById('dev-register-staff-form').addEventListener('submit', registerStaffRecord);

        // --- PWA Install Logic ---
        const installBtn = document.getElementById('install-app-btn');

        // Detect iOS
        const isIos = () => {
            const userAgent = window.navigator.userAgent.toLowerCase();
            return /iphone|ipad|ipod/.test(userAgent);
        }

        // Detect Android
        const isAndroid = () => {
            const userAgent = window.navigator.userAgent.toLowerCase();
            return /android/.test(userAgent);
        }

        // Detect if already installed (Standard + iOS)
        const isAppInstalled = () => {
            return window.matchMedia('(display-mode: standalone)').matches ||
                window.navigator.standalone ||
                document.referrer.includes('android-app://');
        };

        /**
         * Checks if the install button should be visible.
         * Logic: Show button ALWAYS if app is not installed.
         */
        const checkInstallEligibility = () => {
            if (isAppInstalled()) {
                console.log("App is already installed, hiding install button.");
                installBtn.classList.add('hidden');
            } else {
                // If NOT installed, show the button so user can at least see instructions
                installBtn.classList.remove('hidden');
                console.log("App not installed, showing install button.");
            }
        };

        // Check eligibility on initial load
        checkInstallEligibility();

        // Listen for the custom event in case the prompt fires after this script loads
        window.addEventListener('deferred-prompt-ready', () => {
            console.log("✅ Custom 'deferred-prompt-ready' event received.");
            checkInstallEligibility();
        });

        // Install Modal Logic
        const installModal = document.getElementById('install-modal');
        const installModalClose = document.getElementById('install-modal-close');
        const installModalOk = document.getElementById('install-modal-ok');
        const androidInstr = document.getElementById('install-instructions-android');
        const iosInstr = document.getElementById('install-instructions-ios');

        const closeInstallModal = () => installModal.classList.add('hidden');
        installModalClose.addEventListener('click', closeInstallModal);
        installModalOk.addEventListener('click', closeInstallModal);

        installBtn.addEventListener('click', async () => {
            if (window.deferredPrompt) {
                // 1. Native Prompt Available (Chrome/Edge/Samsung Internet)
                window.deferredPrompt.prompt();
                const { outcome } = await window.deferredPrompt.userChoice;
                console.log(`User response: ${outcome}`);
                window.deferredPrompt = null;
                if (outcome === 'accepted') {
                    installBtn.classList.add('hidden');
                }
            } else {
                // 2. Fallback: Show Dedicated Install Modal
                const isIosDevice = isIos();
                const isAndroidDevice = isAndroid();

                // Reset visibility
                androidInstr.classList.add('hidden');
                iosInstr.classList.add('hidden');

                if (isIosDevice) {
                    iosInstr.classList.remove('hidden');
                } else {
                    // Default to Android/Generic instructions
                    androidInstr.classList.remove('hidden');
                }

                installModal.classList.remove('hidden');
            }
        });

        window.addEventListener('appinstalled', () => {
            console.log('PWA was installed');
            installBtn.classList.add('hidden');
        });
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const userBtn = document.getElementById('user-auth-btn');

            if (userBtn && window.AuthService) {
                // Initialize UI
                AuthService.updateProfileUI('user-auth-btn');

                // Update UI on auth state change
                AuthService.onAuthStateChange(() => {
                    AuthService.updateProfileUI('user-auth-btn');
                });
            }
        });
    </script>
</body>

</html>